<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-font: 'Exo 2', 'Rajdhani', sans-serif;
            --secondary-font: 'Rajdhani', sans-serif;

            /* --- Dark Theme (Default from V2) --- */
            --bg-image-dark: linear-gradient(170deg, #101218 0%, #07080B 100%);
            --glass-bg-dark: rgba(20, 22, 30, 0.7); 
            --glass-border-dark: rgba(255, 255, 255, 0.08);
            --text-color-dark: #E8EEF5;
            --text-color-darker-dark: #9AA3AF;
            --accent-color-dark: #00e0b0; 
            --accent-color-hover-dark: #30ffc8;
            --accent-glow-dark: rgba(0, 224, 176, 0.45);
            --input-bg-dark: rgba(26, 29, 40, 0.75);
            --suggestion-bg-dark: rgba(26, 29, 40, 0.65);
            --suggestion-text-dark: #B0B8C0;
            --shadow-main-dark: rgba(0, 0, 0, 0.55); 
            --shadow-inset-dark: rgba(255,255,255,0.05);
            --bot-message-bg-dark: rgba(36, 40, 53, 0.8);
            --user-message-text-dark: #020e09; 

            /* --- Light Theme (from V2) --- */
            --bg-image-light: linear-gradient(135deg, #edf3fb 0%, #dce6f1 100%);
            --glass-bg-light: rgba(255, 255, 255, 0.5);
            --glass-border-light: rgba(190, 190, 200, 0.65);
            --text-color-light: #202a35;
            --text-color-darker-light: #555e69;
            --accent-color-light: #009977; 
            --accent-color-hover-light: #00b38a;
            --accent-glow-light: rgba(0, 153, 119, 0.35);
            --input-bg-light: rgba(255, 255, 255, 0.65);
            --suggestion-bg-light: rgba(255, 255, 255, 0.55);
            --suggestion-text-light: #3e474f;
            --shadow-main-light: rgba(0, 0, 0, 0.1);
            --shadow-inset-light: rgba(0,0,0,0.03);
            --bot-message-bg-light: #d7dde5;
            --user-message-text-light: #ffffff;
            
            /* --- Current Theme Variables --- */
            --current-bg-image: var(--bg-image-dark);
            --current-glass-bg: var(--glass-bg-dark);
            --current-glass-border: var(--glass-border-dark);
            --current-text-color: var(--text-color-dark);
            --current-text-color-darker: var(--text-color-darker-dark);
            --current-accent-color: var(--accent-color-dark);
            --current-accent-color-hover: var(--accent-color-hover-dark);
            --current-accent-glow: var(--accent-glow-dark);
            --current-input-bg: var(--input-bg-dark);
            --current-suggestion-bg: var(--suggestion-bg-dark);
            --current-suggestion-text: var(--suggestion-text-dark);
            --current-shadow-main: var(--shadow-main-dark);
            --current-shadow-inset: var(--shadow-inset-dark);
            --current-bot-message-bg: var(--bot-message-bg-dark);
            --current-user-message-text: var(--user-message-text-dark);

            --orb-grad-start: color-mix(in srgb, var(--current-accent-color) 60%, #fff);
            --orb-grad-mid: var(--current-accent-color);
            --orb-grad-end: color-mix(in srgb, var(--current-accent-color) 70%, #000);

            --padding-base: clamp(12px, 2.2vw, 24px);
            --font-size-base: clamp(0.93rem, 1.98vw, 1.1rem);
            --font-size-h1: clamp(1.2rem, 2.7vw, 1.45rem);
            --font-size-prompt: clamp(1rem, 2.2vw, 1.25rem);
            --button-font-size: clamp(0.9rem, 1.9vw, 1rem);

            --spring-bezier: cubic-bezier(0.34, 1.7, 0.64, 1);
            --ease-out-quad: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-in-out-circ: cubic-bezier(0.86, 0, 0.07, 1);


            --mic-listening-color: #ff6060; /* Color for mic active state */
            --search-highlight-bg: color-mix(in srgb, var(--current-accent-color) 40%, transparent);

            /* --- Aura Live Mode Variables --- */
            --live-accent-color: #00e0b0; /* Using dark theme accent */
            --live-accent-hover: #30ffc8;
            --live-bg-color: #0a0f18; /* Very dark bg for immersion */
            --live-text-color-main: #E8EEF5;
            --live-glow-color: rgba(0, 224, 176, 0.6);
            --live-border-color: rgba(0, 224, 176, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--primary-font);
            background-image: var(--current-bg-image);
            background-attachment: fixed;
            color: var(--current-text-color);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: var(--padding-base);
            font-size: var(--font-size-base); line-height: 1.7;
            font-weight: 500;
            transition: background-image 0.4s ease, color 0.4s ease;
            overflow-x: hidden; 
        }

        .ai-assistant-wrapper {
            position: relative; 
            width: 100%; 
            max-width: 700px; 
            border-radius: clamp(22px, 4vw, 36px);
            transition: opacity 0.4s ease, transform 0.4s var(--spring-bezier); 
        }
        .ai-assistant-wrapper.hidden-by-live-mode {
            opacity: 0;
            transform: scale(0.92) translateY(20px); 
            pointer-events: none;
        }


        .ai-assistant-wrapper::after { 
            content: '';
            position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: calc(clamp(22px, 4vw, 36px) + 5px); 
            z-index: -1; 
            box-shadow: 0 0 0px 0px transparent; 
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
        }
        .ai-assistant-wrapper.edge-glow-active::after { 
            opacity: 1;
            animation: pulse-edge-glow-outward 1.8s infinite alternate var(--ease-in-out-circ); 
        }
        @keyframes pulse-edge-glow-outward { 
            0% { box-shadow: 0 0 15px 5px color-mix(in srgb, var(--current-accent-color) 30%, transparent), 0 0 30px 10px color-mix(in srgb, var(--current-accent-color) 15%, transparent); transform: scale(1); }
            70% { box-shadow: 0 0 30px 10px var(--current-accent-color), 0 0 55px 18px color-mix(in srgb, var(--current-accent-color) 50%, transparent); transform: scale(1.015); }
            100% { box-shadow: 0 0 15px 5px color-mix(in srgb, var(--current-accent-color) 30%, transparent), 0 0 30px 10px color-mix(in srgb, var(--current-accent-color) 15%, transparent); transform: scale(1); }
        }

        .ai-assistant-container {
            width: 100%; height: 90vh; max-height: 850px;
            background: var(--current-glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1.5px solid var(--current-glass-border);
            border-radius: clamp(22px, 4vw, 36px);
            box-shadow: 0 20px 50px var(--current-shadow-main), inset 0 1.5px 2.5px var(--current-shadow-inset), 0 0 0 1.5px var(--current-glass-border);
            display: flex; flex-direction: column; overflow: hidden;
            transition: background 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease;
            position: relative;
        }

        .assistant-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: var(--padding-base) calc(var(--padding-base) * 1.4);
            border-bottom: 1.5px solid var(--current-glass-border);
            background: color-mix(in srgb, var(--current-glass-bg) 80%, transparent);
            flex-shrink: 0; position: relative; z-index: 1; 
        }
        .header-title-area { display: flex; align-items: center; flex-grow: 1; }
        .header-search-area { display: flex; align-items: center; margin-left: calc(var(--padding-base) * 0.5); margin-right: calc(var(--padding-base) * 0.5); flex-shrink: 1; max-width: 200px;}
        #chatSearchInput {
            background-color: var(--current-input-bg); color: var(--current-text-color);
            border: 1px solid var(--current-glass-border); border-radius: 15px 0 0 15px;
            padding: 5px 10px; font-size: 0.85em; width: 100%;
            transition: border-color 0.2s;
        }
        #chatSearchInput:focus { border-color: var(--current-accent-color); outline: none; }
        #clearChatSearchBtn {
            background-color: var(--current-input-bg); color: var(--current-text-color-darker);
            border: 1px solid var(--current-glass-border); border-left: none;
            border-radius: 0 15px 15px 0; padding: 5px 8px; cursor: pointer;
            font-size: 0.85em; transition: color 0.2s;
        }
        #clearChatSearchBtn:hover { color: var(--current-accent-color); }

        .header-actions { display: flex; align-items: center; gap: calc(var(--padding-base) * 0.3); } 
        .sparkle-icon {
            width: clamp(24px, 4.5vw, 28px); height: clamp(24px, 4.5vw, 28px);
            margin-right: calc(var(--padding-base) * 0.7);
            color: var(--current-accent-color); filter: drop-shadow(0 0 5px var(--current-accent-glow));
            transition: color 0.4s ease, filter 0.4s ease, transform 0.3s var(--spring-bezier);
        }
        .sparkle-icon:hover {
            transform: scale(1.1) rotate(-5deg);
        }
        .assistant-header h1 {
            font-size: var(--font-size-h1); font-weight: 700;
            color: var(--current-text-color); text-shadow: 0 0 8px var(--current-accent-glow); 
            transition: color 0.4s ease, text-shadow 0.4s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .header-icon-btn {
            background: none; border: none;
            color: var(--current-text-color-darker); cursor: pointer; padding: 7px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s var(--spring-bezier);
        }
        .header-icon-btn svg { width: clamp(19px, 3.8vw, 22px); height: clamp(19px, 3.8vw, 22px); transition: fill 0.4s ease; }
        .header-icon-btn:hover { color: var(--current-accent-color); background-color: color-mix(in srgb, var(--current-accent-color) 12%, transparent); transform: scale(1.15); }

        .chat-window { 
            flex-grow: 1; 
            padding: var(--padding-base); 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; /* For momentum scrolling on older iOS */
            display: flex; 
            flex-direction: column; 
            gap: calc(var(--padding-base) * 1.6); 
            position: relative; /* Necessary for absolute positioning of scroll-buttons */
            z-index: 1; 
        }
        .chat-window::-webkit-scrollbar { width: 9px; }
        .chat-window::-webkit-scrollbar-track { background: rgba(0,0,0,0.15); border-radius: 9px; }
        .chat-window::-webkit-scrollbar-thumb { background: var(--current-glass-border); border-radius: 9px; transition: background-color 0.4s ease; }
        .chat-window::-webkit-scrollbar-thumb:hover { background: var(--current-accent-color); }

        .initial-prompt-area {
            text-align: center; padding: var(--padding-base) 0; margin-bottom: var(--padding-base);
            flex-shrink: 0; opacity: 1; transform: translateY(0) scale(1);
            transition: opacity 0.5s var(--spring-bezier), transform 0.5s var(--spring-bezier), height 0.5s var(--spring-bezier), margin 0.5s var(--spring-bezier), padding 0.5s var(--spring-bezier);
            perspective: 800px;
        }
        .initial-prompt-area.hidden { opacity: 0; transform: translateY(-20px) scale(0.95); pointer-events: none; height: 0 !important; margin-bottom: 0 !important; padding: 0 !important; }
        .orb-container { display: flex; justify-content: center; margin-bottom: calc(var(--padding-base) * 1.6); transition: transform 0.3s var(--ease-out-quad); }
        .orb-container:hover { transform: translateY(-5px); }
        .orb-container:hover .orb { transform: translateZ(20px) rotateY(10deg) rotateX(5deg) scale(1.03); }
        .orb { width: clamp(85px, 18vw, 110px); height: clamp(85px, 18vw, 110px); border-radius: 50%; background: radial-gradient(circle at 35% 35%, var(--orb-grad-start), var(--orb-grad-mid) 65%, var(--orb-grad-end) 95%); box-shadow: 0 0 clamp(18px, 4.5vw, 35px) var(--current-accent-glow), 0 0 clamp(26px, 5.5vw, 45px) color-mix(in srgb, var(--current-accent-glow) 60%, transparent), inset 0 0 16px rgba(255,255,255,0.22); animation: pulse-deeper 3.8s infinite ease-in-out, subtle-rotate 35s infinite linear; position: relative; transition: background 0.4s ease, box-shadow 0.4s ease, transform 0.4s var(--spring-bezier); } 
        .orb::before { content: ''; position: absolute; top: 12%; left: 14%; width: 55%; height: 38%; background: radial-gradient(ellipse at center, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 65%); border-radius: 50%; transform: rotate(20deg); }
        @keyframes pulse-deeper { 0%, 100% { transform: scale(1); filter: brightness(100%); } 50% { transform: scale(1.06); filter: brightness(112%); } }
        @keyframes subtle-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .orb.orb-thinking { animation: pulse-deeper 3.8s infinite ease-in-out, subtle-rotate 35s infinite linear, pulse-thinking-glow 1.5s infinite alternate var(--ease-in-out-circ); } 
        @keyframes pulse-thinking-glow { from { box-shadow: 0 0 clamp(18px, 4.5vw, 35px) var(--current-accent-glow), 0 0 clamp(26px, 5.5vw, 45px) color-mix(in srgb, var(--current-accent-glow) 60%, transparent), inset 0 0 16px rgba(255,255,255,0.22), 0 0 10px 3px color-mix(in srgb, var(--current-accent-color) 70%, transparent); } to { box-shadow: 0 0 clamp(22px, 5vw, 40px) var(--current-accent-glow), 0 0 clamp(30px, 6vw, 50px) color-mix(in srgb, var(--current-accent-glow) 70%, transparent), inset 0 0 18px rgba(255,255,255,0.25), 0 0 20px 7px color-mix(in srgb, var(--current-accent-color) 85%, transparent); } }
        .orb.orb-listening { animation: pulse-deeper 3.8s infinite ease-in-out, subtle-rotate 35s infinite linear, pulse-listening-ring 1.2s infinite ease-out; background: radial-gradient(circle at 35% 35%, color-mix(in srgb, var(--current-accent-color) 30%, var(--mic-listening-color)), color-mix(in srgb, var(--current-accent-color) 70%, color-mix(in srgb, var(--mic-listening-color) 70%, #111)) 65%, color-mix(in srgb, var(--current-accent-color) 40%, color-mix(in srgb, var(--mic-listening-color) 50%, #000)) 95%); }
        @keyframes pulse-listening-ring { 0% { box-shadow: 0 0 clamp(18px, 4.5vw, 35px) var(--current-accent-glow), 0 0 clamp(26px, 5.5vw, 45px) color-mix(in srgb, var(--current-accent-glow) 60%, transparent), inset 0 0 16px rgba(255,255,255,0.22), 0 0 0 0px color-mix(in srgb, var(--mic-listening-color) 70%, transparent); } 100% { box-shadow: 0 0 clamp(18px, 4.5vw, 35px) var(--current-accent-glow), 0 0 clamp(26px, 5.5vw, 45px) color-mix(in srgb, var(--current-accent-glow) 60%, transparent), inset 0 0 16px rgba(255,255,255,0.22), 0 0 0 20px color-mix(in srgb, var(--mic-listening-color) 0%, transparent); } }
        .prompt-text { font-size: var(--font-size-prompt); color: var(--current-text-color-darker); margin-bottom: calc(var(--padding-base) * 1.6); font-weight: 600; text-shadow: 0 0 10px color-mix(in srgb, var(--current-accent-color) 40%, transparent); transition: color 0.4s ease, text-shadow 0.4s ease; }
        .suggestions { display: flex; flex-wrap: wrap; justify-content: center; gap: calc(var(--padding-base) * 0.7); padding: 0 var(--padding-base); }
        .suggestion-chip { background-color: var(--current-suggestion-bg); color: var(--current-suggestion-text); border: 1.5px solid var(--current-glass-border); border-radius: 20px; padding: calc(var(--padding-base) * 0.65) calc(var(--padding-base) * 1.3); font-size: var(--button-font-size); font-family: var(--secondary-font); font-weight: 600; cursor: pointer; transition: all 0.28s var(--spring-bezier); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .suggestion-chip:hover { background-color: color-mix(in srgb, var(--current-accent-color) 20%, transparent); border-color: var(--current-accent-color); color: var(--current-accent-color); transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
        
        .message { padding: calc(var(--padding-base) * 0.85) calc(var(--padding-base) * 1); border-radius: 18px; max-width: 88%; line-height: 1.6; font-size: var(--font-size-base); word-wrap: break-word; position: relative; transition: transform 0.35s var(--spring-bezier), opacity 0.35s ease-out, background-color 0.4s ease; box-shadow: 0 5px 13px rgba(0,0,0,0.25); margin-bottom:10px; }
        .message.search-result-highlight { background-color: var(--search-highlight-bg) !important; border: 1px solid var(--current-accent-color); }
        .message.entering { opacity: 0; transform: translateY(18px) scale(0.95); }
        .user-message { background: linear-gradient(135deg, var(--current-accent-color), color-mix(in srgb, var(--current-accent-color) 75%, #000)); color: var(--current-user-message-text); font-weight: 600; align-self: flex-end; border-bottom-right-radius: 6px; }
        .bot-message { background-color: var(--current-bot-message-bg); color: var(--current-text-color); align-self: flex-start; border-bottom-left-radius: 6px; }
        .message-content { white-space: pre-wrap; }
        .message-content ul, .message-content ol { margin-left: 20px; margin-top: 0.4em; margin-bottom: 0.4em; }
        .message-content li { margin-bottom: 0.2em; }
        .message-content code { background-color: color-mix(in srgb, var(--current-glass-bg) 45%, #000 55%); padding: 0.1em 0.35em; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; border: 1px solid var(--current-glass-border); }
        .message-content pre { background-color: color-mix(in srgb, var(--current-glass-bg) 45%, #000 55%); padding: 0.7em; border-radius: 5px; overflow-x: auto; border: 1px solid var(--current-glass-border); margin: 0.4em 0; max-height: 280px; overflow-y: auto; }
        .message-content pre code { padding: 0; border: none; background: none; }
        .message-content .note-tags { font-size: 0.8em; color: var(--current-text-color-darker); margin-top: 5px; }
        .message-content .note-tags .tag { display: inline-block; background-color: color-mix(in srgb, var(--current-suggestion-bg) 80%, transparent); padding: 2px 6px; border-radius: 10px; margin-right: 5px; border: 1px solid var(--current-glass-border); }
        .message-content .file-attachment-preview img { max-width: 100%; max-height: 200px; border-radius: 6px; margin-top: 8px; border: 1px solid var(--current-glass-border); }
        .message-content .file-attachment-info { font-size: 0.85em; color: var(--current-text-color-darker); margin-bottom: 5px; }
        .message-content .file-content-preview { white-space: pre-wrap; background-color: color-mix(in srgb, var(--current-input-bg) 80%, #000); padding: 8px; border-radius: 5px; max-height: 150px; overflow-y: auto; border: 1px solid var(--current-glass-border); font-family: 'Courier New', Courier, monospace; font-size: 0.85em; margin-top: 8px; }

        .message-meta { display: block; font-size: clamp(0.72rem, 1.5vw, 0.78rem); opacity: 0.7; margin-top: 6px; }
        .bot-message .message-meta { color: color-mix(in srgb, var(--current-text-color-darker) 70%, transparent); }
        .user-message .message-meta { 
            text-align: right; 
            color: var(--current-user-message-text); /* Ensures timestamp matches user message text */
            opacity: 0.85; /* Slightly more opaque for better readability on gradient */
        }

        .message-actions { position: absolute; top: 7px; right: 7px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s ease; z-index: 5; }
        .message:hover .message-actions { opacity: 1; }
        .message-actions button { background: rgba(0,0,0,0.3); border: none; border-radius: 50%; width: 26px; height: 26px; color: var(--current-text-color-darker); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease, transform 0.15s var(--spring-bezier), color 0.2s ease; padding: 0; } 
        .message-actions button:hover { background: var(--current-accent-color); color: var(--current-user-message-text, #000); transform: scale(1.1); }
        .message-actions button svg { width: 13px; height: 13px; }
        .message-actions .copy-feedback { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-2px); background-color: var(--current-accent-color); color: var(--current-user-message-text, #000); padding: 1px 5px; border-radius: 3px; font-size: 0.65em; white-space: nowrap; opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; pointer-events: none; }
        .message-actions button.copied .copy-feedback { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        
        .typing-indicator { display: flex; align-items: center; padding: calc(var(--padding-base) * 0.85) calc(var(--padding-base) * 1); border-radius: 18px; background-color: var(--current-bot-message-bg); align-self: flex-start; max-width: fit-content; transition: background-color 0.4s ease; }
        .typing-indicator.hidden { display: none; }
        .typing-indicator span { height: 9px; width: 9px; margin: 0 3.5px; background-color: var(--current-text-color-darker); border-radius: 50%; opacity: 0.4; animation: typing-dots 1.4s infinite ease-in-out both; transition: background-color 0.4s ease; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-dots { 0%, 80%, 100% { opacity: 0.4; transform: scale(0.7); } 40% { opacity: 1; transform: scale(1); } }

        .assistant-footer { padding: var(--padding-base); border-top: 1.5px solid var(--current-glass-border); background: color-mix(in srgb, var(--current-glass-bg) 80%, transparent); display: flex; align-items: flex-end; gap: calc(var(--padding-base) * 0.7); flex-shrink: 0; transition: background 0.4s ease, border-color 0.4s ease; position: relative; z-index: 1; }
        .footer-action-button { display: flex; align-items: center; justify-content: center; padding: calc(var(--padding-base) * 0.6); border-radius: 50%; background-color: var(--current-input-bg); border: 1.5px solid var(--current-glass-border); color: var(--current-text-color-darker); cursor: pointer; transition: all 0.25s var(--spring-bezier); align-self: center; }
        .footer-action-button:hover { background-color: color-mix(in srgb, var(--current-accent-color) 15%, transparent); border-color: var(--current-accent-color); color: var(--current-accent-color); transform: scale(1.08); box-shadow: 0 0 10px color-mix(in srgb, var(--current-accent-glow) 50%, transparent); }
        .footer-action-button svg { width: clamp(18px, 3.3vw, 21px); height: clamp(18px, 3.3vw, 21px); stroke: currentColor; stroke-width: 2; fill: none; transition: stroke 0.2s ease, fill 0.2s ease; }
        .footer-action-button#micBtn svg { fill: currentColor; stroke: none; }
        .footer-action-button#micBtn.listening { color: var(--mic-listening-color); animation: pulse-mic-btn 1.4s infinite ease-in-out; border-color: var(--mic-listening-color); }
        @keyframes pulse-mic-btn { 0%, 100% { transform: scale(1.05); } 50% { transform: scale(1.15); } }
        .input-area-wrapper { flex-grow: 1; display: flex; align-items: flex-end; background-color: var(--current-input-bg); border: 1.5px solid var(--current-glass-border); border-radius: 28px; padding: calc(var(--padding-base) * 0.25) var(--padding-base); transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.4s ease; }
        .input-area-wrapper:focus-within { border-color: var(--current-accent-color); animation: input-focus-glow 1.5s infinite alternate ease-in-out; }
        @keyframes input-focus-glow { from { box-shadow: 0 0 0 2.5px color-mix(in srgb, var(--current-accent-color) 25%, transparent), 0 0 5px 0px color-mix(in srgb, var(--current-accent-color) 15%, transparent); } to { box-shadow: 0 0 0 3px color-mix(in srgb, var(--current-accent-color) 40%, transparent), 0 0 12px 2px color-mix(in srgb, var(--current-accent-color) 25%, transparent); } }
        #userInputEditable { flex-grow: 1; min-height: calc(var(--font-size-base) * 1.6); max-height: calc(var(--font-size-base) * 1.6 * 4.5); overflow-y: auto; padding: calc(var(--padding-base) * 0.3) 0; border: none; outline: none; background-color: transparent; font-size: var(--font-size-base); color: var(--current-text-color); font-family: var(--primary-font); font-weight: 500; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; transition: color 0.4s ease; caret-color: var(--current-accent-color); }
        #userInputEditable:empty:before { content: attr(data-placeholder); color: var(--current-text-color-darker); opacity: 0.65; font-weight: 500; pointer-events: none; transition: color 0.4s ease; }
        .send-button { background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--current-accent-color); padding: calc(var(--padding-base) * 0.55); transition: color 0.2s ease, transform 0.2s var(--spring-bezier); align-self: center; }
        .send-button:hover { color: var(--current-accent-color-hover); transform: scale(1.18) rotate(-7deg); }
        .send-button.edit-mode { transform: rotate(0deg) scale(1.08); } .send-button.edit-mode:hover { transform: scale(1.18) rotate(0deg); }
        .send-button svg { width: clamp(22px, 4.3vw, 25px); height: clamp(22px, 4.3vw, 25px); stroke-width: 2; fill: currentColor;}

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.65); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { background: var(--current-glass-bg); border: 1.5px solid var(--current-glass-border); padding: calc(var(--padding-base) * 1.4); border-radius: 18px; box-shadow: 0 8px 28px rgba(0,0,0,0.35); width: 90%; max-width: 480px; transform: scale(0.92) translateY(10px); transition: transform 0.35s var(--spring-bezier), opacity 0.3s ease; position: relative; z-index: 1001; max-height: 85vh; overflow-y: auto; }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0px); opacity: 1;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--padding-base); }
        .modal-header h2 { font-size: var(--font-size-h1); font-weight: 700; color: var(--current-text-color); }
        .modal-close-btn { background:none; border:none; font-size: 22px; line-height:1; color: var(--current-text-color-darker); cursor:pointer; padding: 5px; transition: transform 0.2s var(--spring-bezier), color 0.2s ease; } 
        .modal-close-btn:hover { color: var(--current-accent-color); transform: scale(1.2); }
        .modal-body label { display: block; margin: 10px 0 5px; font-weight: 600; color: var(--current-text-color-darker); }
        .modal-body input[type="text"], .modal-body input[type="date"], .modal-body input[type="number"], .modal-body input[type="checkbox"], .modal-body select, .modal-body textarea { margin-right: 8px; }
        .modal-body input[type="checkbox"] { accent-color: var(--current-accent-color); }
        .modal-body input[type="text"], .modal-body input[type="date"], .modal-body input[type="number"], .modal-body select, .modal-body textarea { width: 100%; padding: 10px; border-radius: 6px; background-color: var(--current-input-bg); color: var(--current-text-color); border: 1px solid var(--current-glass-border); font-family: var(--primary-font); font-size: 0.95em; }
         .modal-body textarea { min-height: 80px; resize: vertical; }
        .modal-body input[type="text"]:focus, .modal-body input[type="date"]:focus, .modal-body input[type="number"]:focus, .modal-body select:focus, .modal-body textarea:focus { border-color: var(--current-accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--current-accent-color) 25%, transparent); outline: none; }
        .modal-button { background-color: var(--current-accent-color); color: var(--current-user-message-text, #000); border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: var(--padding-base); transition: background-color 0.2s ease, transform 0.15s var(--spring-bezier); display: block; width: 100%; } 
        .modal-button:hover { background-color: var(--current-accent-color-hover); transform: translateY(-1px) scale(1.02); }
        
        /* Topics list specifically */
        #topicsModal .modal-content { /* Base for smaller screens */
             max-width: 560px;
        }
        .topics-list button, .modal-body .action-button { display: block; width: 100%; text-align: left; padding: 10px; margin-bottom: 8px; border-radius: 7px; background-color: var(--current-input-bg); color: var(--current-text-color); border: 1px solid var(--current-glass-border); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.15s var(--spring-bezier); font-family: var(--secondary-font); font-weight: 600; } 
        .topics-list button:hover, .modal-body .action-button:hover { background-color: var(--current-suggestion-bg); border-color: var(--current-accent-color); color: var(--current-accent-color); transform:translateX(2px) scale(1.01); }
        .topics-list h4 { color: var(--current-text-color-darker); margin-bottom: 8px; font-weight: 600; font-size: 0.95em; margin-top: 12px;}
        .topics-list hr { border-color: var(--current-glass-border); margin: 12px 0; }


        /* Task Manager Modal Styles */
        #taskListContainerInModal .task-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid var(--current-glass-border); }
        #taskListContainerInModal .task-item:last-child { border-bottom: none; }
        #taskListContainerInModal .task-item input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; }
        #taskListContainerInModal .task-item .task-details { flex-grow: 1; }
        #taskListContainerInModal .task-item .task-description { font-weight: 600; }
        #taskListContainerInModal .task-item .task-meta-info { font-size: 0.8em; color: var(--current-text-color-darker); }
        #taskListContainerInModal .task-item .task-priority-high { color: #ff6060; font-weight: bold; }
        #taskListContainerInModal .task-item .task-priority-medium { color: #ffcc00; }
        #taskListContainerInModal .task-item .task-priority-low { color: var(--current-text-color-darker); }
        #taskListContainerInModal .task-item .task-actions button { background: none; border: none; color: var(--current-text-color-darker); cursor: pointer; padding: 5px; font-size: 1.1em; }
        #taskListContainerInModal .task-item .task-actions button:hover { color: var(--current-accent-color); }
        #addTaskFormInModal { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--current-glass-border); }

        /* Planner Modal Styles */
        #plannerEntriesContainer .planner-entry { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--current-glass-border); }
        #plannerEntriesContainer .planner-entry:last-child { border-bottom: none; }
        #plannerEntriesContainer .planner-entry-info { flex-grow: 1; }
        #plannerEntriesContainer .planner-entry-name { font-weight: 600; }
        #plannerEntriesContainer .planner-entry-datetime { font-size: 0.85em; color: var(--current-text-color-darker); }
        #plannerEntriesContainer .planner-entry-notes { font-size: 0.8em; color: var(--current-text-color-darker); font-style: italic; }
        #plannerEntriesContainer .planner-entry-actions button { background: none; border: none; color: var(--current-text-color-darker); cursor: pointer; padding: 5px; }
        #plannerEntriesContainer .planner-entry-actions button:hover { color: var(--current-accent-color); }
        #addPlannerEntryForm { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--current-glass-border); }


        /* Pomodoro, Mood, Code Snippet Styles remain similar */
        #pomodoroDisplay { font-size: 2.8em; font-weight: 700; text-align: center; margin: 15px 0; color: var(--current-accent-color); }
        .pomodoro-controls button, .pomodoro-settings-toggle { display: inline-block; margin: 5px; padding: 8px 15px; }
        .pomodoro-controls { text-align: center; margin-bottom: 15px;}
        #pomodoroSettingsArea { border-top: 1px solid var(--current-glass-border); margin-top:15px; padding-top:15px; }
        #pomodoroSettingsArea label { font-size: 0.9em; }
        #pomodoroSettingsArea input[type="number"] { width: 70px; margin-left: 5px; display: inline-block; }
        .mood-options { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .mood-options label { padding: 8px 12px; border: 1px solid var(--current-glass-border); border-radius: 20px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
        .mood-options input[type="radio"] { display: none; }
        .mood-options input[type="radio"]:checked + label { background-color: var(--current-accent-color); color: var(--current-user-message-text, #000); border-color: var(--current-accent-color); }
        .mood-options label:hover { border-color: var(--current-accent-color); }
        #codeSnippetsList { max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
        .snippet-item { padding: 10px; border: 1px solid var(--current-glass-border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s; }
        .snippet-item:hover { background-color: var(--current-suggestion-bg); }
        .snippet-item h4 { margin: 0 0 5px 0; color: var(--current-accent-color); }
        .snippet-item p { font-size: 0.85em; color: var(--current-text-color-darker); margin:0; }
        #codeSnippetFormArea.hidden, #viewSnippetArea.hidden { display: none; }
        #viewSnippetCode { white-space: pre-wrap; background-color: color-mix(in srgb, var(--current-input-bg) 80%, #000); padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto; border: 1px solid var(--current-glass-border); font-family: 'Courier New', Courier, monospace;}

        .hidden { display: none !important; }
        .scroll-buttons { 
            position: absolute; /* Relative to .chat-window */
            bottom: calc(var(--padding-base) * 0.4); 
            right: calc(var(--padding-base) * 0.4); 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            z-index: 10; /* Above chat messages if they somehow overlap */
        }
        .scroll-buttons button { background: color-mix(in srgb, var(--current-input-bg) 65%, transparent); border: 1.5px solid var(--current-glass-border); color: var(--current-text-color-darker); width: 34px; height: 34px; border-radius: 50%; cursor: pointer; font-size: 15px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.25s var(--spring-bezier); opacity: 0; visibility: hidden; transform: scale(0.85); }
        .scroll-buttons button.visible { opacity: 0.6; visibility: visible; transform: scale(1); }
        .scroll-buttons button:hover { background: var(--current-accent-color); color: var(--current-user-message-text, #000); opacity: 1; transform: scale(1.12); }

        /* --- START: Aura Live Mode Styles --- */
        .aura-live-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--live-bg-color);
            color: var(--live-text-color-main);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000; 
            opacity: 0;
            visibility: hidden;
            transform: scale(1.1);
            transition: opacity 0.4s ease-out, transform 0.4s var(--spring-bezier), visibility 0s 0.4s; 
            font-family: 'Exo 2', 'Rajdhani', sans-serif;
        }
        .aura-live-mode-overlay.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
            transition-delay: 0s;
        }

        .live-mode-title-integrated {
            font-size: clamp(1.8em, 4vw, 2.8em);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--live-accent-color);
            text-shadow: 0 0 10px var(--live-glow-color), 0 0 20px var(--live-glow-color), 0 0 5px #fff;
            animation: title-flicker-integrated 5s infinite alternate;
            z-index: 10;
        }
        @keyframes title-flicker-integrated {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .aura-live-mode-container {
            position: relative;
            width: clamp(300px, 90vw, 1400px); 
            height: clamp(400px, 80vh, 850px); 
            border: 2px solid var(--live-border-color);
            box-shadow: 0 0 40px var(--live-glow-color), inset 0 0 25px rgba(0, 224, 176, 0.2);
            background: rgba(10, 15, 24, 0.85); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 20px;
            z-index: 5;
        }
        .aura-live-mode-container::before, .aura-live-mode-container::after,
        .corner-element-tl-integrated, .corner-element-br-integrated { 
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border: 3px solid var(--live-accent-color);
            animation: rotate-corners-integrated 12s linear infinite;
            filter: drop-shadow(0 0 4px var(--live-accent-color));
        }
        .aura-live-mode-container::before { top: -15px; left: -15px; border-right: none; border-bottom: none; border-top-left-radius: 10px;}
        .aura-live-mode-container::after { bottom: -15px; right: -15px; border-left: none; border-top: none; border-bottom-right-radius: 10px;}
        .corner-element-tl-integrated { top: -15px; right: -15px; border-left: none; border-bottom: none; border-top-right-radius: 10px; animation-delay: -6s; }
        .corner-element-br-integrated { bottom: -15px; left: -15px; border-right: none; border-top: none; border-bottom-left-radius: 10px; animation-delay: -3s; }

        @keyframes rotate-corners-integrated {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #liveAudioCanvas {
            width: 95%;
            height: 55%; 
            margin-bottom: 20px;
            z-index: 1;
        }

        .live-status-text {
            position: absolute;
            top: 20px;
            left: 25px;
            font-size: clamp(0.9em, 1.5vw, 1.2em);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            text-shadow: 0 0 5px var(--live-accent-color);
            letter-spacing: 1px;
            z-index: 10;
        }
        .live-recognized-speech-container {
            width: 90%;
            min-height: 80px; 
            max-height: 120px; 
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            border: 1px solid var(--live-border-color);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center; 
            text-align: left; 
            overflow-y: auto;
            z-index: 1;
        }
        #liveRecognizedSpeech {
            font-size: clamp(1.1em, 1.8vw, 1.6em); 
            color: var(--live-text-color-main);
            font-weight: 500;
            line-height: 1.4;
            width: 100%; 
        }
        #liveRecognizedSpeech .live-user-speech { opacity: 0.75; color: #a0c5e8; }
        #liveRecognizedSpeech .live-bot-speech { color: var(--live-accent-color); font-weight: 600; }


        .close-live-mode-btn-integrated { 
            position: absolute;
            top: 20px;
            right: 25px;
            background: var(--live-accent-color);
            color: var(--live-bg-color); 
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: clamp(0.9em, 1.5vw, 1.1em);
            text-transform: uppercase;
            transition: background-color 0.2s ease, transform 0.2s var(--spring-bezier); 
            box-shadow: 0 0 10px var(--live-glow-color);
            z-index: 10;
        }
        .close-live-mode-btn-integrated:hover {
            background-color: var(--live-accent-hover);
            transform: scale(1.05);
        }

        .scan-line-integrated { 
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--live-accent-color) 50%, transparent);
            box-shadow: 0 0 10px var(--live-accent-color), 0 0 5px var(--live-accent-color);
            animation: scan-integrated 3.5s linear infinite;
            opacity: 0.8;
            z-index: 0; 
        }
        @keyframes scan-integrated {
            0% { top: 5%; opacity: 0.3; }
            50% { top: 95%; opacity: 0.8; }
            100% { top: 5%; opacity: 0.3; }
        }

        .grid-overlay-integrated { 
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image:
                linear-gradient(to right, rgba(0, 224, 176, 0.08) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 224, 176, 0.08) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            opacity: 0.6;
            animation: grid-pulse-integrated 10s infinite alternate ease-in-out;
            z-index: 0;
        }
        @keyframes grid-pulse-integrated {
            0% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }

        .central-orb-integrated { 
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: clamp(80px, 12vw, 150px);
            height: clamp(80px, 12vw, 150px);
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(0, 224, 176, 0.5) 0%, 
                rgba(0, 224, 176, 0.15) 50%, 
                transparent 70%);
            box-shadow: 0 0 20px var(--live-glow-color), inset 0 0 15px rgba(0,224,176,0.3);
            animation: pulse-orb-integrated 2.5s infinite var(--ease-in-out-circ); 
            z-index: 0; 
        }
        @keyframes pulse-orb-integrated {
            0%, 100% { transform: translate(-50%, -50%) scale(0.95); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
        }
        /* --- END: Aura Live Mode Styles --- */

        @media (min-width: 769px) { /* Desktop breakpoint for Topics Modal */
            #topicsModal .modal-content {
                max-width: 750px; /* Wider modal for desktop grid */
            }
            .topics-list { 
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
                gap: calc(var(--padding-base) * 0.8);
            }
            .topics-list > h4,
            .topics-list > hr,
            .topics-list > #simulatedDevicesContainer {
                grid-column: 1 / -1; /* Make these span full width */
            }
            /* System status/diagnostics buttons in topics list also span full width on desktop grid */
            .topics-list > button.action-button[data-topic^="system status"],
            .topics-list > button.action-button[data-topic^="system diagnostics"] {
                 grid-column: 1 / -1;
            }
        }

        @media (max-width: 700px) { 
            .header-search-area { max-width: 150px; }
            .assistant-header h1 { max-width: 120px; }
        }
        @media (max-width: 600px) { 
            .ai-assistant-container { height: 95vh; max-height: none; border-radius: clamp(18px, 3.5vw, 28px); }
            .assistant-footer { gap: calc(var(--padding-base) * 0.5); }
            .input-area-wrapper { padding: calc(var(--padding-base) * 0.2) calc(var(--padding-base) * 0.7); }
            .header-search-area { display: none; }
            /* Ensure topics modal is not overly wide if base was changed for desktop */
            /* #topicsModal .modal-content remains max-width: 560px due to CSS specificity order */
        }
        @media (max-width: 480px) { 
            .message { max-width: 92%; }
            .header-actions { gap: calc(var(--padding-base) * 0.2); } 
            .footer-action-button { padding: calc(var(--padding-base) * 0.5); }
            .footer-action-button svg { width: clamp(17px, 3.1vw, 19px); height: clamp(17px, 3.1vw, 19px); }
            .send-button svg { width: clamp(20px, 4vw, 23px); height: clamp(20px, 4vw, 23px); }
            .modal-content { width: 95%; max-width: 95%; /* Allow smaller modals to be smaller */ }
            #topicsModal .modal-content { /* Ensure topics modal isn't stuck at 560px on very small screens */
                 max-width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="ai-assistant-wrapper" id="aiAssistantWrapper">
        <div class="ai-assistant-container" id="aiAssistantContainer">
            <!-- Header -->
            <header class="assistant-header">
                <div class="header-title-area">
                    <svg class="sparkle-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 1.5L13.63 6.72L19.5 7.8L15.19 11.81L16.21 17.5L12 14.59L7.79 17.5L8.81 11.81L4.5 7.8L10.37 6.72L12 1.5ZM19 10.5L18.13 12.78L15.75 13.5L18.13 14.22L19 16.5L19.87 14.22L22.25 13.5L19.87 12.78L19 10.5ZM5 10.5L5.87 12.78L3.5 13.5L5.87 14.22L5 16.5L4.13 14.22L1.75 13.5L4.13 12.78L5 10.5Z"/></svg>
                    <h1 id="assistantNameDisplay">Aura Intelligence</h1>
                </div>
                <div class="header-search-area">
                    <input type="text" id="chatSearchInput" placeholder="Search chat...">
                    <button id="clearChatSearchBtn" title="Clear search">&times;</button>
                </div>
                <div class="header-actions">
                     <button class="header-icon-btn" id="personalizeBtn" title="Personalize">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM4 20a8 8 0 0116 0H4z" clip-rule="evenodd" /></svg>
                    </button>
                    <button class="header-icon-btn" id="settingsBtn" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M11.983 1.999a2 2 0 012 2v1.01a7.5 7.5 0 013.013 1.25l.71-.71a2 2 0 112.828 2.828l-.71.71a7.5 7.5 0 011.25 3.013h1.009a2 2 0 110 4h-1.01a7.5 7.5 0 01-1.25 3.013l.71.71a2 2 0 11-2.828 2.828l-.71-.71a7.5 7.5 0 01-3.013 1.25v1.01a2 2 0 11-4 0v-1.01a7.5 7.5 0 01-3.013-1.25l-.71.71a2 2 0 11-2.828-2.828l.71-.71a7.5 7.5 0 01-1.25-3.013H2.01a2 2 0 110-4h1.01a7.5 7.5 0 011.25-3.013l-.71-.71a2 2 0 112.828-2.828l.71.71a7.5 7.5 0 013.013-1.25V3.999a2 2 0 012-2zM12 9a3 3 0 100 6 3 3 0 000-6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button class="header-icon-btn" id="themeToggleBtn" title="Toggle Theme">
                        <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" /></svg>
                        <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path d="M12 2.25a.75.75 0 01.75.75V4a.75.75 0 01-1.5 0V3A.75.75 0 0112 2.25zm6.364 3.886a.75.75 0 011.06 1.06l-.708.708a.75.75 0 11-1.06-1.06l.708-.708zM21.75 12a.75.75 0 01-.75.75H20a.75.75 0 010-1.5h1a.75.75 0 01.75.75zm-3.886 6.364a.75.75 0 01-1.06 1.06l-.708-.708a.75.75 0 111.06-1.06l.708.708zM12 19.5a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-1a.75.75 0 01.75-.75zm-6.364-1.136a.75.75 0 011.06 1.06l-.708.708a.75.75 0 01-1.06-1.06l.708-.708zM4 12.75A.75.75 0 013.25 12a.75.75 0 01.75-.75H5a.75.75 0 010 1.5H4zm1.636-6.364a.75.75 0 10-1.06 1.06l.708.708a.75.75 0 101.06-1.06l-.708-.708zM12 6.75a5.25 5.25 0 100 10.5 5.25 5.25 0 000-10.5z"/></svg>
                    </button>
                    <button class="header-icon-btn" id="clearChatBtn" title="Clear All Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.53 3.47A.75.75 0 0110.06 3h3.88a.75.75 0 01.53.22l.72.72H20a.75.75 0 010 1.5h-.668l-.792 13.06A2.25 2.25 0 0116.294 21H7.706a2.25 2.25 0 01-2.246-2.22L4.668 5.44H4a.75.75 0 010-1.5h4.18l.72-.72zm3.97 7.28a.75.75 0 10-1.06-1.06L12 10.94l-1.44-1.45a.75.75 0 00-1.06 1.06L10.94 12l-1.45 1.44a.75.75 0 101.06 1.06L12 13.06l1.44 1.45a.75.75 0 101.06-1.06L13.06 12l1.45-1.44z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </header>
            <!-- Chat Window -->
            <div class="chat-window" id="chatWindow">
                <div class="initial-prompt-area" id="initialPromptArea">
                    <div class="orb-container"><div class="orb" id="dynamicOrb"></div></div>
                    <p class="prompt-text" id="initialPromptText">How can Aura Intelligence assist you today?</p>
                    <div class="suggestions" id="initialSuggestions">
                        <button class="suggestion-chip" data-suggestion="What can you do?">What can you do?</button>
                        <button class="suggestion-chip" data-suggestion="Add task: Plan weekend trip prio:high">Add task: Plan weekend prio:high</button>
                        <button class="suggestion-chip" data-suggestion="Tell me a quote">Tell me a quote</button>
                        <button class="suggestion-chip" data-suggestion="List notes tagged project">Notes tagged 'project'</button>
                         <button class="suggestion-chip" data-suggestion="Hey Aura, activate live mode">Activate Live Mode</button>
                    </div>
                </div>
                <div id="chatLog" class="chat-log"></div>
                <div id="typingIndicator" class="typing-indicator hidden"><span></span><span></span><span></span></div>
                <div class="scroll-buttons">
                    <button id="scrollToTopBtn" title="Scroll to Top"></button>
                    <button id="scrollToBottomBtn" title="Scroll to Bottom"></button>
                </div>
            </div>
            <!-- Footer -->
            <footer class="assistant-footer">
                <button class="footer-action-button" id="topicsBtn" title="Topics & Quick Actions">
                    <svg viewBox="0 0 24 24"><path d="M12 5V19M5 12H19" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="footer-action-button" id="attachBtn" title="Attach file">
                    <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6.003 6.003 0 1 1-8.49-8.49l9.19-9.19a4.002 4.002 0 0 1 5.66 5.66l-9.2 9.19a2.001 2.001 0 1 1-2.83-2.83l8.49-8.48"></path></svg>
                </button>
                <input type="file" id="fileInput" accept="*/*" style="display:none;">
                <div class="input-area-wrapper">
                    <div id="userInputEditable" contenteditable="true" data-placeholder="Ask Aura Intelligence anything..."></div>
                </div>
                <button class="footer-action-button" id="micBtn" title="Voice input">
                    <svg viewBox="0 0 24 24"><path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.41 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
                </button>
                <button class="send-button" id="sendBtn" title="Send message">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </footer>
        </div>
    </div>

    <!-- START: Aura Live Mode UI (hidden by default) -->
    <div class="aura-live-mode-overlay hidden" id="auraLiveModeOverlay">
        <div class="aura-live-mode-container">
            <h1 class="live-mode-title-integrated">Aura Inteligence Live Mode</h1>
            <div class="grid-overlay-integrated"></div>
            <div class="scan-line-integrated"></div>
            <div class="central-orb-integrated"></div>
            <div class="corner-element-tl-integrated"></div> 
            <div class="corner-element-br-integrated"></div> 
            <canvas id="liveAudioCanvas"></canvas>
            <div class="live-recognized-speech-container">
                <div id="liveRecognizedSpeech">Initializing live feed...</div>
            </div>
            <div class="live-status-text" id="liveStatusText">STATUS: OFFLINE</div>
            <button class="close-live-mode-btn-integrated" id="closeLiveModeBtnIntegrated">Terminate Feed</button>
        </div>
    </div>
    <!-- END: Aura Live Mode UI -->


    <!-- Modals -->
    <div class="modal-overlay" id="personalizationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Let's Get Personal!</h2>
                 <button class="modal-close-btn" data-modal-id="personalizationModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:15px; font-size: 0.95em; color: var(--current-text-color-darker);">Help me get to know you and how you'd like to call me.</p>
                <label for="userNameInput">What should I call you?</label>
                <input type="text" id="userNameInput" placeholder="E.g., Alex, Friend, Chief">
                
                <label for="assistantNameInput" style="margin-top:15px;">What would you like to name me?</label>
                <input type="text" id="assistantNameInput" placeholder="E.g., Aura, Genie, Companion">
                
                <button class="modal-button" id="savePersonalizationBtn">Save & Start</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close-btn" data-modal-id="settingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <label>
                    <input type="checkbox" id="showTimestampsSetting"> Show Timestamps
                </label>
                <label>
                    <input type="checkbox" id="showTypingIndicatorSetting"> Show Bot Typing Indicator
                </label>
                <label>
                    <input type="checkbox" id="enableTtsSetting"> Read Bot Messages Aloud
                </label>
                <label>
                    <input type="checkbox" id="enableReminderNotificationsSetting"> Enable Reminder Notifications
                </label>
                 <label for="botPersonalitySetting" style="margin-top: 15px;">My Personality:</label>
                <select id="botPersonalitySetting">
                    <option value="assistant">Helpful Assistant (Default)</option>
                    <option value="friendly">Friendly Pal</option>
                    <option value="formal">Formal & Professional</option>
                    <option value="witty">A Bit Witty</option>
                    <option value="jarvis">Jarvis-like Professional</option>
                </select>
                <label style="margin-top: 15px;">
                    <input type="checkbox" id="fullAssistantModeSetting"> Enable Full Assistant Mode (Simulated Auto-Actions)
                </label>
                <button class="action-button" id="exportChatBtn" style="margin-top: 20px;">Export Chat (.txt)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="topicsModal">
        <div class="modal-content"> 
            <div class="modal-header">
                <h2>Topics & Quick Actions</h2>
                <button class="modal-close-btn" data-modal-id="topicsModal">&times;</button>
            </div>
            <div class="modal-body topics-list" id="topicsListContainer">
                <h4>Core Features:</h4>
                <button data-topic="What can you do?">Show available commands</button>
                <button data-action="openTaskManagerModal">Open Task Manager</button>
                <button data-action="openPlannerModal">Open Planner</button>
                <button data-topic="Add note ">Take a new note</button>
                <button data-topic="List notes">Show my notes</button>
                <button id="triggerFileAttachmentModalAction" class="action-button">Attach a File</button>
                <hr>
                <h4>Productivity & Tools:</h4>
                <button data-action="openPomodoroModal">Open Pomodoro Timer</button>
                <button data-action="openCodeSnippetModal">Manage Code Snippets</button>
                <button data-topic="Generate code for a login form in Python">Generate example code</button>
                 <button data-topic="Hey Aura, activate live mode">Activate Live Mode</button>
                <hr>
                <h4>Communication (Simulated):</h4>
                <button data-topic="Check email">Check Email</button>
                <button data-topic="Send email to example@email.com subject Test body Hello">Send Email</button>
                <button data-topic="Check SMS messages">Check SMS</button>
                <button data-topic="Send SMS to 123-456-7890 message Hi there">Send SMS</button>
                <button data-topic="Call John Doe">Make a Call</button>
                <hr>
                <h4>Simulated Environment:</h4>
                <div id="simulatedDevicesContainer" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px;">
                    <!-- Device controls will be rendered here by JS -->
                </div>
                <button data-topic="system status" class="action-button" style="font-size: 0.9em;">Check Environment Status</button>
                <button data-topic="system diagnostics" class="action-button" style="font-size: 0.9em;">Run System Diagnostics</button>
                <hr>
                <h4>Personal & Well-being:</h4>
                <button data-action="openMoodLogModal">Log My Mood</button>
                <button data-topic="list memories">List My Memories</button>
                <button data-topic="Tell me a quote">Tell me a quote</button>
            </div>
        </div>
    </div>

    <!-- Task Manager Modal -->
    <div class="modal-overlay" id="taskManagerModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Task Manager</h2>
                <button class="modal-close-btn" data-modal-id="taskManagerModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="taskListContainerInModal" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                    <!-- Tasks will be rendered here by JS -->
                </div>
                <button id="toggleAddTaskFormInModalBtn" class="action-button">Add New Task</button>
                <div id="addTaskFormInModal" class="hidden" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--current-glass-border);">
                    <label for="newTaskDescModal">Description:</label>
                    <input type="text" id="newTaskDescModal" placeholder="Task description">
                    <label for="newTaskDueDateModal">Due Date (Optional):</label>
                    <input type="text" id="newTaskDueDateModal" placeholder="e.g., tomorrow, next friday">
                    <label for="newTaskPriorityModal">Priority:</label>
                    <select id="newTaskPriorityModal">
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                    </select>
                    <button id="saveNewTaskFromModalBtn" class="modal-button" style="margin-top:10px;">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Planner Modal -->
    <div class="modal-overlay" id="plannerModal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h2>My Planner</h2>
                <button class="modal-close-btn" data-modal-id="plannerModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="plannerEntriesContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                    <!-- Planner entries will be rendered here by JS -->
                </div>
                <button id="toggleAddPlannerEntryFormBtn" class="action-button">Add New Event</button>
                <div id="addPlannerEntryForm" class="hidden">
                    <label for="newEventNameModal">Event Name:</label>
                    <input type="text" id="newEventNameModal" placeholder="e.g., Doctor's Appointment">
                    <label for="newEventDateTimeModal">Date & Time:</label>
                    <input type="datetime-local" id="newEventDateTimeModal">
                    <label for="newEventNotesModal">Notes (Optional):</label>
                    <textarea id="newEventNotesModal" placeholder="Additional details..."></textarea>
                    <button id="saveNewPlannerEntryBtn" class="modal-button">Save Event</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Pomodoro, Mood, Code Modals -->
    <div class="modal-overlay" id="pomodoroModal"> <div class="modal-content" style="max-width: 400px;"> <div class="modal-header"> <h2>Pomodoro Timer</h2> <button class="modal-close-btn" data-modal-id="pomodoroModal">&times;</button> </div> <div class="modal-body"> <div id="pomodoroDisplay">25:00</div> <div id="pomodoroCurrentMode" style="text-align:center; margin-bottom:10px; font-weight:600;">Work Session</div> <div class="pomodoro-controls"> <button id="pomodoroStartPauseBtn" class="modal-button" style="width:auto;">Start</button> <button id="pomodoroResetBtn" class="modal-button" style="width:auto; background-color: var(--current-text-color-darker);">Reset</button> <button id="pomodoroSkipBtn" class="modal-button" style="width:auto; background-color: var(--current-text-color-darker); font-size:0.8em">Skip</button> </div> <button class="action-button pomodoro-settings-toggle" id="pomodoroToggleSettingsBtn" style="font-size:0.9em; text-align:center;">Timer Settings</button> <div id="pomodoroSettingsArea" class="hidden"> <label for="pomodoroWorkDuration">Work (min): <input type="number" id="pomodoroWorkDuration" value="25" min="1"></label> <label for="pomodoroShortBreakDuration">Short Break (min): <input type="number" id="pomodoroShortBreakDuration" value="5" min="1"></label> <label for="pomodoroLongBreakDuration">Long Break (min): <input type="number" id="pomodoroLongBreakDuration" value="15" min="1"></label> <label for="pomodoroCycles">Cycles for Long Break: <input type="number" id="pomodoroCycles" value="4" min="1"></label> <button id="pomodoroSaveSettingsBtn" class="modal-button" style="margin-top:10px;">Save Settings</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="moodLogModal"> <div class="modal-content"> <div class="modal-header"> <h2>How are you feeling?</h2> <button class="modal-close-btn" data-modal-id="moodLogModal">&times;</button> </div> <div class="modal-body"> <label>Select your current mood:</label> <div class="mood-options" id="moodLogOptions"> <input type="radio" name="mood" id="moodHappy" value="Happy"><label for="moodHappy"> Happy</label> <input type="radio" name="mood" id="moodSad" value="Sad"><label for="moodSad"> Sad</label> <input type="radio" name="mood" id="moodAnxious" value="Anxious"><label for="moodAnxious"> Anxious</label> <input type="radio" name="mood" id="moodCalm" value="Calm"><label for="moodCalm"> Calm</label> <input type="radio" name="mood" id="moodProductive" value="Productive"><label for="moodProductive"> Productive</label> <input type="radio" name="mood" id="moodTired" value="Tired"><label for="moodTired"> Tired</label> </div> <label for="moodLogNotes">Any thoughts or reasons? (Optional)</label> <textarea id="moodLogNotes" placeholder="E.g., Had a great day..."></textarea> <button class="modal-button" id="saveMoodLogBtn">Save Mood Log</button> </div> </div> </div>
    <div class="modal-overlay" id="codeSnippetModal"> <div class="modal-content" style="max-width: 600px;"> <div class="modal-header"> <h2>Code Snippets</h2> <button class="modal-close-btn" data-modal-id="codeSnippetModal">&times;</button> </div> <div class="modal-body"> <p style="font-size:0.9em; color:var(--current-text-color-darker); margin-bottom:10px;">Manage your saved code snippets or ask me to `generate code for [description] in [language]`.</p> <div id="codeSnippetFormArea"> <h3 id="snippetFormTitle" style="font-weight:600; margin-bottom:10px;">Add New Snippet</h3> <input type="hidden" id="snippetIdInput"> <label for="snippetTitleInput">Title:</label> <input type="text" id="snippetTitleInput" placeholder="e.g., JS Fetch Example"> <label for="snippetLanguageInput">Language:</label> <input type="text" id="snippetLanguageInput" placeholder="e.g., javascript, python"> <label for="snippetCodeInput">Code:</label> <textarea id="snippetCodeInput" placeholder="Paste code here..."></textarea> <button class="modal-button" id="saveSnippetBtn">Save Snippet</button> <button class="action-button hidden" id="cancelEditSnippetBtn" style="margin-top:5px;">Cancel Edit</button> </div> <div id="viewSnippetArea" class="hidden"> <h3 id="viewSnippetTitle" style="font-weight:600; margin-bottom:10px;"></h3> <p style="font-size:0.9em; color:var(--current-text-color-darker); margin-bottom:5px;">Language: <span id="viewSnippetLanguage"></span></p> <div id="viewSnippetCode"></div> <div style="margin-top:15px; display:flex; gap:10px;"> <button class="action-button" id="copySnippetBtn">Copy</button> <button class="action-button" id="editViewedSnippetBtn">Edit</button> <button class="action-button" id="backToSnippetsListBtn">Back</button> </div> </div> <hr style="border-color: var(--current-glass-border); margin: 20px 0;"> <h3 style="font-weight:600; margin-bottom:10px;">My Snippets</h3> <div id="codeSnippetsList"><p>No snippets saved.</p></div> <button class="action-button" id="showSnippetFormBtn" style="margin-top:10px;">Add New Snippet</button> </div> </div> </div>


    <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const root = document.documentElement;
    const aiAssistantWrapper = document.getElementById('aiAssistantWrapper');
    const assistantContainer = document.getElementById('aiAssistantContainer');
    const assistantNameDisplay = document.getElementById('assistantNameDisplay');
    const userInputEditable = document.getElementById('userInputEditable');
    const sendBtn = document.getElementById('sendBtn');
    const chatLog = document.getElementById('chatLog');
    const chatWindow = document.getElementById('chatWindow');
    const initialPromptArea = document.getElementById('initialPromptArea');
    const initialPromptText = document.getElementById('initialPromptText');
    const initialSuggestionsContainer = document.getElementById('initialSuggestions');
    const typingIndicator = document.getElementById('typingIndicator');
    const dynamicOrbElement = document.getElementById('dynamicOrb');
    
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeIconMoon = document.getElementById('themeIconMoon');
    const themeIconSun = document.getElementById('themeIconSun');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const chatSearchInput = document.getElementById('chatSearchInput');
    const clearChatSearchBtn = document.getElementById('clearChatSearchBtn');
    
    const personalizeBtn = document.getElementById('personalizeBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const topicsBtn = document.getElementById('topicsBtn');
    const micBtn = document.getElementById('micBtn'); 
    const attachBtn = document.getElementById('attachBtn'); 
    const fileInput = document.getElementById('fileInput'); 

    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');

    // Modals & Controls
    const personalizationModal = document.getElementById('personalizationModal');
    const userNameInput = document.getElementById('userNameInput');
    const assistantNameInput = document.getElementById('assistantNameInput');
    const savePersonalizationBtn = document.getElementById('savePersonalizationBtn');
    
    const settingsModal = document.getElementById('settingsModal');
    const showTimestampsSetting = document.getElementById('showTimestampsSetting');
    const showTypingIndicatorSetting = document.getElementById('showTypingIndicatorSetting');
    const enableTtsSetting = document.getElementById('enableTtsSetting'); 
    const enableReminderNotificationsSetting = document.getElementById('enableReminderNotificationsSetting');
    const botPersonalitySetting = document.getElementById('botPersonalitySetting');
    const fullAssistantModeSetting = document.getElementById('fullAssistantModeSetting');
    const exportChatBtn = document.getElementById('exportChatBtn');

    const topicsModal = document.getElementById('topicsModal');
    const topicsListContainer = document.getElementById('topicsListContainer');
    const triggerFileAttachmentModalAction = document.getElementById('triggerFileAttachmentModalAction');
    const simulatedDevicesContainer = document.getElementById('simulatedDevicesContainer');


    // Task Manager Modal Elements
    const taskManagerModal = document.getElementById('taskManagerModal');
    const taskListContainerInModal = document.getElementById('taskListContainerInModal');
    const toggleAddTaskFormInModalBtn = document.getElementById('toggleAddTaskFormInModalBtn');
    const addTaskFormInModal = document.getElementById('addTaskFormInModal');
    const newTaskDescModalInput = document.getElementById('newTaskDescModal');
    const newTaskDueDateModalInput = document.getElementById('newTaskDueDateModal');
    const newTaskPriorityModalSelect = document.getElementById('newTaskPriorityModal');
    const saveNewTaskFromModalBtn = document.getElementById('saveNewTaskFromModalBtn');

    // Planner Modal Elements
    const plannerModal = document.getElementById('plannerModal');
    const plannerEntriesContainer = document.getElementById('plannerEntriesContainer');
    const toggleAddPlannerEntryFormBtn = document.getElementById('toggleAddPlannerEntryFormBtn');
    const addPlannerEntryForm = document.getElementById('addPlannerEntryForm');
    const newEventNameModalInput = document.getElementById('newEventNameModal');
    const newEventDateTimeModalInput = document.getElementById('newEventDateTimeModal');
    const newEventNotesModalInput = document.getElementById('newEventNotesModal');
    const saveNewPlannerEntryBtn = document.getElementById('saveNewPlannerEntryBtn');


    const pomodoroModal = document.getElementById('pomodoroModal');
    const pomodoroDisplay = document.getElementById('pomodoroDisplay');
    const pomodoroCurrentModeDisplay = document.getElementById('pomodoroCurrentMode');
    const pomodoroStartPauseBtn = document.getElementById('pomodoroStartPauseBtn');
    const pomodoroResetBtn = document.getElementById('pomodoroResetBtn');
    const pomodoroSkipBtn = document.getElementById('pomodoroSkipBtn');
    const pomodoroToggleSettingsBtn = document.getElementById('pomodoroToggleSettingsBtn');
    const pomodoroSettingsArea = document.getElementById('pomodoroSettingsArea');
    const pomodoroWorkDurationInput = document.getElementById('pomodoroWorkDuration');
    const pomodoroShortBreakDurationInput = document.getElementById('pomodoroShortBreakDuration');
    const pomodoroLongBreakDurationInput = document.getElementById('pomodoroLongBreakDuration');
    const pomodoroCyclesInput = document.getElementById('pomodoroCycles');
    const pomodoroSaveSettingsBtn = document.getElementById('pomodoroSaveSettingsBtn');

    const moodLogModal = document.getElementById('moodLogModal');
    const moodLogOptionsContainer = document.getElementById('moodLogOptions');
    const moodLogNotesInput = document.getElementById('moodLogNotes');
    const saveMoodLogBtn = document.getElementById('saveMoodLogBtn');

    const codeSnippetModal = document.getElementById('codeSnippetModal');
    const codeSnippetFormArea = document.getElementById('codeSnippetFormArea');
    const snippetFormTitle = document.getElementById('snippetFormTitle');
    const snippetIdInput = document.getElementById('snippetIdInput');
    const snippetTitleInput = document.getElementById('snippetTitleInput');
    const snippetLanguageInput = document.getElementById('snippetLanguageInput');
    const snippetCodeInput = document.getElementById('snippetCodeInput');
    const saveSnippetBtn = document.getElementById('saveSnippetBtn');
    const cancelEditSnippetBtn = document.getElementById('cancelEditSnippetBtn');
    const viewSnippetArea = document.getElementById('viewSnippetArea');
    const viewSnippetTitle = document.getElementById('viewSnippetTitle');
    const viewSnippetLanguage = document.getElementById('viewSnippetLanguage');
    const viewSnippetCode = document.getElementById('viewSnippetCode');
    const copySnippetBtn = document.getElementById('copySnippetBtn');
    const editViewedSnippetBtn = document.getElementById('editViewedSnippetBtn');
    const backToSnippetsListBtn = document.getElementById('backToSnippetsListBtn');
    const codeSnippetsListContainer = document.getElementById('codeSnippetsList');
    const showSnippetFormBtn = document.getElementById('showSnippetFormBtn');

    // --- Aura Live Mode DOM Elements ---
    const auraLiveModeOverlay = document.getElementById('auraLiveModeOverlay');
    const liveAudioCanvas = document.getElementById('liveAudioCanvas');
    const liveRecognizedSpeechEl = document.getElementById('liveRecognizedSpeech');
    const liveStatusTextEl = document.getElementById('liveStatusText');
    const closeLiveModeBtnIntegrated = document.getElementById('closeLiveModeBtnIntegrated');
    let liveAudioContext, liveAnalyser, liveMicrophoneStream, liveDataArray, liveBufferLength, liveAnimationId, liveRecognition;


    // --- State Variables ---
    const APP_VERSION = "Aura Intelligence v1.3.0 - Enhanced Comms & Planning"; 
    const STORAGE_PREFIX = 'AuraIntelligence_V1_'; 
    const KEYS = {
        APP_STATE: `${STORAGE_PREFIX}appState`,
        CHAT_HISTORY: `${STORAGE_PREFIX}chatHistory`,
        TASKS: `${STORAGE_PREFIX}tasks`,
        REMINDERS: `${STORAGE_PREFIX}reminders`,
        NOTES: `${STORAGE_PREFIX}notes`,
        POMODORO_SETTINGS: `${STORAGE_PREFIX}pomodoroSettings`,
        MOOD_ENTRIES: `${STORAGE_PREFIX}moodEntries`,
        LONG_TERM_MEMORY: `${STORAGE_PREFIX}longTermMemory`,
        CODE_SNIPPETS: `${STORAGE_PREFIX}codeSnippets`,
        SIMULATED_DEVICES: `${STORAGE_PREFIX}simulatedDevices`,
        PLANNER_ENTRIES: `${STORAGE_PREFIX}plannerEntries`,
        LAST_QUOTE_FETCH_DATE: `${STORAGE_PREFIX}lastQuoteFetchDate`
    };

    let appState = {
        isLightTheme: false,
        showTimestamps: true,
        showTypingIndicator: true,
        ttsEnabled: false, 
        reminderNotificationsEnabled: false,
        botPersonality: 'assistant',
        userName: '',
        assistantName: 'Aura Intelligence',
        isPersonalized: false,
        lastOpenedDate: null,
        fullAssistantMode: false, // For simulated auto-actions
        autoReplySettings: {
            email: { enabled: false, message: "I'm currently unavailable, will reply soon." },
            sms: { enabled: false, message: "Away, will text back later." },
            whatsapp: { enabled: false, message: "Can't chat now, will reply later." }
        }
    };

    let chatHistory = [];
    let voices = []; 
    let speechRecognition; // For CHAT Web Speech API

    let botInternalState = {
        currentAction: null, 
        actionData: {},    
        currentEditMessageId: null,
        isListening: false, // For CHAT mic
        isEdgeGlowNeededByMic: false, 
        isEdgeGlowNeededByBot: false, 
        awaitingConfirmation: null,
        isLiveModeActive: false,
        botIsSpeakingLive: false,
        simulatedCallState: null // e.g., { contact: "John", duration: 0, status: "ringing|active|ended", intervalId: null }
    };

    // --- Utility Functions ---
    function saveData(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error("Save Error ("+key+"): ", e); if(key !== KEYS.CHAT_HISTORY) { addBotMessage(`Critical Error: Could not save data for ${key}. Some changes might be lost. Please check console.`, false);} }}
    function loadData(key, defaultValue) { const d=localStorage.getItem(key); if(d){try{return JSON.parse(d);}catch(e){console.error("Parse Error ("+key+"): ",e);localStorage.removeItem(key);return defaultValue;}} return defaultValue;}
    function generateId(prefix = 'id-') { return prefix + Date.now() + '-' + Math.random().toString(36).substring(2, 11); }
    function cleanTextForSpeech(text) { if (typeof text !== 'string') text = String(text); let cleanedText = text; cleanedText = cleanedText.replace(/<span class="live-user-speech">.*?<\/span>/gi, ''); cleanedText = cleanedText.replace(/<span class="live-bot-speech">.*?<\/span>/gi, ''); cleanedText = cleanedText.replace(/```(\w*\n)?([\s\S]*?)```/g, ' (code block) '); cleanedText = cleanedText.replace(/`([^`]+?)`/g, '$1'); cleanedText = cleanedText.replace(/\*\*(.*?)\*\*|\_\_(.*?)\_\_/g, '$1$2'); cleanedText = cleanedText.replace(/\*(.*?)\*|\_(.*?)\_/g, '$1$2'); cleanedText = cleanedText.replace(/\~\~(.*?)\~\~/g, '$1'); cleanedText = cleanedText.replace(/^\s*#+\s*/gm, ''); cleanedText = cleanedText.replace(/^\s*([-*+])\s+(.*)/gm, (match, bullet, item) => item); cleanedText = cleanedText.replace(/^\s*(\d+\.)\s+(.*)/gm, (match, num, item) => item); cleanedText = cleanedText.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1'); cleanedText = cleanedText.replace(/<div class="note-tags">.*?<\/div>/g, ''); cleanedText = cleanedText.replace(/<div class="file-attachment-preview">.*?<\/div>/g, ''); cleanedText = cleanedText.replace(/<div class="file-attachment-info">.*?<\/div>/g, ''); cleanedText = cleanedText.replace(/<div class="file-content-preview">.*?<\/div>/g, ''); return cleanedText.replace(/\n/g, ' ').replace(/<br\s*\/?>/gi, ' ').trim(); }
    
    function speakText(text) {
        if (!appState.ttsEnabled || !text) {
            return;
        }
        if (typeof window.speechSynthesis === 'undefined') {
            console.warn("Speech Synthesis not supported by this browser.");
            return;
        }
        
        const cleanedMessage = cleanTextForSpeech(text);
        if (!cleanedMessage) {
            return;
        }

        if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
            window.speechSynthesis.cancel();
        }
        
        const utterance = new SpeechSynthesisUtterance(cleanedMessage);
        let liveTtsTimeoutId = null;

        utterance.onerror = (event) => {
            console.error("SpeechSynthesisUtterance.onerror general:", event);
            if (botInternalState.isLiveModeActive) {
                botInternalState.botIsSpeakingLive = false; 
                if (liveStatusTextEl) liveStatusTextEl.textContent = "ERROR: TTS FAILED";
                if (liveRecognition) { 
                    try { liveRecognition.start(); } catch(e) { console.error("Error restarting live recognition after TTS error:", e); }
                }
            }
            if (utterance) { utterance.onend = null; utterance.onstart = null; utterance.onerror = null;}
            if (liveTtsTimeoutId) clearTimeout(liveTtsTimeoutId);
        };

        if (botInternalState.isLiveModeActive && liveRecognition) {
            botInternalState.botIsSpeakingLive = true; 
            
            if (liveRecognition) {
                try {
                    liveRecognition.stop(); 
                } catch (e) {
                    console.error("Error stopping liveRecognition in speakText:", e);
                }
            }
            
            utterance.onstart = () => {
                if (liveTtsTimeoutId) clearTimeout(liveTtsTimeoutId); 
                if (liveStatusTextEl) liveStatusTextEl.textContent = "STATUS: AURA SPEAKING...";
            };

            utterance.onend = () => {
                if (liveTtsTimeoutId) clearTimeout(liveTtsTimeoutId);
                botInternalState.botIsSpeakingLive = false; 

                if (botInternalState.isLiveModeActive && liveRecognition) {
                    if (liveStatusTextEl) liveStatusTextEl.textContent = "STATUS: REINITIALIZING TRANSCRIPTION...";
                    try { 
                       liveRecognition.start(); 
                    } catch(e) { 
                        console.error("Error restarting live recognition in utterance.onend:", e);
                        if (liveStatusTextEl) liveStatusTextEl.textContent = "ERROR: FAILED TO RESTART REC.";
                    }
                }
                if (utterance) { utterance.onend = null; utterance.onstart = null; utterance.onerror = null;}
            };
            
            liveTtsTimeoutId = setTimeout(() => {
                if (botInternalState.botIsSpeakingLive) { 
                    if (utterance && utterance.onend) utterance.onend(); 
                }
            }, 10000); 
        }
        
        window.speechSynthesis.speak(utterance);
    }


    function populateVoices() { if (typeof window.speechSynthesis === 'undefined') return; voices = window.speechSynthesis.getVoices(); }
    
    // --- Notification Functions ---
    async function requestNotificationPermission() { if (!('Notification' in window)) { addBotMessage("This browser does not support desktop notification.", true); return false; } if (Notification.permission === 'granted') { return true; } if (Notification.permission !== 'denied') { const permission = await Notification.requestPermission(); if (permission === 'granted') { addBotMessage("Reminder notifications enabled! I'll try to notify you for due reminders.", true); return true; } else { addBotMessage("Reminder notifications permission denied. I won't be able to show system notifications.", true); return false; } } return false; }
    function showNotification(title, body, tag = 'aura-reminder') { if (appState.reminderNotificationsEnabled && 'Notification' in window && Notification.permission === 'granted') { const notification = new Notification(title, { body, tag, icon: './favicon.ico' });  notification.onclick = () => { window.focus(); }; } }

    // --- Modules for Bot Capabilities ---
    const Modules = { 
        Task: { 
            tasks: [], 
            priorityMap: { high: "High", medium: "Medium", low: "Low" },
            priorityStyle: { high: "task-priority-high", medium: "task-priority-medium", low: "task-priority-low" },
            init: function(ldT){this.tasks=ldT || []; this.renderListInModal();}, 
            save:function(){saveData(KEYS.TASKS,this.tasks); this.renderListInModal();}, 
            add:function(d, dd=null, priority = "medium"){ const validPriorities = ["low", "medium", "high"]; const taskPriority = validPriorities.includes(priority.toLowerCase()) ? priority.toLowerCase() : "medium"; const nT={id:generateId('task-'),description:d,dueDate:dd,priority:taskPriority,completed:false,createdAt:new Date().toISOString()}; this.tasks.push(nT);this.save(); let r=`Okay, I've added "${d}" (Priority: ${this.priorityMap[taskPriority]}) to your tasks.`;if(dd)r+=` It's due ${dd}.`;return r; }, 
            list:function(){ if(this.tasks.length===0)return`You have no tasks right now, ${appState.userName||'friend'}!`; let tS=`Here are your tasks, ${appState.userName||'User'}:\n\n**Active Tasks:**\n`; const prioSymbols = { high: "", medium: "", low: "" }; const aT=this.tasks.filter(t=>!t.completed).sort((a,b) => { const prioOrder = { high: 0, medium: 1, low: 2 }; if (prioOrder[a.priority] !== prioOrder[b.priority]) return prioOrder[a.priority] - prioOrder[b.priority]; return new Date(a.createdAt) - new Date(b.createdAt); }); if(aT.length>0){aT.forEach((t,i)=>{tS+=`- ${i+1}. ${prioSymbols[t.priority] || ''} ${t.description}${t.dueDate?` (Due: ${t.dueDate})`:''}\n`;});}else{tS+="_No active tasks._\n";} const cT=this.tasks.filter(t=>t.completed); if(cT.length>0){tS+="\n**Completed Tasks:**\n";cT.forEach((t)=>{tS+=`- [X] ~~${prioSymbols[t.priority] || ''} ${t.description}~~\n`;});} return tS; }, 
            setPriority: function(tI, newPriority) { const validPriorities = ["low", "medium", "high"]; const targetPriority = newPriority.toLowerCase(); if (!validPriorities.includes(targetPriority)) { return `Invalid priority. Use low, medium, or high.`; } const n=parseInt(tI);let taskToUpdate; const activeTasks=this.tasks.filter(t=>!t.completed); if(!isNaN(n)&&n>0&&n<=activeTasks.length){taskToUpdate=activeTasks[n-1];} else{taskToUpdate=this.tasks.find(t=>(t.description.toLowerCase().includes(tI.toLowerCase()) || t.id === tI) && !t.completed );} if(taskToUpdate){ taskToUpdate.priority = targetPriority; this.save(); return`Priority for task "${taskToUpdate.description}" set to ${targetPriority}.`; } return`Hmm, couldn't find active task matching "${tI}".`; },
            complete:function(tId, isCompleted){ const task = this.tasks.find(t => t.id === tId); if(task) { task.completed = isCompleted; this.save(); return task; } return null; },
            _performDelete:function(tId){const tX = this.tasks.findIndex(t => t.id === tId); if(tX!==-1){const dT=this.tasks.splice(tX,1)[0];this.save();return dT;} return null; },
            requestDelete:function(tI) { const n=parseInt(tI);let taskToDelete; const allTasks=this.tasks; if(!isNaN(n) && n > 0 && n <= allTasks.length) { taskToDelete = allTasks[n-1]; } else { taskToDelete = allTasks.find(t => t.description.toLowerCase().includes(tI.toLowerCase()) || t.id === tI); } if(taskToDelete){ botInternalState.awaitingConfirmation = { type: 'delete_task', identifier: taskToDelete.id, description: taskToDelete.description }; return `Delete task: "${taskToDelete.description}"? (yes/no)`; } return`Task "${tI}" not found.`; },
            clearAll:function(){this.tasks=[];this.save();},
            renderListInModal: function() {
                if (!taskListContainerInModal) return;
                taskListContainerInModal.innerHTML = '';
                if (this.tasks.length === 0) {
                    taskListContainerInModal.innerHTML = '<p style="text-align:center; color:var(--current-text-color-darker);">No tasks yet. Add one below!</p>';
                    return;
                }
                const sortedTasks = [...this.tasks].sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1; 
                    const prioOrder = { high: 0, medium: 1, low: 2 };
                    if (prioOrder[a.priority] !== prioOrder[b.priority]) return prioOrder[a.priority] - prioOrder[b.priority];
                    return new Date(a.createdAt) - new Date(b.createdAt);
                });

                sortedTasks.forEach(task => {
                    const item = document.createElement('div');
                    item.classList.add('task-item');
                    if (task.completed) item.style.opacity = '0.6';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = task.completed;
                    checkbox.dataset.taskId = task.id;
                    checkbox.addEventListener('change', (e) => {
                        const updatedTask = Modules.Task.complete(e.target.dataset.taskId, e.target.checked);
                        if (updatedTask) addBotMessage(`${appState.assistantName} Info: Task "${updatedTask.description}" marked as ${updatedTask.completed ? 'complete' : 'active'}.`, true);
                        this.renderListInModal(); 
                    });

                    const detailsDiv = document.createElement('div');
                    detailsDiv.classList.add('task-details');
                    const descP = document.createElement('p');
                    descP.classList.add('task-description');
                    descP.textContent = task.description;
                    if (task.completed) descP.style.textDecoration = 'line-through';
                    
                    const metaP = document.createElement('p');
                    metaP.classList.add('task-meta-info');
                    let metaText = `Priority: <span class="${this.priorityStyle[task.priority] || 'task-priority-medium'}">${this.priorityMap[task.priority] || 'Medium'}</span>`;
                    if (task.dueDate) metaText += ` | Due: ${task.dueDate}`;
                    metaP.innerHTML = metaText;

                    detailsDiv.appendChild(descP);
                    detailsDiv.appendChild(metaP);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('task-actions');
                    const deleteBtnEl = document.createElement('button'); 
                    deleteBtnEl.innerHTML = '&times;'; 
                    deleteBtnEl.title = "Delete task";
                    deleteBtnEl.dataset.taskId = task.id;
                    deleteBtnEl.addEventListener('click', (e) => {
                        const taskToDelete = this.tasks.find(t => t.id === e.currentTarget.dataset.taskId); 
                        if(taskToDelete) {
                            closeModal(taskManagerModal); 
                            getBotResponse(`delete task ${taskToDelete.description}`); 
                        }
                    });
                    actionsDiv.appendChild(deleteBtnEl);

                    item.appendChild(checkbox);
                    item.appendChild(detailsDiv);
                    item.appendChild(actionsDiv);
                    taskListContainerInModal.appendChild(item);
                });
            }
        },
        Reminder: { reminders:[], init:function(ldR){this.reminders=ldR || [];}, save:function(){saveData(KEYS.REMINDERS,this.reminders);}, add:function(t,rT){ let remindDateTime = null; try { const parsedDate = new Date(rT); if (!isNaN(parsedDate.getTime())) { remindDateTime = parsedDate.toISOString(); }} catch (e) {} const nR={id:generateId('rem-'),text:t,remindTime:rT, remindDateTime: remindDateTime, createdAt:new Date().toISOString(),acknowledged:false, notified: false}; this.reminders.push(nR);this.save(); return`Reminder set: "${t}" for ${rT}.`; }, list:function(){ if(this.reminders.length===0)return"No reminders set."; let lS="Your reminders:\n"; this.reminders.forEach((r,i)=>{ let status = r.acknowledged ? ' (Ack)' : ' (PENDING)'; if (!r.acknowledged && r.remindDateTime && new Date(r.remindDateTime) < new Date()) { status = ' (DUE)'; } lS+=`- ${i+1}. ${r.text} (For: ${r.remindTime})${status}\n`; }); this.checkAndNotifyDueReminders(); return lS; }, checkAndNotifyDueReminders: function() { if (!appState.reminderNotificationsEnabled || !('Notification' in window) || Notification.permission !== 'granted') return; const now = new Date(); this.reminders.forEach(reminder => { if (!reminder.acknowledged && !reminder.notified && reminder.remindDateTime) { const remindTime = new Date(reminder.remindDateTime); if (remindTime <= now) { showNotification(`${appState.assistantName} Reminder: ${reminder.text}`, `It's time for: ${reminder.remindTime}`, `reminder-${reminder.id}`); reminder.notified = true; }}}); this.save(); }, _performDelete:function(rId){const rX = this.reminders.findIndex(r => r.id === rId); if(rX!==-1){const dR=this.reminders.splice(rX,1)[0];this.save();return dR;} return null;}, requestDelete:function(rI){ const n=parseInt(rI);let reminderToDelete; if(!isNaN(n) && n > 0 && n <= this.reminders.length) { reminderToDelete = this.reminders[n-1]; } else { reminderToDelete = this.reminders.find(r => r.text.toLowerCase().includes(rI.toLowerCase()) || r.id === rI); } if(reminderToDelete){ botInternalState.awaitingConfirmation = { type: 'delete_reminder', identifier: reminderToDelete.id, description: reminderToDelete.text }; return `Delete reminder: "${reminderToDelete.text}"? (yes/no)`; } return`Reminder "${rI}" not found.`; }, clearAll:function(){this.reminders=[];this.save();}},
        Note: { notes:[], init:function(ldN){this.notes=ldN || [];}, save:function(){saveData(KEYS.NOTES,this.notes);}, add:function(t,c, tagsString = ""){ const tagsArray = tagsString ? tagsString.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : []; const nN={id:generateId('note-'),title:t,content:c, tags: tagsArray, createdAt:new Date().toISOString()}; this.notes.push(nN);this.save(); return`Note "${t}" saved! ${tagsArray.length > 0 ? `Tagged: ${tagsArray.join(', #')}.` : ''}`; }, list:function(){ if(this.notes.length===0)return"No notes yet."; let lS="Your notes:\n"; this.notes.forEach((n,i)=>{ lS+=`- ${i+1}. **${n.title}** ${n.tags && n.tags.length > 0 ? `(#${n.tags.join(', #')})` : ''}\n`; }); return lS+"\n`show note [id/title]`, `list notes tagged [tag]`." ; }, listByTag: function(tag) { const lowerTag = tag.toLowerCase(); const taggedNotes = this.notes.filter(n => n.tags && n.tags.includes(lowerTag)); if (taggedNotes.length === 0) return `No notes found with tag "#${tag}".`; let lS = `Notes tagged "#${tag}":\n`; taggedNotes.forEach((n, i) => { lS += `- ${i + 1}. **${n.title}**\n`; }); return lS; }, addTag: function(noteIdentifier, tagName) { const n=parseInt(noteIdentifier);let noteToUpdate; if(!isNaN(n)&&n>0&&n<=this.notes.length){noteToUpdate=this.notes[n-1];} else{noteToUpdate=this.notes.find(nt=>nt.title.toLowerCase().includes(noteIdentifier.toLowerCase()) || nt.id === noteIdentifier);} if (!noteToUpdate) return `Note "${noteIdentifier}" not found.`; const lowerTag = tagName.toLowerCase().trim(); if (!lowerTag) return "Tag name empty."; if (!noteToUpdate.tags) noteToUpdate.tags = []; if (noteToUpdate.tags.includes(lowerTag)) return `Note "${noteToUpdate.title}" already tagged "#${lowerTag}".`; noteToUpdate.tags.push(lowerTag); this.save(); return `Added tag "#${lowerTag}" to note "${noteToUpdate.title}".`; }, removeTag: function(noteIdentifier, tagName) { const n=parseInt(noteIdentifier);let noteToUpdate; if(!isNaN(n)&&n>0&&n<=this.notes.length){noteToUpdate=this.notes[n-1];} else{noteToUpdate=this.notes.find(nt=>nt.title.toLowerCase().includes(noteIdentifier.toLowerCase()) || nt.id === noteIdentifier);} if (!noteToUpdate) return `Note "${noteIdentifier}" not found.`; const lowerTag = tagName.toLowerCase().trim(); if (!noteToUpdate.tags || !noteToUpdate.tags.includes(lowerTag)) return `Note "${noteToUpdate.title}" not tagged "#${lowerTag}".`; noteToUpdate.tags = noteToUpdate.tags.filter(t => t !== lowerTag); this.save(); return `Removed tag "#${lowerTag}" from note "${noteToUpdate.title}".`; }, view:function(id){ const n=parseInt(id);let nS; if(!isNaN(n)&&n>0&&n<=this.notes.length){nS=this.notes[n-1];} else{nS=this.notes.find(nt=>nt.title.toLowerCase().includes(id.toLowerCase()) || nt.id === id);} if(nS){ let content = `**Note: ${nS.title}**\n\n${nS.content}\n\n_(Saved: ${new Date(nS.createdAt).toLocaleDateString()})_`; if (nS.tags && nS.tags.length > 0) { content += `\n<div class="note-tags">Tags: ${nS.tags.map(t => `<span class="tag">#${t}</span>`).join(' ')}</div>`; } return content; } return`Note "${id}" not found.`; }, _performDelete:function(nId){const nX = this.notes.findIndex(n => n.id === nId); if(nX!==-1){const dN=this.notes.splice(nX,1)[0];this.save();return dN;} return null;}, requestDelete:function(nI){ const n=parseInt(nI);let noteToDelete; if(!isNaN(n) && n > 0 && n <= this.notes.length) { noteToDelete = this.notes[n-1]; } else { noteToDelete = this.notes.find(nt => nt.title.toLowerCase().includes(nI.toLowerCase()) || nt.id === nI); } if(noteToDelete){ botInternalState.awaitingConfirmation = { type: 'delete_note', identifier: noteToDelete.id, description: noteToDelete.title }; return `Delete note "${noteToDelete.title}"? (yes/no)`; } return`Note "${nI}" not found.`; }, clearAll:function(){this.notes=[];this.save();}},
        Utility: { calculate:function(expr){try{const sE=expr.replace(/[^-()\d/*+.]/g,'');if (!sE) return "Provide valid calculation."; const res=new Function(`return ${sE}`)();if(typeof res==='number'&&!isNaN(res)){return`${expr} = ${res}`;}else{return"Calculation unexpected.";}}catch(e){return"Sorry, couldn't calculate.";}}, flipCoin:function(){return Math.random()<0.5?"It's Heads!":"It's Tails!";}, pickNumber:function(minS,maxS){const min=parseInt(minS);const max=parseInt(maxS);if(isNaN(min)||isNaN(max)||min>max)return"Provide valid min/max numbers.";return`I picked: ${Math.floor(Math.random()*(max-min+1))+min}`;}, getJournalPrompt:function(){ const p=["Grateful for today, and why?","Recent challenge & what you learned?","One small act of kindness today?","Talk to younger self, what advice/comfort?"]; return`Journal prompt for ${appState.userName||'friend'}:\n\n*${p[Math.floor(Math.random()*p.length)]}*`;} },
        FunStuff: { jokes: ["Scientists & atoms? They make up everything!", "Scarecrow award? Outstanding in his field!"], funFacts: ["Spaghetti strand is 'spaghetto'.", "Honey never spoils."], tellJoke: function() { return this.jokes[Math.floor(Math.random() * this.jokes.length)]; }, tellFunFact: function() { return `Did you know? ${this.funFacts[Math.floor(Math.random() * this.funFacts.length)]}`; } },
        Pomodoro: { settings: { workDuration: 25, shortBreakDuration: 5, longBreakDuration: 15, cycles: 4 }, state: { currentCycle: 0, mode: 'work', remainingTime: 25 * 60, isRunning: false, timerId: null }, init: function(loadedSettings) { if (loadedSettings) this.settings = {...this.settings, ...loadedSettings}; this.state.remainingTime = this.settings.workDuration * 60; this.updateDisplay(); this.updateModeDisplay();}, saveSettings: function() { saveData(KEYS.POMODORO_SETTINGS, this.settings); }, updateDisplay: function() { const minutes = Math.floor(this.state.remainingTime / 60); const seconds = this.state.remainingTime % 60; if (pomodoroDisplay) pomodoroDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;}, updateModeDisplay: function() { if(pomodoroCurrentModeDisplay) { let modeText = ""; if (this.state.mode === 'work') modeText = `Work Session #${this.state.currentCycle + 1}`; else if (this.state.mode === 'short_break') modeText = "Short Break"; else if (this.state.mode === 'long_break') modeText = "Long Break"; pomodoroCurrentModeDisplay.textContent = modeText; }}, start: function() { if (this.state.isRunning) return "Timer already running."; this.state.isRunning = true; if(pomodoroStartPauseBtn) pomodoroStartPauseBtn.textContent = "Pause"; this.state.timerId = setInterval(() => { this.state.remainingTime--; this.updateDisplay(); if (this.state.remainingTime <= 0) { this.switchMode(); addBotMessage(`${appState.assistantName}: Time's up! Switched to ${this.state.mode.replace('_', ' ')}.`, true); }}, 1000); return `Pomodoro started (${this.state.mode.replace('_',' ')}).`;}, pause: function() { if (!this.state.isRunning) return "Timer not running."; this.state.isRunning = false; if(pomodoroStartPauseBtn) pomodoroStartPauseBtn.textContent = "Start"; clearInterval(this.state.timerId); this.state.timerId = null; return "Pomodoro paused.";}, reset: function() { this.pause(); this.state.mode = 'work'; this.state.currentCycle = 0; this.state.remainingTime = this.settings.workDuration * 60; this.updateDisplay(); this.updateModeDisplay(); return "Pomodoro reset.";}, skip: function() { this.pause(); this.switchMode(true); return `Skipped to: ${this.state.mode.replace('_', ' ')}.`;}, switchMode: function(force = false) { if (this.state.mode === 'work' || force) { this.state.currentCycle++; if (this.state.currentCycle % this.settings.cycles === 0) { this.state.mode = 'long_break'; this.state.remainingTime = this.settings.longBreakDuration * 60; } else { this.state.mode = 'short_break'; this.state.remainingTime = this.settings.shortBreakDuration * 60; }} else { this.state.mode = 'work'; this.state.remainingTime = this.settings.workDuration * 60; } this.updateDisplay(); this.updateModeDisplay(); if (this.state.isRunning) { clearInterval(this.state.timerId); this.state.timerId = null; this.state.isRunning = false; this.start(); }}, setDurations: function(work, short, long, cycles) { this.settings.workDuration = parseInt(work) || 25; this.settings.shortBreakDuration = parseInt(short) || 5; this.settings.longBreakDuration = parseInt(long) || 15; this.settings.cycles = parseInt(cycles) || 4; this.saveSettings(); if (!this.state.isRunning && this.state.mode === 'work') { this.state.remainingTime = this.settings.workDuration * 60; this.updateDisplay(); } return "Pomodoro settings updated.";} },
        MoodJournal: { entries: [], init: function(loadedEntries) { this.entries = loadedEntries || []; }, save: function() { saveData(KEYS.MOOD_ENTRIES, this.entries); }, add: function(mood, notes) { const newEntry = { id: generateId('mood-'), mood: mood, notes: notes || "", timestamp: new Date().toISOString() }; this.entries.push(newEntry); this.save(); return `Mood logged: ${mood}. ${notes ? 'Noted: "' + notes + '"' : ''}`; }, list: function(period = "all") { if (this.entries.length === 0) return "No moods logged."; let filteredEntries = this.entries; if (period === "today") { const todayStart = new Date(); todayStart.setHours(0,0,0,0); filteredEntries = this.entries.filter(e => new Date(e.timestamp) >= todayStart); } if (filteredEntries.length === 0) return `No moods logged for ${period}.`; let response = `Your mood logs (${period}):\n`; filteredEntries.slice().reverse().slice(0, 10).forEach(entry => { response += `- ${new Date(entry.timestamp).toLocaleString()}: **${entry.mood}** ${entry.notes ? `(_${entry.notes}_)` : ''}\n`; }); if(filteredEntries.length > 10) response += "\n...and more (latest 10)."; return response; }, clearAll: function() { this.entries = []; this.save(); } },
        Memory: { store: {}, init: function(loadedMemory) { this.store = loadedMemory || {}; }, save: function() { saveData(KEYS.LONG_TERM_MEMORY, this.store); }, remember: function(key, value) { const lKey = key.toLowerCase(); this.store[lKey] = { value: value, rememberedAt: new Date().toISOString() }; this.save(); return `Okay, I'll remember: "${key}" is "${value}".`; }, recall: function(key) { const lKey = key.toLowerCase(); if (this.store[lKey]) { return `I remember "${key}" as "${this.store[lKey].value}" (from ${new Date(this.store[lKey].rememberedAt).toLocaleDateString()}).`; } return `No memory for "${key}".`; }, forget: function(key) { const lKey = key.toLowerCase(); if (this.store[lKey]) { delete this.store[lKey]; this.save(); return `Okay, forgotten "${key}".`; } return `No memory for "${key}" anyway.`; }, list: function() { const keys = Object.keys(this.store); if (keys.length === 0) return "No specific memories stored."; let response = "Things I'm remembering:\n"; keys.forEach(key => { response += `- **${key}**: ${this.store[key].value}\n`; }); return response; }, clearAll: function() { this.store = {}; this.save(); } },
        CodeSnippets: { snippets: [], init: function(loadedSnippets) { this.snippets = loadedSnippets || []; }, save: function() { saveData(KEYS.CODE_SNIPPETS, this.snippets); this.renderList();}, add: function(title, language, code) { const newSnippet = { id: generateId('snip-'), title, language, code, createdAt: new Date().toISOString() }; this.snippets.push(newSnippet); this.save(); return `Snippet "${title}" saved.`; }, update: function(id, title, language, code) { const index = this.snippets.findIndex(s => s.id === id); if (index === -1) return "Snippet not found."; this.snippets[index] = { ...this.snippets[index], title, language, code, updatedAt: new Date().toISOString() }; this.save(); return `Snippet "${title}" updated.`; }, list: function() { if (this.snippets.length === 0) return "No code snippets."; let response = "Your Code Snippets:\n"; this.snippets.forEach((s, i) => { response += `- ${i+1}. **${s.title}** (${s.language || 'N/A'})\n`; }); response += "\n`show snippet [id/title]` or Snippet Manager tool."; return response; }, get: function(identifier) { const num = parseInt(identifier); if (!isNaN(num) && num > 0 && num <= this.snippets.length) { return this.snippets[num - 1]; } return this.snippets.find(s => s.title.toLowerCase().includes(identifier.toLowerCase()) || s.id === identifier); }, view: function(identifier) { const snippet = this.get(identifier); if (!snippet) return `Snippet "${identifier}" not found.`; return `**Snippet: ${snippet.title}** (${snippet.language || 'N/A'})\n\`\`\`${snippet.language || ''}\n${snippet.code}\n\`\`\``; }, _performDelete: function(snippetId) { const index = this.snippets.findIndex(s => s.id === snippetId); if (index !== -1) { const deletedSnippet = this.snippets.splice(index, 1)[0]; this.save(); return deletedSnippet; } return null; }, requestDelete: function(identifier) { const snippet = this.get(identifier); if (snippet) { botInternalState.awaitingConfirmation = { type: 'delete_snippet', identifier: snippet.id, description: snippet.title }; return `Delete snippet "${snippet.title}"? (yes/no)`; } return `Snippet "${identifier}" not found.`; }, clearAll: function() { this.snippets = []; this.save(); }, renderList: function() { if (!codeSnippetsListContainer) return; codeSnippetsListContainer.innerHTML = ''; if (this.snippets.length === 0) { codeSnippetsListContainer.innerHTML = '<p>No snippets saved.</p>'; return; } this.snippets.forEach(snippet => { const item = document.createElement('div'); item.classList.add('snippet-item'); item.dataset.id = snippet.id; item.innerHTML = `<h4>${snippet.title}</h4><p>${snippet.language || 'N/A'} - Added: ${new Date(snippet.createdAt).toLocaleDateString()}</p>`; item.addEventListener('click', () => this.displaySnippetInModal(snippet.id)); codeSnippetsListContainer.appendChild(item); });}, displaySnippetInModal: function(id) { const snippet = this.get(id); if (!snippet || !viewSnippetArea || !codeSnippetFormArea) return; viewSnippetTitle.textContent = snippet.title; viewSnippetLanguage.textContent = snippet.language || 'N/A'; viewSnippetCode.textContent = snippet.code; viewSnippetArea.dataset.currentId = snippet.id; codeSnippetFormArea.classList.add('hidden'); showSnippetFormBtn.classList.remove('hidden'); viewSnippetArea.classList.remove('hidden'); }, showFormForEdit: function(id) { const snippet = this.get(id); if (!snippet || !codeSnippetFormArea || !viewSnippetArea) return; snippetFormTitle.textContent = "Edit Snippet"; snippetIdInput.value = snippet.id; snippetTitleInput.value = snippet.title; snippetLanguageInput.value = snippet.language || ''; snippetCodeInput.value = snippet.code; cancelEditSnippetBtn.classList.remove('hidden'); viewSnippetArea.classList.add('hidden'); codeSnippetFormArea.classList.remove('hidden'); showSnippetFormBtn.classList.add('hidden');}, resetForm: function() { snippetFormTitle.textContent = "Add New Snippet"; snippetIdInput.value = ''; snippetTitleInput.value = ''; snippetLanguageInput.value = ''; snippetCodeInput.value = ''; cancelEditSnippetBtn.classList.add('hidden'); } },
        Planner: {
            entries: [],
            init: function(loadedEntries) { this.entries = loadedEntries || []; this.renderEntriesInModal(); },
            save: function() { saveData(KEYS.PLANNER_ENTRIES, this.entries); this.renderEntriesInModal(); },
            add: function(name, dateTime, notes = "") {
                if (!name || !dateTime) return "Event name and date/time are required.";
                const newEntry = { id: generateId('plan-'), name, dateTime, notes, createdAt: new Date().toISOString() };
                this.entries.push(newEntry);
                this.sortEntries();
                this.save();
                return `Event "${name}" added to planner for ${new Date(dateTime).toLocaleString()}.`;
            },
            list: function(period = "upcoming") {
                if (this.entries.length === 0) return "Your planner is empty.";
                const now = new Date();
                let filteredEntries;
                let title = "";

                if (period === "today") {
                    title = "Today's Plan";
                    filteredEntries = this.entries.filter(e => new Date(e.dateTime).toDateString() === now.toDateString());
                } else if (period === "tomorrow") {
                    title = "Tomorrow's Plan";
                    const tomorrow = new Date(now);
                    tomorrow.setDate(now.getDate() + 1);
                    filteredEntries = this.entries.filter(e => new Date(e.dateTime).toDateString() === tomorrow.toDateString());
                } else { // upcoming (default)
                    title = "Upcoming Events";
                    filteredEntries = this.entries.filter(e => new Date(e.dateTime) >= now);
                }
                
                if (filteredEntries.length === 0) return `No events scheduled for ${period}.`;
                let response = `**${title}**:\n`;
                filteredEntries.slice(0, 10).forEach(entry => { // Show max 10
                    response += `- **${entry.name}** at ${new Date(entry.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} on ${new Date(entry.dateTime).toLocaleDateString()}\n`;
                    if (entry.notes) response += `  _Notes: ${entry.notes}_\n`;
                });
                if (filteredEntries.length > 10) response += "...and more.\n";
                return response;
            },
            getNext: function() {
                const now = new Date();
                const upcoming = this.entries.filter(e => new Date(e.dateTime) >= now).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
                if (upcoming.length === 0) return "No upcoming events in your planner.";
                const nextEvent = upcoming[0];
                return `Next up: **${nextEvent.name}** at ${new Date(nextEvent.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} on ${new Date(nextEvent.dateTime).toLocaleDateString()}.`;
            },
            _performDelete: function(entryId) {
                const index = this.entries.findIndex(e => e.id === entryId);
                if (index !== -1) {
                    const deletedEntry = this.entries.splice(index, 1)[0];
                    this.save();
                    return deletedEntry;
                }
                return null;
            },
            requestDelete: function(identifier) {
                let entryToDelete;
                const num = parseInt(identifier);
                if (!isNaN(num) && num > 0 && num <= this.entries.length) { // Assuming sorted list is presented
                    entryToDelete = this.entries.sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime))[num - 1];
                } else {
                    entryToDelete = this.entries.find(e => e.name.toLowerCase().includes(identifier.toLowerCase()) || e.id === identifier);
                }
                if (entryToDelete) {
                    botInternalState.awaitingConfirmation = { type: 'delete_planner_entry', identifier: entryToDelete.id, description: entryToDelete.name };
                    return `Delete event "${entryToDelete.name}"? (yes/no)`;
                }
                return `Event "${identifier}" not found in planner.`;
            },
            sortEntries: function() {
                this.entries.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            },
            clearAll: function() { this.entries = []; this.save(); },
            renderEntriesInModal: function() {
                if (!plannerEntriesContainer) return;
                this.sortEntries();
                plannerEntriesContainer.innerHTML = '';
                if (this.entries.length === 0) {
                    plannerEntriesContainer.innerHTML = '<p style="text-align:center; color:var(--current-text-color-darker);">No events in planner yet. Add one below!</p>';
                    return;
                }
                this.entries.forEach(entry => {
                    const item = document.createElement('div');
                    item.classList.add('planner-entry');
                    const date = new Date(entry.dateTime);

                    item.innerHTML = `
                        <div class="planner-entry-info">
                            <p class="planner-entry-name">${entry.name}</p>
                            <p class="planner-entry-datetime">${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            ${entry.notes ? `<p class="planner-entry-notes">${entry.notes}</p>` : ''}
                        </div>
                        <div class="planner-entry-actions">
                            <button data-entry-id="${entry.id}" title="Delete Event">&times;</button>
                        </div>
                    `;
                    item.querySelector('.planner-entry-actions button').addEventListener('click', (e) => {
                        const entryId = e.currentTarget.dataset.entryId;
                        const entryToDelete = this.entries.find(ev => ev.id === entryId);
                        if (entryToDelete) {
                            closeModal(plannerModal);
                            getBotResponse(`delete planner event ${entryToDelete.name}`);
                        }
                    });
                    plannerEntriesContainer.appendChild(item);
                });
            }
        },
        SimulatedComms: {
            email: { unread: 3, inbox: [{from: "Boss", subject: "Project Update", body:"Need the report by EOD."}, {from: "Newsletter", subject: "Weekly Deals", body:"Check out these offers!"}, {from:"HR", subject:"Policy Change", body:"New WFH policy effective next month."}]},
            sms: { unread: 1, inbox: [{from: "Mom", body:"Call me when you can."}]},
            whatsapp: {unread: 2, inbox: [{from: "Project Group", body:"Meeting at 3 PM?"}, {from: "Alex", body:"Dinner tonight?"}]},

            checkEmail: function() {
                if (this.email.unread === 0) return "No unread emails.";
                const lastEmail = this.email.inbox[0];
                return `You have ${this.email.unread} unread email(s). Last one from **${lastEmail.from}** about "**${lastEmail.subject}**".`;
            },
            readLastEmail: function() {
                if (this.email.inbox.length === 0) return "No emails in inbox.";
                const lastEmail = this.email.inbox[0];
                this.email.unread = Math.max(0, this.email.unread -1); // Mark as read
                return `From: **${lastEmail.from}**\nSubject: **${lastEmail.subject}**\n\n${lastEmail.body}`;
            },
            sendEmail: function(to, subject, body) {
                // Simulate sending
                return `Simulating sending email to **${to}** with subject "**${subject}**".`;
            },
            checkSms: function() {
                if (this.sms.unread === 0) return "No unread SMS messages.";
                return `You have ${this.sms.unread} unread SMS. Last one from **${this.sms.inbox[0].from}**.`;
            },
            sendSms: function(to, message) { return `Simulating sending SMS to **${to}**: "${message}".`; },
            checkWhatsapp: function() {
                if (this.whatsapp.unread === 0) return "No unread WhatsApp messages.";
                return `You have ${this.whatsapp.unread} unread WhatsApp messages. Last one from **${this.whatsapp.inbox[0].from}**.`;
            },
            summarizeMessages: function(app) {
                let summary = "";
                if (app === "email" && this.email.inbox.length > 0) summary = `Summary of emails: ${this.email.inbox.slice(0,2).map(e => `From ${e.from} about ${e.subject}`).join(', ')}.`;
                else if (app === "sms" && this.sms.inbox.length > 0) summary = `SMS Summary: ${this.sms.inbox[0].from} said "${this.sms.inbox[0].body.substring(0,30)}...".`;
                else if (app === "whatsapp" && this.whatsapp.inbox.length > 0) summary = `WhatsApp Summary: ${this.whatsapp.inbox.map(m => `${m.from}: "${m.body.substring(0,20)}..."`).join('; ')}.`;
                else return `No messages to summarize for ${app}.`;
                return summary || `Could not summarize ${app}.`;
            },
            // Simulate receiving a message to trigger auto-reply if enabled
            simulateIncomingMessage: function(appType, from, body) {
                if (!appState.fullAssistantMode || !appState.autoReplySettings[appType] || !appState.autoReplySettings[appType].enabled) return;
                const replyMsg = appState.autoReplySettings[appType].message;
                addBotMessage(`(${appType.toUpperCase()} Auto-Reply to ${from}): ${replyMsg}`, true);
            }
        },
        SimulatedCalls: {
            startCall: function(contact) {
                if (botInternalState.simulatedCallState && botInternalState.simulatedCallState.status === 'active') return `Already in a call with ${botInternalState.simulatedCallState.contact}.`;
                botInternalState.simulatedCallState = { contact, duration: 0, status: 'ringing', intervalId: null };
                setTimeout(() => { // Simulate ringing then connection
                    if (botInternalState.simulatedCallState && botInternalState.simulatedCallState.status === 'ringing') {
                        botInternalState.simulatedCallState.status = 'active';
                        botInternalState.simulatedCallState.intervalId = setInterval(() => {
                            if (botInternalState.simulatedCallState && botInternalState.simulatedCallState.status === 'active') {
                                botInternalState.simulatedCallState.duration++;
                            }
                        }, 1000);
                        addBotMessage(`Call connected with **${contact}**.`, true);
                        if (appState.fullAssistantMode) { // Simulate auto-action during call
                            setTimeout(() => addBotMessage(`(During call with ${contact}) ${appState.assistantName}: Taking notes for this call.`, true), 5000);
                        }
                    }
                }, 3000);
                return `Calling **${contact}**... (Simulated)`;
            },
            endCall: function() {
                if (!botInternalState.simulatedCallState || botInternalState.simulatedCallState.status === 'ended') return "No active call to end.";
                clearInterval(botInternalState.simulatedCallState.intervalId);
                const callDuration = botInternalState.simulatedCallState.duration;
                const contact = botInternalState.simulatedCallState.contact;
                botInternalState.simulatedCallState.status = 'ended';
                return `Call with **${contact}** ended. Duration: ${Math.floor(callDuration/60).toString().padStart(2,'0')}:${(callDuration%60).toString().padStart(2,'0')}.`;
            },
            answerCall: function() {
                // Simulate an incoming call being answered
                if (botInternalState.simulatedCallState && botInternalState.simulatedCallState.status === 'active') return "Already in a call.";
                 botInternalState.simulatedCallState = { contact: "Unknown Caller", duration: 0, status: 'active', intervalId: setInterval(() => {
                    if (botInternalState.simulatedCallState && botInternalState.simulatedCallState.status === 'active') {
                        botInternalState.simulatedCallState.duration++;
                    }
                }, 1000) };
                return "Call answered. (Simulated)";
            },
            status: function() {
                if (botInternalState.simulatedCallState && botInternalState.simulatedCallState.status === 'active') {
                     const cs = botInternalState.simulatedCallState;
                     return `Currently in a call with **${cs.contact}**. Duration: ${Math.floor(cs.duration/60).toString().padStart(2,'0')}:${(cs.duration%60).toString().padStart(2,'0')}.`;
                }
                return "No active call.";
            }
        },
        SimulatedDevices: {
            devices: {
                "living_room_light": { name: "Living Room Light", state: false, type: "toggle", area: "living room" },
                "office_fan": { name: "Office Fan", state: false, type: "toggle", area: "office" },
                "music_player": { name: "Music Player", state: "stopped", song: null, type: "media", area: "system" },
                "main_door_lock": { name: "Main Door Lock", state: true, type: "toggle", area: "security" },
                "thermostat": { name: "Thermostat", state: { current: 20, target: 20, mode: "off" }, type: "thermo", area: "hvac"},
                "smart_tv": { name: "Smart TV", state: "off", channel: null, type: "media_device", area: "living room" },
                "robot_vacuum": { name: "Robot Vacuum", state: "docked", type: "appliance", area: "house" }
            },
            init: function(loadedDevices) {
                if (loadedDevices) {
                    // Deep merge for nested states like thermostat
                    for (const key in loadedDevices) {
                        if (this.devices[key] && typeof this.devices[key].state === 'object' && typeof loadedDevices[key].state === 'object') {
                             this.devices[key].state = { ...this.devices[key].state, ...loadedDevices[key].state };
                             this.devices[key].name = loadedDevices[key].name || this.devices[key].name;
                             this.devices[key].type = loadedDevices[key].type || this.devices[key].type;
                             this.devices[key].area = loadedDevices[key].area || this.devices[key].area;
                        } else {
                            this.devices[key] = loadedDevices[key];
                        }
                    }
                }
                this.renderControlsInModal();
            },
            save: function() { 
                saveData(KEYS.SIMULATED_DEVICES, this.devices);
                this.renderControlsInModal();
            },
            toggleDevice: function(deviceId, targetState = null) { 
                const device = this.devices[deviceId];
                if (!device || device.type !== "toggle") return `Device ${deviceId} not found or not a toggleable device.`;
                
                let newState;
                if (targetState !== null) {
                    if (deviceId.includes("lock")) {
                        newState = (targetState === "lock");
                    } else {
                        newState = (targetState === "on");
                    }
                } else {
                    newState = !device.state;
                }

                if (device.state === newState) {
                     const currentStatus = deviceId.includes("lock") ? (device.state ? "already locked" : "already unlocked") : (device.state ? "already on" : "already off");
                     return `${device.name} is ${currentStatus}.`;
                }
                device.state = newState;
                this.save();
                const action = deviceId.includes("lock") ? (device.state ? "locked" : "unlocked") : (device.state ? "on" : "off");
                return `${device.name} turned ${action}.`;
            },
            controlMusic: function(action, song = null) {
                const device = this.devices["music_player"];
                if (!device) return "Music player not available.";
                let reply = "";
                if (action === "play") {
                    if (device.state === "playing" && song && device.song && device.song.toLowerCase() === song.toLowerCase()) {
                        reply = `Already playing ${device.song}.`;
                    } else {
                        device.state = "playing";
                        device.song = song || "an unknown track";
                        reply = `Playing ${device.song} on ${device.name}. (Simulated)`;
                    }
                } else if (action === "stop") {
                    if (device.state === "stopped") {
                        reply = `${device.name} is already stopped.`;
                    } else {
                        device.state = "stopped";
                        reply = `${device.name} stopped.`;
                        device.song = null;
                    }
                } else if (action === "pause") {
                    if (device.state === "playing") {
                        device.state = "paused";
                        reply = `${device.name} paused.`;
                    } else {
                        reply = `${device.name} is not playing or already paused.`;
                    }
                } else {
                    reply = `Unknown music command: ${action}.`;
                }
                this.save();
                return reply;
            },
            controlThermostat: function(targetTemp) {
                const device = this.devices["thermostat"];
                if (!device) return "Thermostat not available.";
                const temp = parseInt(targetTemp);
                if (isNaN(temp)) return "Invalid temperature for thermostat.";
                device.state.target = temp;
                device.state.mode = temp > device.state.current ? "heating" : (temp < device.state.current ? "cooling" : "idle");
                this.save();
                return `Thermostat set to ${temp}C. Mode: ${device.state.mode}. (Simulated)`;
            },
            controlSmartTV: function(action, channel = null) {
                const device = this.devices["smart_tv"];
                if (!device) return "Smart TV not available.";
                if (action === "on") {
                    device.state = "on";
                    device.channel = channel || "Default Channel";
                    this.save();
                    return `Smart TV turned on, channel: ${device.channel}. (Simulated)`;
                } else if (action === "off") {
                    device.state = "off";
                    device.channel = null;
                    this.save();
                    return `Smart TV turned off.`;
                }
                return `Unknown command for Smart TV.`;
            },
            controlRobotVacuum: function(action) {
                const device = this.devices["robot_vacuum"];
                if (!device) return "Robot Vacuum not available.";
                if (action === "start") {
                    device.state = "cleaning";
                    this.save();
                    return "Robot Vacuum started cleaning. (Simulated)";
                } else if (action === "dock" || action === "stop") {
                    device.state = "docked";
                    this.save();
                    return "Robot Vacuum returning to dock. (Simulated)";
                }
                return `Unknown command for Robot Vacuum.`;
            },
            getStatus: function() {
                let statusReport = "**Simulated Environment Status**:\n";
                for (const id in this.devices) {
                    const device = this.devices[id];
                    statusReport += `- **${device.name}**: `;
                    if (device.type === "toggle") {
                        const action = id.includes("lock") ? (device.state ? "Locked" : "Unlocked") : (device.state ? "ON" : "OFF");
                        statusReport += action;
                    } else if (device.type === "media") { // Music Player
                        statusReport += `${device.state.charAt(0).toUpperCase() + device.state.slice(1)}`;
                        if (device.state === "playing" && device.song) {
                            statusReport += ` ("${device.song}")`;
                        }
                    } else if (device.type === "thermo") {
                        statusReport += `Target ${device.state.target}C, Mode ${device.state.mode}. (Current ${device.state.current}C)`;
                    } else if (device.type === "media_device") { // Smart TV
                        statusReport += `${device.state.toUpperCase()}`;
                        if (device.state === "on" && device.channel) statusReport += ` (Channel: ${device.channel})`;
                    } else if (device.type === "appliance") { // Robot Vacuum
                        statusReport += `${device.state.charAt(0).toUpperCase() + device.state.slice(1)}`;
                    }
                    statusReport += "\n";
                }
                return statusReport;
            },
            getSystemDiagnostics: function() {
                const cpu = Math.floor(Math.random() * 40) + 10; 
                const ram = Math.floor(Math.random() * 50) + 20; 
                const temp = Math.floor(Math.random() * 20) + 35; 
                return `**System Diagnostics**:\n- CPU Load: ${cpu}%\n- Memory Usage: ${ram}%\n- Core Temperature: ${temp}C\n- Network: Stable, 1Gbps\n- All subsystems nominal.`;
            },
            renderControlsInModal: function() {
                if (!simulatedDevicesContainer) return;
                simulatedDevicesContainer.innerHTML = ''; 

                for (const id in this.devices) {
                    const device = this.devices[id];
                    const button = document.createElement('button');
                    button.classList.add('action-button');
                    button.dataset.deviceId = id;
                    button.style.fontSize = "0.85em";

                    let displayText = "";
                    if (device.type === "toggle") {
                        let actionText, currentStatusText;
                        if (id.includes("lock")) {
                            actionText = device.state ? "Unlock" : "Lock";
                            currentStatusText = device.state ? "(Locked)" : "(Unlocked)";
                        } else {
                            actionText = device.state ? "Turn Off" : "Turn On";
                            currentStatusText = device.state ? "(ON)" : "(OFF)";
                        }
                        displayText = `${actionText} ${device.name} <span style="opacity:0.7;font-size:0.9em;">${currentStatusText}</span>`;
                        button.addEventListener('click', () => {
                            const response = this.toggleDevice(id);
                            addBotMessage(`${appState.assistantName}: ${response}`, true); 
                        });
                    } else if (device.type === "media" && id === "music_player") {
                         displayText = `${device.name}: ${device.state.charAt(0).toUpperCase() + device.state.slice(1)} ${device.song ? ' ("'+device.song+'")' : ''}`;
                         button.disabled = true; 
                    } else if (device.type === "thermo") {
                        displayText = `${device.name}: ${device.state.target}C (${device.state.mode}) <span style="opacity:0.7;font-size:0.9em;">(Current ${device.state.current}C)</span>`;
                        button.addEventListener('click', () => {
                             const newTemp = prompt(`Set new target temperature for ${device.name} (current ${device.state.current}C):`, device.state.target);
                             if (newTemp !== null && !isNaN(parseInt(newTemp))) {
                                 const response = this.controlThermostat(newTemp);
                                 addBotMessage(`${appState.assistantName}: ${response}`, true);
                             }
                        });
                    } else if (device.type === "media_device") { // Smart TV
                        displayText = `${device.state === 'on' ? 'Turn Off' : 'Turn On'} ${device.name} ${device.state === 'on' ? `(Ch: ${device.channel})` : ''}`;
                         button.addEventListener('click', () => {
                             const action = device.state === 'on' ? 'off' : 'on';
                             const response = this.controlSmartTV(action, device.state === 'off' ? 'News Channel' : null);
                             addBotMessage(`${appState.assistantName}: ${response}`, true);
                         });
                    } else if (device.type === "appliance") { // Robot Vacuum
                        displayText = `${device.state === 'cleaning' ? 'Dock' : 'Start'} ${device.name} <span style="opacity:0.7;font-size:0.9em;">(${device.state})</span>`;
                         button.addEventListener('click', () => {
                             const action = device.state === 'cleaning' ? 'dock' : 'start';
                             const response = this.controlRobotVacuum(action);
                             addBotMessage(`${appState.assistantName}: ${response}`, true);
                         });
                    }
                    button.innerHTML = displayText;
                    simulatedDevicesContainer.appendChild(button);
                }
            }
        }
    };

    // --- Speech Recognition Setup (FOR CHAT UI) ---
    function setupSpeechRecognition() {
        const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognitionAPI) {
            micBtn.disabled = true;
            micBtn.title = "Voice input not supported by your browser.";
            console.warn("Chat Speech Recognition not supported.");
            return;
        }
        speechRecognition = new SpeechRecognitionAPI();
        speechRecognition.continuous = false; 
        speechRecognition.lang = navigator.language || 'en-US';
        speechRecognition.interimResults = true; 

        speechRecognition.onstart = () => {
            botInternalState.isListening = true;
            micBtn.classList.add('listening');
            if (dynamicOrbElement) { 
                dynamicOrbElement.classList.remove('orb-thinking');
                dynamicOrbElement.classList.add('orb-listening');
            }
            botInternalState.isEdgeGlowNeededByMic = true;
            updateEdgeGlow();
            if (appState.ttsEnabled && window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
        };

        speechRecognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            userInputEditable.textContent = finalTranscript || interimTranscript; 
        };

        speechRecognition.onerror = (event) => {
            console.error('Chat speech recognition error:', event.error);
            let errorMsg = "Voice input error.";
            if (event.error === 'no-speech') errorMsg = "No speech detected. Try again.";
            else if (event.error === 'audio-capture') errorMsg = "Microphone error. Check permissions.";
            else if (event.error === 'not-allowed') errorMsg = "Microphone permission denied.";
            else if (event.error === 'network') errorMsg = "Network error for voice input.";
            addBotMessage(errorMsg, true);
        };

        speechRecognition.onend = () => {
            botInternalState.isListening = false;
            micBtn.classList.remove('listening');
            if (dynamicOrbElement) dynamicOrbElement.classList.remove('orb-listening');
            botInternalState.isEdgeGlowNeededByMic = false;
            updateEdgeGlow();
        };
    }


    // --- Aura Live Mode Functions ---
    function setupLiveModeCanvas() {
        const liveContainer = document.querySelector('.aura-live-mode-container');
        if (liveAudioCanvas && liveContainer) {
            liveAudioCanvas.width = liveContainer.clientWidth * 0.95; 
            liveAudioCanvas.height = liveContainer.clientHeight * 0.50; 
        }
    }

    async function startAuraLiveMode() {
        if (botInternalState.isLiveModeActive) return;
        botInternalState.isLiveModeActive = true;
        botInternalState.botIsSpeakingLive = false; 

        if (speechRecognition && botInternalState.isListening) {
            speechRecognition.stop();
        }
        micBtn.disabled = true; 

        aiAssistantWrapper.classList.add('hidden-by-live-mode');
        auraLiveModeOverlay.classList.remove('hidden');
        auraLiveModeOverlay.classList.add('visible');
        
        setupLiveModeCanvas(); 
        liveRecognizedSpeechEl.innerHTML = "Initializing audio feed...";
        liveStatusTextEl.textContent = "STATUS: INITIALIZING";

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('getUserMedia not supported for Live Mode!');
            liveStatusTextEl.textContent = "ERROR: AUDIO INPUT UNSUPPORTED";
            liveRecognizedSpeechEl.innerHTML = "Your browser does not support live audio input.";
            return;
        }

        try {
            liveMicrophoneStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            liveAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            liveAnalyser = liveAudioContext.createAnalyser();
            const source = liveAudioContext.createMediaStreamSource(liveMicrophoneStream);
            
            source.connect(liveAnalyser);

            liveAnalyser.fftSize = 2048;
            liveBufferLength = liveAnalyser.frequencyBinCount;
            liveDataArray = new Uint8Array(liveBufferLength);
            
            liveStatusTextEl.textContent = "STATUS: AUDIO CHANNEL OPEN";
            drawLiveWave();
            setupLiveSpeechRecognition();

        } catch (err) {
            console.error('Error accessing microphone for Live Mode:', err);
            liveStatusTextEl.textContent = "ERROR: MICROPHONE ACCESS DENIED";
            liveRecognizedSpeechEl.innerHTML = `Mic Error: ${err.message}. Check permissions.`;
             if (appState.fullAssistantMode && err.name === "NotAllowedError") {
                addBotMessage(`${appState.assistantName}: Microphone access was denied. I cannot enter Live Mode without it. Please grant permission if you'd like to use this feature.`, true);
            }
        }
    }

    function drawLiveWave() {
        if (!botInternalState.isLiveModeActive || !liveAnalyser || !liveAudioCanvas) return;
        liveAnimationId = requestAnimationFrame(drawLiveWave);
        
        liveAnalyser.getByteTimeDomainData(liveDataArray);
        const liveCtx = liveAudioCanvas.getContext('2d');

        liveCtx.fillStyle = 'rgba(10, 15, 24, 0.15)'; 
        liveCtx.fillRect(0, 0, liveAudioCanvas.width, liveAudioCanvas.height);

        liveCtx.lineWidth = 2.5;
        liveCtx.strokeStyle = getComputedStyle(root).getPropertyValue('--live-accent-color').trim();
        liveCtx.beginPath();

        const sliceWidth = liveAudioCanvas.width * 1.0 / liveBufferLength;
        let x = 0;

        for (let i = 0; i < liveBufferLength; i++) {
            const v = liveDataArray[i] / 128.0; 
            const y = v * liveAudioCanvas.height / 2;

            if (i === 0) liveCtx.moveTo(x, y);
            else liveCtx.lineTo(x, y);
            
            x += sliceWidth;
        }

        liveCtx.lineTo(liveAudioCanvas.width, liveAudioCanvas.height / 2);
        liveCtx.stroke();
        
        for(let i=0; i < 2; i++) {
            liveCtx.fillStyle = `rgba(0, 224, 176, ${Math.random() * 0.4 + 0.15})`;
            liveCtx.beginPath();
            liveCtx.arc(Math.random() * liveAudioCanvas.width, Math.random() * liveAudioCanvas.height, Math.random() * 1.2 + 0.4, 0, Math.PI * 2);
            liveCtx.fill();
        }
    }

    function setupLiveSpeechRecognition() {
        const SpeechRecognitionAPI_Live = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognitionAPI_Live) {
            liveRecognition = new SpeechRecognitionAPI_Live();
            liveRecognition.continuous = true;
            liveRecognition.interimResults = true;
            liveRecognition.lang = navigator.language || 'en-US';

            liveRecognition.onstart = () => {
                if (liveStatusTextEl && !botInternalState.botIsSpeakingLive) liveStatusTextEl.textContent = "STATUS: LIVE TRANSCRIPTION ACTIVE";
            };

            liveRecognition.onresult = (event) => {
                if (botInternalState.botIsSpeakingLive) return; 

                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                let displayHtml = "";
                if (finalTranscript) displayHtml += `<span class="live-user-speech">You: ${finalTranscript}</span>`;
                if (interimTranscript) displayHtml += (finalTranscript ? "<br>" : "") + `<span class="live-user-speech" style="opacity:0.6;">${interimTranscript}</span>`;
                liveRecognizedSpeechEl.innerHTML = displayHtml || "<i>Listening...</i>";


                if (finalTranscript.trim() && !botInternalState.botIsSpeakingLive) {
                    const userFinalInput = finalTranscript.trim();
                    
                    const userMsgData = { id: generateId('usr-live-'), text: userFinalInput, sender: 'user', timestamp: new Date().toISOString(), edited: false };
                    chatHistory.push(userMsgData);
                    saveData(KEYS.CHAT_HISTORY, chatHistory);
                    
                    liveRecognizedSpeechEl.innerHTML = `<span class="live-user-speech">You: ${userFinalInput}</span><br><i>${appState.assistantName} processing...</i>`;
                    getBotResponse(userFinalInput); 
                }
            };

            liveRecognition.onerror = (event) => {
                console.error('Live speech recognition error:', event.error, event.message);
                if (liveRecognizedSpeechEl) liveRecognizedSpeechEl.innerHTML = `<span style="color:red;">Speech Error: ${event.error}</span>`;
                if (liveStatusTextEl) {
                    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                         liveStatusTextEl.textContent = "ERROR: SPEECH PERMISSION DENIED";
                    } else if (event.error === 'no-speech' && botInternalState.isLiveModeActive && !botInternalState.botIsSpeakingLive) {
                        liveStatusTextEl.textContent = "STATUS: NO SPEECH DETECTED";
                    } else {
                        liveStatusTextEl.textContent = "ERROR: SPEECH RECOGNITION";
                    }
                }
            };

            liveRecognition.onend = () => {
                if (botInternalState.isLiveModeActive && !botInternalState.botIsSpeakingLive) {
                     if(liveStatusTextEl) liveStatusTextEl.textContent = "STATUS: REINITIALIZING TRANSCRIPTION...";
                     setTimeout(() => { 
                         if(liveRecognition && botInternalState.isLiveModeActive && !botInternalState.botIsSpeakingLive) {
                             try { liveRecognition.start(); } catch(e) { console.error("Error restarting live recognition onend:", e)}
                         }
                     }, 250); 
                } 
            };
            
            try { liveRecognition.start(); } catch(e) { console.error("Error initially starting live recognition:", e); liveStatusTextEl.textContent = "ERROR: COULD NOT START SPEECH REC."; }
        } else {
            liveRecognizedSpeechEl.innerHTML = "Live speech transcription not supported by your browser.";
            liveStatusTextEl.textContent = "ERROR: SPEECH API UNAVAILABLE";
        }
    }

    function stopAuraLiveMode() {
        if (!botInternalState.isLiveModeActive) return;
        
        if (liveAnimationId) cancelAnimationFrame(liveAnimationId);
        
        botInternalState.botIsSpeakingLive = false; 
        if (window.speechSynthesis && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }

        if (liveRecognition) {
            liveRecognition.onstart = null;
            liveRecognition.onresult = null;
            liveRecognition.onerror = null;
            liveRecognition.onend = null; 
            try { liveRecognition.stop(); } catch(e) { console.error("Error during liveRecognition.stop() in stopAuraLiveMode:", e); }
            liveRecognition = null;
        }
        
        if (liveMicrophoneStream) {
            liveMicrophoneStream.getTracks().forEach(track => track.stop());
            liveMicrophoneStream = null;
        }
        if (liveAudioContext && liveAudioContext.state !== 'closed') {
            liveAudioContext.close().catch(e => console.error("Error closing live audio context:", e));
            liveAudioContext = null;
        }
        liveAnalyser = null;
        
        auraLiveModeOverlay.classList.remove('visible');
        auraLiveModeOverlay.classList.add('hidden');
        aiAssistantWrapper.classList.remove('hidden-by-live-mode');

        botInternalState.isLiveModeActive = false;
        micBtn.disabled = false; 
        if (liveStatusTextEl) liveStatusTextEl.textContent = "STATUS: TERMINATED";
        addBotMessage("Exited Aura Live Mode.", true); 
    }


    // --- Initialization ---
    function initApp() {
        loadAppState(); applyTheme(); applySettingsToUI();
        setupSpeechRecognition(); 

        Modules.Task.init(loadData(KEYS.TASKS, [])); 
        Modules.Reminder.init(loadData(KEYS.REMINDERS, [])); 
        Modules.Note.init(loadData(KEYS.NOTES, []));
        Modules.Planner.init(loadData(KEYS.PLANNER_ENTRIES, []));
        Modules.Pomodoro.init(loadData(KEYS.POMODORO_SETTINGS, null));
        Modules.MoodJournal.init(loadData(KEYS.MOOD_ENTRIES, []));
        Modules.Memory.init(loadData(KEYS.LONG_TERM_MEMORY, {}));
        Modules.CodeSnippets.init(loadData(KEYS.CODE_SNIPPETS, []));
        Modules.SimulatedDevices.init(loadData(KEYS.SIMULATED_DEVICES, null));
        
        chatHistory = loadData(KEYS.CHAT_HISTORY, []);
        
        if (typeof window.speechSynthesis !== 'undefined') {
            populateVoices(); 
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = populateVoices;
            }
        }

        const today = new Date().toLocaleDateString();
        let dailyBriefingAttempted = false;

        if (appState.isPersonalized && appState.lastOpenedDate !== today) {
            handleDailyBriefing(); 
            dailyBriefingAttempted = true;
        } else if (appState.isPersonalized) { 
            Modules.Reminder.checkAndNotifyDueReminders();
        }
        appState.lastOpenedDate = today; 
        saveAppState(); 

        if (chatHistory.length > 0 && !dailyBriefingAttempted) { 
            initialPromptArea.classList.add('hidden'); 
            chatHistory.forEach(msg => renderMessage(msg, false)); 
            scrollToBottom('auto'); 
        } else if (!dailyBriefingAttempted && chatHistory.length === 0) { 
             updateInitialPrompt(); 
        }
        
        if (!appState.isPersonalized) { openModal(personalizationModal); }
        
        setupEventListeners(); 
        updateScrollButtonsVisibility();
        updateEdgeGlow(); 
    }

    async function handleDailyBriefing() {
        let greeting = `Good morning`; const hour = new Date().getHours(); if (hour >= 12 && hour < 17) greeting = `Good afternoon`; else if (hour >= 17) greeting = `Good evening`;
        let briefing = `${greeting}, ${appState.userName || 'User'}! Welcome back to ${appState.assistantName}.\n`;
        briefing += `Today is ${new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.\n`;
        
        const lastQuoteDate = loadData(KEYS.LAST_QUOTE_FETCH_DATE, null);
        const todayDateStr = new Date().toLocaleDateString();
        if (lastQuoteDate !== todayDateStr) {
            try {
                const quoteResponse = await fetch("https://api.quotable.io/random");
                if (quoteResponse.ok) {
                    const quoteData = await quoteResponse.json();
                    briefing += `\n**Quote of the Day:**\n_"${quoteData.content}"_ - ${quoteData.author}\n`;
                    saveData(KEYS.LAST_QUOTE_FETCH_DATE, todayDateStr);
                } else {
                    console.warn("Failed to fetch quote, API status: ", quoteResponse.status);
                }
            } catch (error) { console.error("Failed to fetch quote:", error); }
        }

        const activeTasks = Modules.Task.tasks.filter(t => !t.completed);
        if (activeTasks.length > 0) { briefing += `\nYou have ${activeTasks.length} active task${activeTasks.length === 1 ? '' : 's'}.`; } 
        else { briefing += "\nYou have no active tasks.\n"; }

        const upcomingEventsToday = Modules.Planner.entries.filter(e => new Date(e.dateTime).toDateString() === new Date().toDateString() && new Date(e.dateTime) >= new Date());
        if (upcomingEventsToday.length > 0) {
            briefing += `\nYou have ${upcomingEventsToday.length} event(s) on your planner for today. First up: **${upcomingEventsToday[0].name}** at ${new Date(upcomingEventsToday[0].dateTime).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'})}.\n`;
        } else {
            briefing += "\nYour planner is clear for the rest of today.\n";
        }

        const pendingReminders = Modules.Reminder.reminders.filter(r => !r.acknowledged);
        if (pendingReminders.length > 0) { briefing += `\nYou have ${pendingReminders.length} pending reminder${pendingReminders.length === 1 ? '' : 's'}.`; }
        Modules.Reminder.checkAndNotifyDueReminders();
        addBotMessage(briefing, chatHistory.length === 0);

        // Simulate incoming message if full assistant mode is on
        if (appState.fullAssistantMode) {
            setTimeout(() => Modules.SimulatedComms.simulateIncomingMessage('email', 'New Subscription', 'Welcome to Our Service!'), 5000);
        }
    }

    // --- Load/Save App State, Theme, UI Updates ---
    function loadAppState() { const loadedState = loadData(KEYS.APP_STATE, {}); appState = { ...appState, ...loadedState, autoReplySettings: { ...appState.autoReplySettings, ...(loadedState.autoReplySettings || {}) } }; assistantNameDisplay.textContent = appState.assistantName; } // Ensure autoReplySettings is merged
    function saveAppState() { saveData(KEYS.APP_STATE, appState); }
    function applyTheme() { const themePrefix = appState.isLightTheme ? 'light' : 'dark'; const cssVarMap = [ 'bg-image', 'glass-bg', 'glass-border', 'text-color', 'text-color-darker', 'accent-color', 'accent-color-hover', 'accent-glow', 'input-bg', 'suggestion-bg', 'suggestion-text', 'shadow-main', 'shadow-inset', 'bot-message-bg', 'user-message-text' ]; cssVarMap.forEach(v => { root.style.setProperty(`--current-${v}`, `var(--${v}-${themePrefix})`); }); const accent = getComputedStyle(root).getPropertyValue(`--accent-color-${themePrefix}`).trim(); root.style.setProperty('--orb-grad-start', `color-mix(in srgb, ${accent} 60%, #fff)`); root.style.setProperty('--orb-grad-mid', accent); root.style.setProperty('--orb-grad-end', `color-mix(in srgb, ${accent} 70%, #000)`); themeIconMoon.style.display = appState.isLightTheme ? 'none' : 'block'; themeIconSun.style.display = appState.isLightTheme ? 'block' : 'none'; updateEdgeGlow(); }
    function toggleTheme() { appState.isLightTheme = !appState.isLightTheme; applyTheme(); saveAppState(); }
    function updateEdgeGlow() { if (!aiAssistantWrapper) return; if ((botInternalState.isEdgeGlowNeededByMic || botInternalState.isEdgeGlowNeededByBot) && !botInternalState.isLiveModeActive ) { aiAssistantWrapper.classList.add('edge-glow-active'); } else { aiAssistantWrapper.classList.remove('edge-glow-active'); } }
    function applySettingsToUI() { showTimestampsSetting.checked = appState.showTimestamps; showTypingIndicatorSetting.checked = appState.showTypingIndicator; enableTtsSetting.checked = appState.ttsEnabled; enableReminderNotificationsSetting.checked = appState.reminderNotificationsEnabled; botPersonalitySetting.value = appState.botPersonality; fullAssistantModeSetting.checked = appState.fullAssistantMode; document.querySelectorAll('.message-meta').forEach(meta => { meta.style.display = appState.showTimestamps ? 'block' : 'none'; });}
    function updateInitialPrompt() { if (chatHistory.length > 0 && initialPromptArea.classList.contains('hidden')) return; let prompt = `How can ${appState.assistantName} assist you today`; if (appState.userName) { prompt += `, ${appState.userName}?`; } else { prompt += "?"; } initialPromptText.textContent = prompt; userInputEditable.dataset.placeholder = `Ask ${appState.assistantName || 'Aura Intelligence'} anything...`; if (initialPromptArea.classList.contains('hidden') && chatHistory.length === 0) { initialPromptArea.classList.remove('hidden'); } }
    
    // --- Message Handling ---
    function parseMarkdown(text) { 
        if (typeof text !== 'string') text = String(text); 
        let html = text; 
        const tempDiv = document.createElement('div'); 
        tempDiv.textContent = text; 
        html = tempDiv.innerHTML; 
        html = html.replace( /\[Attached File: (.*?) \((.*?),\s*(.*?)\)\](<br\s*\/?>\s*<img src="data:image\/[^;]+;base64,[^"]+" alt="Preview">)?(<br\s*\/?>\s*File Content Preview:<br\s*\/?>([\s\S]*?))?/g, (match, fileName, fileType, fileSize, imgTag, contentBlock, fileContent) => { let attachmentHtml = `<div class="file-attachment-info"><strong>Attached File:</strong> ${fileName} (${fileType}, ${fileSize})</div>`; if (imgTag) { attachmentHtml += `<div class="file-attachment-preview">${imgTag.replace(/&lt;/g, "<").replace(/&gt;/g, ">")}</div>`; } if (fileContent) { const escapedFileContent = fileContent.replace(/</g, "&lt;").replace(/>/g, "&gt;"); attachmentHtml += `<div class="file-content-preview">${escapedFileContent}</div>`; } return attachmentHtml; } );
        html = html.replace(/```(\w*\n)?([\s\S]*?)```/g, (match, lang, code) => { const languageClass = lang ? `language-${lang.trim().toLowerCase()}` : ''; const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;"); return `<pre><code class="${languageClass}">${escapedCode.trim()}</code></pre>`; }); 
        html = html.replace(/`([^`]+?)`/g, '<code>$1</code>'); 
        html = html.replace(/\*\*(.*?)\*\*|\_\_(.*?)\_\_/g, '<strong>$1$2</strong>'); 
        html = html.replace(/\*(.*?)\*|\_(.*?)\_/g, '<em>$1$2</em>'); 
        html = html.replace(/\~\~(.*?)\~\~/g, '<del>$1</del>'); 
        html = html.replace(/^\s*([-*+])\s+(.*)/gm, '<li>$2</li>'); 
        html = html.replace(/(\<\/li\>\s*)+<li>/g, '</li><li>'); 
        html = html.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match.trim()}</ul>`); 
        html = html.replace(/^\s*(\d+\.)\s+(.*)/gm, '<li data-ordered="true">$2</li>'); 
        html = html.replace(/(<li data-ordered="true">.*?<\/li>\s*)+/g, (match) => `<ol>${match.replace(/data-ordered="true"/g, '').trim()}</ol>`); 
        html = html.replace(/\n/g, '<br>'); 
        return html; 
    }

    function renderMessage(messageData, animate = true) { if (!initialPromptArea.classList.contains('hidden')) { initialPromptArea.classList.add('hidden'); } const { id, text, sender, timestamp, edited } = messageData; const messageContainer = document.createElement('div'); messageContainer.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message'); messageContainer.dataset.messageId = id; const messageContentDiv = document.createElement('div'); messageContentDiv.classList.add('message-content'); messageContentDiv.innerHTML = parseMarkdown(text); messageContainer.appendChild(messageContentDiv); if (appState.showTimestamps) { const displayTime = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); const metaSpan = document.createElement('span'); metaSpan.classList.add('message-meta'); metaSpan.textContent = displayTime + (edited ? " (edited)" : ""); messageContainer.appendChild(metaSpan); } const actionsContainer = document.createElement('div'); actionsContainer.classList.add('message-actions'); const copyBtn = document.createElement('button'); copyBtn.title = 'Copy message'; copyBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg><span class="copy-feedback">Copied!</span>`; copyBtn.addEventListener('click', (e) => { e.stopPropagation(); navigator.clipboard.writeText(text).then(() => { copyBtn.classList.add('copied'); setTimeout(() => copyBtn.classList.remove('copied'), 1500); }).catch(err => console.error('Failed to copy: ', err)); }); actionsContainer.appendChild(copyBtn); if (sender === 'user') { const editBtn = document.createElement('button'); editBtn.title = 'Edit message'; editBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`; editBtn.addEventListener('click', (e) => { e.stopPropagation(); initEditMessage(id, text); }); actionsContainer.appendChild(editBtn); } messageContainer.appendChild(actionsContainer); chatLog.appendChild(messageContainer); if (animate) { messageContainer.classList.add('entering'); requestAnimationFrame(() => requestAnimationFrame(() => messageContainer.classList.remove('entering'))); } if (animate || chatWindow.scrollTop + chatWindow.clientHeight >= chatWindow.scrollHeight - 150) { scrollToBottom(animate ? 'smooth' : 'auto'); } updateScrollButtonsVisibility(); }
    
    function addUserMessage(text) {
        if (botInternalState.isLiveModeActive) {
            const mD = { id: generateId('usr-live-'), text, sender: 'user', timestamp: new Date().toISOString(), edited: false };
            chatHistory.push(mD);
            saveData(KEYS.CHAT_HISTORY, chatHistory);
        } else {
            const mD = { id: generateId('usr-'), text, sender: 'user', timestamp: new Date().toISOString(), edited: false };
            chatHistory.push(mD);
            saveData(KEYS.CHAT_HISTORY, chatHistory);
            renderMessage(mD);
        }
    }

    function addBotMessage(text, animate = true) {
        const isExitLiveMessage = text.includes("Exited Aura Live Mode");

        if (botInternalState.isLiveModeActive && !isExitLiveMessage) {
            const mD = { id: generateId('bot-live-'), text, sender: 'bot', timestamp: new Date().toISOString(), edited: false };
            chatHistory.push(mD);
            saveData(KEYS.CHAT_HISTORY, chatHistory);
            
            if(liveRecognizedSpeechEl) liveRecognizedSpeechEl.innerHTML = `<span class="live-bot-speech">${appState.assistantName}: ${parseMarkdown(text)}</span>`;
            speakText(text); 
        } else {
            const mD = { id: generateId('bot-'), text, sender: 'bot', timestamp: new Date().toISOString(), edited: false };
            chatHistory.push(mD);
            saveData(KEYS.CHAT_HISTORY, chatHistory);
            renderMessage(mD, animate);
            
            if (!botInternalState.isLiveModeActive || isExitLiveMessage) {
                speakText(text);
            }
        }
    }

    function initEditMessage(mId, cTxt) { botInternalState.currentEditMessageId = mId; const editText = cTxt.replace(/<br\s*\/?>/gi, '\n') .replace(/<div class="file-attachment-info">.*?<\/div>/g, '') .replace(/<div class="file-attachment-preview">.*?<\/div>/g, '') .replace(/<div class="file-content-preview">.*?<\/div>/g, ''); userInputEditable.textContent = editText.trim(); userInputEditable.focus(); const range = document.createRange(); const sel = window.getSelection(); range.selectNodeContents(userInputEditable); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); sendBtn.classList.add('edit-mode'); sendBtn.title = "Update message"; sendBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>`; }
    function completeEditMessage(nTxt) { const mId=botInternalState.currentEditMessageId; const mIdx=chatHistory.findIndex(m=>m.id===mId); if(mIdx===-1)return; chatHistory[mIdx].text=nTxt; chatHistory[mIdx].timestamp=new Date().toISOString(); chatHistory[mIdx].edited=true; saveData(KEYS.CHAT_HISTORY,chatHistory); const mEl=chatLog.querySelector(`.message[data-message-id="${mId}"]`); if(mEl){mEl.querySelector('.message-content').innerHTML=parseMarkdown(nTxt); const mS=mEl.querySelector('.message-meta'); if(mS&&appState.showTimestamps){mS.textContent=new Date(chatHistory[mIdx].timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+" (edited)";}} botInternalState.currentEditMessageId=null; sendBtn.classList.remove('edit-mode'); sendBtn.title="Send message"; sendBtn.innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`;}
    function handleSendMessage() { 
        const mT = userInputEditable.textContent.trim(); 
        if (!mT) return; 
        if (botInternalState.currentEditMessageId) { completeEditMessage(mT); } 
        else { 
            addUserMessage(mT); 
            if (!botInternalState.isLiveModeActive) showTyping(); 
            getBotResponse(mT); 
        } 
        userInputEditable.textContent = ''; 
        userInputEditable.focus(); 
        if (navigator.vibrate) { navigator.vibrate(10); } 
    }
    function showTyping() { if (appState.showTypingIndicator && !botInternalState.isLiveModeActive) { typingIndicator.classList.remove('hidden'); scrollToBottom(); } botInternalState.isEdgeGlowNeededByBot = true; updateEdgeGlow(); if (dynamicOrbElement) { dynamicOrbElement.classList.remove('orb-listening'); dynamicOrbElement.classList.add('orb-thinking'); } }
    function hideTyping() { typingIndicator.classList.add('hidden'); botInternalState.isEdgeGlowNeededByBot = false; updateEdgeGlow(); if (dynamicOrbElement) { dynamicOrbElement.classList.remove('orb-thinking'); if (botInternalState.isListening) { dynamicOrbElement.classList.add('orb-listening'); } } }

    // --- Chat Search ---
    function highlightTextInMessage(messageElement, searchTerm) { const contentElement = messageElement.querySelector('.message-content'); if (!contentElement || !contentElement.textContent.toLowerCase().includes(searchTerm.toLowerCase())) { return false; } const originalHTML = contentElement.innerHTML; const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'); contentElement.innerHTML = originalHTML.replace(regex, '<span class="search-result-highlight">$1</span>'); return true; }
    function performChatSearch(term) { document.querySelectorAll('.message.search-result-highlight').forEach(el => { el.classList.remove('search-result-highlight'); const contentEl = el.querySelector('.message-content'); if (contentEl && contentEl.dataset.originalHtml) { contentEl.innerHTML = contentEl.dataset.originalHtml; delete contentEl.dataset.originalHtml; }}); if (term.trim() === '') { chatLog.querySelectorAll('.message').forEach(msg => msg.style.display = ''); scrollToBottom('auto'); return; } let firstMatch = null; chatLog.querySelectorAll('.message').forEach(msgEl => { const contentEl = msgEl.querySelector('.message-content'); if (contentEl && !contentEl.dataset.originalHtml) { contentEl.dataset.originalHtml = contentEl.innerHTML; } const hasMatch = highlightTextInMessage(msgEl, term); msgEl.style.display = hasMatch ? '' : 'none'; if (hasMatch && !firstMatch) { firstMatch = msgEl; }}); if (firstMatch) { firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' }); } else { addBotMessage(`No results found for "${term}".`, true); } }


    // --- File Attachment Handling ---
    function handleFileSelected(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (botInternalState.isLiveModeActive) { 
            addBotMessage("File attachment is not available in Live Mode. Please exit Live Mode to attach files.", true);
            fileInput.value = ''; return; 
        }

        const MAX_TEXT_FILE_SIZE = 1 * 1024 * 1024; 
        const fileName = file.name;
        const fileType = file.type || 'unknown/type';
        const fileSize = (file.size / 1024).toFixed(2) + ' KB';
        let messageText = `[Attached File: ${fileName} (${fileType}, ${fileSize})]`;
        const reader = new FileReader();
        reader.onload = (e) => {
            let previewContent = "";
            if (fileType.startsWith('image/')) {
                previewContent = `<br><div class="file-attachment-preview"><img src="${e.target.result}" alt="Preview of ${fileName}"></div>`;
                addUserMessage(messageText + previewContent); 
                getBotResponse(`User attached an image: ${fileName}.`); 
            } else if (['text/plain', 'text/markdown', 'text/csv', 'application/json', 'text/xml', 'text/html', 'text/css', 'application/javascript'].includes(fileType) || 
                       fileName.endsWith('.txt') || fileName.endsWith('.md') || fileName.endsWith('.csv') || fileName.endsWith('.json') || fileName.endsWith('.xml') || fileName.endsWith('.html') || fileName.endsWith('.css') || fileName.endsWith('.js')) {
                if (file.size > MAX_TEXT_FILE_SIZE) {
                    previewContent = `<br><div class="file-content-preview">(File content too large for preview: ${fileSize})</div>`;
                    addUserMessage(messageText + previewContent);
                    getBotResponse(`User attached a large text file: ${fileName}. Content not displayed.`);
                } else {
                    const textContent = e.target.result;
                    const escapedTextContent = textContent.replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
                    previewContent = `<br><div class="file-content-preview">${escapedTextContent}</div>`;
                    addUserMessage(messageText + previewContent); 
                    getBotResponse(`User attached text file: ${fileName}\n\nContent:\n${textContent}`);
                }
            } else {
                addUserMessage(messageText);
                getBotResponse(`User attached a file: ${fileName} (${fileType}). I can't preview its content.`);
            }
            fileInput.value = ''; 
        };
        reader.onerror = () => { addBotMessage(`Error reading file: ${fileName}.`, true); fileInput.value = ''; };
        if (fileType.startsWith('image/') || ['text/plain', 'text/markdown', 'text/csv', 'application/json', 'text/xml', 'text/html', 'text/css', 'application/javascript'].includes(fileType) || fileName.endsWith('.txt') || fileName.endsWith('.md') || fileName.endsWith('.csv') || fileName.endsWith('.json') || fileName.endsWith('.xml') || fileName.endsWith('.html') || fileName.endsWith('.css') || fileName.endsWith('.js')) {
           if (fileType.startsWith('image/')) reader.readAsDataURL(file);
           else reader.readAsText(file);
        } else {
            addUserMessage(messageText);
            getBotResponse(`User attached a file: ${fileName} (${fileType}). I can't preview its content.`);
            fileInput.value = '';
        }
    }


    // --- Bot Logic ---
    async function getBotResponse(userInput) {
        const msgLower = userInput.toLowerCase(); 
        let botReply = ""; 
        let delay = 800 + Math.random() * 700; 
        let intent = null; 
        let entities = {}; 
        let match; 
        const personalities = { 
            assistant: { greeting: () => `Hello ${appState.userName || 'there'}! How can I assist?`, thanks: () => `You're welcome, ${appState.userName || 'User'}!`, confusion: () => `I'm not sure how to respond. Try 'help'.`, }, 
            friendly: { greeting: () => `Hey ${appState.userName || 'pal'}! What's up?`, thanks: () => `No problem, ${appState.userName || 'buddy'}!`, confusion: () => `Hmm, not sure about that one. Can you rephrase or type 'help'?`, },
            formal: { greeting: () => `Good day, ${appState.userName || 'Sir/Madam'}. How may I be of service?`, thanks: () => `It is my pleasure to assist, ${appState.userName || 'Sir/Madam'}.`, confusion: () => `I regret that I do not comprehend your request. Please consult the 'help' command.`, },
            witty: { greeting: () => `${appState.userName || 'Oh, it\'s you again'}. What delightful query do you have for me now?`, thanks: () => `But of course. It's what I do. When I'm not contemplating the universe, that is.`, confusion: () => `My circuits are buzzing with... confusion. Try 'help', or perhaps a cup of tea for yourself?`, },
            jarvis: { 
                greeting: () => { const time = new Date().getHours(); let timeGreeting = "Good day"; if (time < 12) timeGreeting = "Good morning"; else if (time < 18) timeGreeting = "Good afternoon"; else timeGreeting = "Good evening"; return `${timeGreeting}, ${appState.userName || 'Sir/Madam'}. All systems are operational. How may I assist?`; }, 
                thanks: () => `Of course, ${appState.userName || 'Sir/Madam'}. At your service.`, 
                confusion: () => `I'm afraid I didn't quite catch that, ${appState.userName || 'Sir/Madam'}. Could you please rephrase, or consult the 'help' command for my capabilities?`,
                deviceAction: (deviceName, action) => `${deviceName} ${action}. Confirmed.`
            }
        };
        const currentPersonality = personalities[appState.botPersonality] || personalities.assistant;

        if (!botInternalState.isLiveModeActive) { 
            showTyping();
        }

        if (botInternalState.awaitingConfirmation && (msgLower === 'yes' || msgLower === 'yep' || msgLower === 'confirm' || msgLower === 'no' || msgLower === 'nope' || msgLower === 'cancel')) {
            const context = botInternalState.awaitingConfirmation;
            if (msgLower === 'yes' || msgLower === 'yep' || msgLower === 'confirm') {
                let success = false; let itemDesc = "";
                if (context.type === 'delete_task') { const deleted = Modules.Task._performDelete(context.identifier); if (deleted) { itemDesc = deleted.description; success = true; } botReply = success ? `Task "${itemDesc}" deleted.` : `Issue deleting task "${context.description}".`; } 
                else if (context.type === 'delete_reminder') { const deleted = Modules.Reminder._performDelete(context.identifier); if (deleted) { itemDesc = deleted.text; success = true; } botReply = success ? `Reminder "${itemDesc}" deleted.` : `Issue deleting reminder "${context.description}".`; } 
                else if (context.type === 'delete_note') { const deleted = Modules.Note._performDelete(context.identifier); if (deleted) { itemDesc = deleted.title; success = true; } botReply = success ? `Note "${itemDesc}" deleted.` : `Issue deleting note "${context.description}".`; }
                else if (context.type === 'delete_snippet') { const deleted = Modules.CodeSnippets._performDelete(context.identifier); if (deleted) { itemDesc = deleted.title; success = true; } botReply = success ? `Snippet "${itemDesc}" deleted.` : `Issue deleting snippet "${context.description}".`; }
                else if (context.type === 'delete_planner_entry') { const deleted = Modules.Planner._performDelete(context.identifier); if (deleted) { itemDesc = deleted.name; success = true; } botReply = success ? `Planner event "${itemDesc}" deleted.` : `Issue deleting event "${context.description}".`; }
                intent = 'CONFIRMED_ACTION';
            } else { botReply = `Okay, I won't ${context.type.replace('_', ' ')}: "${context.description}".`; intent = 'CANCELLED_CONFIRMATION'; }
            botInternalState.awaitingConfirmation = null; botInternalState.currentAction = null; botInternalState.actionData = {};
        }
        
        if (!intent) { 
            if (msgLower.match(/\b(cancel|nevermind|stop|forget it)\b/i) && (botInternalState.currentAction || botInternalState.awaitingConfirmation)) {
                const actionType = botInternalState.currentAction || (botInternalState.awaitingConfirmation ? botInternalState.awaitingConfirmation.type : 'current operation');
                botReply = `Okay, cancelling ${actionType.replace(/_/g, ' ')}.`;
                botInternalState.currentAction = null; botInternalState.actionData = {}; botInternalState.awaitingConfirmation = null;
                intent = 'CANCEL_ACTION';
            }
            else if (msgLower.match(/^(hey aura,? activate live mode|open aura live mode|launch live mode|start live feed|engage live interface)$/i)) { 
                intent = 'OPEN_AURA_LIVE_MODE'; 
            }
            else if (msgLower.match(/^(help|commands|what can you do)\??$/i)) { intent = 'HELP'; }
            // Task Commands
            else if (msgLower.match(/^(list tasks|show tasks|my tasks)$/i)) { intent = 'LIST_TASKS'; } 
            else if (botInternalState.currentAction === 'awaiting_task_description') { intent = 'PROVIDE_TASK_DESCRIPTION'; entities.description = userInput; } 
            else if (botInternalState.currentAction === 'awaiting_task_duedate') { intent = 'PROVIDE_TASK_DUEDATE'; entities.dueDate = (msgLower === 'none' || msgLower === 'skip') ? null : userInput; }
            else if (botInternalState.currentAction === 'awaiting_task_priority') { intent = 'PROVIDE_TASK_PRIORITY'; entities.priority = userInput; }
            else if (match = msgLower.match(/^(?:add task|new task|task:)\s*(.+?)(?:\s*(?:due|by|for)\s*([^(\s|prio)]+))?(?:\s*prio(?:rity)?:?\s*(low|medium|high|l|m|h))?$/i)) { 
                intent = 'ADD_TASK_FULL'; 
                entities.description = match[1].trim(); 
                entities.dueDate = match[2] ? match[2].trim() : null; 
                let prio = match[3] ? match[3].trim().toLowerCase() : 'medium';
                if (prio === 'l') prio = 'low'; else if (prio === 'h') prio = 'high'; else if (prio === 'm') prio = 'medium';
                entities.priority = prio;
            } 
            else if (msgLower.match(/^(add task|new task)$/i)) { intent = 'ADD_TASK_INIT'; } 
            else if (match = msgLower.match(/^(complete|finish|done) task\s*(.+)$/i)) { intent = 'COMPLETE_TASK'; entities.identifier = match[2].trim(); } 
            else if (match = msgLower.match(/^(delete|remove) task\s*(.+)$/i)) { intent = 'DELETE_TASK_REQUEST'; entities.identifier = match[2].trim(); }
            else if (match = msgLower.match(/^(set task|task priority|change task)\s*(.+?)\s*priority\s*(low|medium|high|l|m|h)$/i)) { 
                intent = 'SET_TASK_PRIORITY'; 
                entities.identifier = match[2].trim(); 
                let prio = match[3].trim().toLowerCase();
                if (prio === 'l') prio = 'low'; else if (prio === 'h') prio = 'high'; else if (prio === 'm') prio = 'medium';
                entities.priority = prio;
            }
            // Reminder Commands
            else if (msgLower.match(/^(list reminders|show reminders)$/i)) { intent = 'LIST_REMINDERS'; Modules.Reminder.checkAndNotifyDueReminders(); }
             else if (botInternalState.currentAction === 'awaiting_reminder_text') { intent = 'PROVIDE_REMINDER_TEXT'; entities.text = userInput; } else if (botInternalState.currentAction === 'awaiting_reminder_time') { intent = 'PROVIDE_REMINDER_TIME'; entities.time = userInput; } else if (match = msgLower.match(/^(?:remind me to|reminder for|set reminder)\s+(.+?)(?:\s*(?:by|on|at|for)\s*(.+))?$/i)) { intent = 'ADD_REMINDER_FULL_OR_PARTIAL'; entities.text = match[1].trim(); entities.time = match[2] ? match[2].trim() : null; } else if (msgLower.match(/^(remind me to|set reminder|new reminder)$/i)) { intent = 'ADD_REMINDER_INIT'; } else if (match = msgLower.match(/^(?:clear reminder|delete reminder)\s*(.+)$/i)) { intent = 'DELETE_REMINDER_REQUEST'; entities.identifier = match[1].trim(); }
            // Note Commands
            else if (msgLower.match(/^(list notes|show notes)$/i)) { intent = 'LIST_NOTES'; }
            else if (botInternalState.currentAction === 'awaiting_note_title') { intent = 'PROVIDE_NOTE_TITLE'; entities.title = userInput; } else if (botInternalState.currentAction === 'awaiting_note_content') { intent = 'PROVIDE_NOTE_CONTENT'; entities.content = userInput; } else if (botInternalState.currentAction === 'awaiting_note_tags') { intent = 'PROVIDE_NOTE_TAGS'; entities.tags = userInput; } else if (match = msgLower.match(/^(?:add note|new note|note)\s+([^:]+?):\s*(.+?)(?:\s*tags?:\s*(.+))?$/i)) { intent = 'ADD_NOTE_FULL'; entities.title = match[1].trim(); entities.content = match[2].trim(); entities.tags = match[3] ? match[3].trim() : ""; } else if (msgLower.match(/^(add note|new note|take a note)$/i)) { intent = 'ADD_NOTE_INIT'; } else if (match = msgLower.match(/^(?:show note|view note)\s*(.+)$/i)) { intent = 'VIEW_NOTE'; entities.identifier = match[1].trim(); } else if (match = msgLower.match(/^(delete note|remove note)\s*(.+)$/i)) { intent = 'DELETE_NOTE_REQUEST'; entities.identifier = match[1].trim(); } else if (match = msgLower.match(/^(?:list notes tagged|notes with tag)\s*(.+)$/i)) { intent = 'LIST_NOTES_BY_TAG'; entities.tag = match[1].trim(); } else if (match = msgLower.match(/^(add tag|tag note)\s*(.+?)\s*(?:to note|for note)\s*(.+)$/i)) { intent = 'ADD_TAG_TO_NOTE'; entities.tag = match[2].trim(); entities.identifier = match[3].trim(); } else if (match = msgLower.match(/^(remove tag|untag note)\s*(.+?)\s*(?:from note|for note)\s*(.+)$/i)) { intent = 'REMOVE_TAG_FROM_NOTE'; entities.tag = match[2].trim(); entities.identifier = match[3].trim(); }
            // Planner Commands
            else if (match = msgLower.match(/^(?:plan|add to planner|schedule)\s*(.+?)\s*(?:for|on|at)\s*(.+)$/i)) { intent = 'ADD_PLANNER_EVENT'; entities.name = match[1].trim(); entities.dateTime = match[2].trim(); }
            else if (match = msgLower.match(/^(show my plan|my schedule|planner for)\s*(today|tomorrow|upcoming|all)$/i)) { intent = 'LIST_PLANNER_EVENTS'; entities.period = match[1].trim(); }
            else if (msgLower.match(/^(what's next on my schedule|next event)$/i)) { intent = 'GET_NEXT_PLANNER_EVENT'; }
            else if (match = msgLower.match(/^(delete planner event|remove from planner)\s*(.+)$/i)) { intent = 'DELETE_PLANNER_EVENT_REQUEST'; entities.identifier = match[1].trim(); }
            // System & Settings
            else if (msgLower.match(/^(enable reminder notifications|turn on reminder notifications)$/i)) { intent = 'ENABLE_REMINDER_NOTIFICATIONS'; }
            else if (msgLower.match(/^(disable reminder notifications|turn off reminder notifications)$/i)) { intent = 'DISABLE_REMINDER_NOTIFICATIONS'; }
            else if (match = msgLower.match(/^(?:enable|turn on) auto-?reply for (email|sms|whatsapp)(?: with message "?(.+?)"?)?$/i)) { intent = 'ENABLE_AUTOREPLY'; entities.app = match[1]; entities.message = match[2]; }
            else if (match = msgLower.match(/^(?:disable|turn off) auto-?reply for (email|sms|whatsapp)$/i)) { intent = 'DISABLE_AUTOREPLY'; entities.app = match[1]; }
            else if (match = msgLower.match(/^(?:enable|turn on|activate) full assistant mode$/i)) { intent = 'SET_FULL_ASSISTANT_MODE'; entities.mode = true; }
            else if (match = msgLower.match(/^(?:disable|turn off|deactivate) full assistant mode$/i)) { intent = 'SET_FULL_ASSISTANT_MODE'; entities.mode = false; }
            // Quote command
            else if (msgLower.match(/^(quote|tell me a quote|daily quote)$/i)) { intent = 'GET_QUOTE'; }
            // File attachment acknowledgement (basic)
            else if (userInput.startsWith('[Attached File:') || userInput.startsWith('User attached')) { intent = 'ACKNOWLEDGE_FILE'; entities.rawInput = userInput; }
            // Simulated Device Controls
            else if (match = msgLower.match(/^(?:turn on|activate)\s*(living room light|office fan|the lights|the fan|smart tv|tv|robot vacuum|vacuum cleaner)(?:\s*in the\s*(living room|office))?(?:\s*to channel\s*(.+))?$/i)) { intent = 'DEVICE_CONTROL'; entities.action = 'on'; entities.deviceGuess = match[1]; entities.area = match[2]; entities.channel = match[3];}
            else if (match = msgLower.match(/^(?:turn off|deactivate)\s*(living room light|office fan|the lights|the fan|smart tv|tv|robot vacuum|vacuum cleaner)(?:\s*in the\s*(living room|office))?$/i)) { intent = 'DEVICE_CONTROL'; entities.action = 'off'; entities.deviceGuess = match[1]; entities.area = match[2];}
            else if (match = msgLower.match(/^(lock|secure)\s*(main door|the door)$/i)) { intent = 'DEVICE_CONTROL'; entities.action = 'lock'; entities.deviceGuess = match[1]; }
            else if (match = msgLower.match(/^(unlock|open)\s*(main door|the door)$/i)) { intent = 'DEVICE_CONTROL'; entities.action = 'unlock'; entities.deviceGuess = match[1]; }
            else if (match = msgLower.match(/^(play music|play song|play)\s*(?:on music player|music player)?\s*(.+)?$/i)) { intent = 'MUSIC_CONTROL'; entities.musicAction = 'play'; entities.song = match[2] ? match[2].trim() : null; }
            else if (msgLower.match(/^(stop music|stop song|stop music player|stop robot vacuum|dock robot vacuum)$/i)) { intent = 'MUSIC_OR_VACUUM_STOP_DOCK_CONTROL'; entities.rawCommand = msgLower; }
            else if (msgLower.match(/^(pause music|pause song|pause music player)$/i)) { intent = 'MUSIC_CONTROL'; entities.musicAction = 'pause'; }
            else if (match = msgLower.match(/^set thermostat to (\d+)\s*(?:degrees|c|celsius)?$/i)) { intent = 'THERMOSTAT_CONTROL'; entities.temperature = match[1];}
            else if (msgLower.match(/^(system status|device status|environment report)$/i)) { intent = 'SYSTEM_STATUS_CMD'; }
            else if (msgLower.match(/^(system diagnostics|run diagnostics|check system)$/i)) { intent = 'SYSTEM_DIAGNOSTICS_CMD'; }
             // Simulated Communication Commands
            else if (msgLower.match(/^(check email|show new emails)$/i)) { intent = 'CHECK_EMAIL'; }
            else if (msgLower.match(/^(read last email|read latest email)$/i)) { intent = 'READ_LAST_EMAIL'; }
            else if (match = msgLower.match(/^send email to (.+?) subject (.+?) body (.+)$/i)) { intent = 'SEND_EMAIL'; entities.to = match[1].trim(); entities.subject = match[2].trim(); entities.body = match[3].trim(); }
            else if (msgLower.match(/^(check sms|check messages|show new messages)$/i)) { intent = 'CHECK_SMS'; }
            else if (match = msgLower.match(/^send sms to (.+?) message (.+)$/i)) { intent = 'SEND_SMS'; entities.to = match[1].trim(); entities.message = match[2].trim(); }
            else if (msgLower.match(/^(check whatsapp|show whatsapp messages)$/i)) { intent = 'CHECK_WHATSAPP'; }
            else if (match = msgLower.match(/^summarize (?:latest )?(email|sms|whatsapp|messages)(?: from (.+))?$/i)) { intent = 'SUMMARIZE_MESSAGES'; entities.app = match[1]; entities.from = match[2]; }
             // Simulated Call Commands
            else if (match = msgLower.match(/^call (.+)$/i)) { intent = 'START_CALL'; entities.contact = match[1].trim(); }
            else if (msgLower.match(/^(end call|hang up)$/i)) { intent = 'END_CALL'; }
            else if (msgLower.match(/^(answer call|accept call)$/i)) { intent = 'ANSWER_CALL'; }
            else if (msgLower.match(/^(call status|current call)$/i)) { intent = 'CALL_STATUS'; }
            // Code Generation
            else if (match = msgLower.match(/^generate code for (.+?) in (\w+)$/i)) { intent = 'GENERATE_CODE'; entities.description = match[1].trim(); entities.language = match[2].trim(); }
            // General & Utility Commands
            else if (msgLower.match(/^(what time is it|current time|time\??)$/i)) { intent = 'GET_TIME'; } else if (msgLower.match(/^(what's the date|current date|date\??)$/i)) { intent = 'GET_DATE'; } else if (msgLower.match(/^export chat$/i)) { intent = 'EXPORT_CHAT'; } else if (msgLower.match(/^clear all data$/i)) { intent = 'REQUEST_CLEAR_ALL_DATA'; } else if (botInternalState.awaitingConfirmation && botInternalState.awaitingConfirmation.type === 'clear_all_data' && msgLower === 'confirm clear all data') { intent = 'CONFIRM_CLEAR_ALL_DATA'; } else if (match = msgLower.match(/^calculate\s+(.+)$/i)) { intent = 'CALCULATE'; entities.expression = match[1].trim(); } else if (msgLower.match(/^(flip a coin|coin flip)$/i)) { intent = 'FLIP_COIN'; } else if (match = msgLower.match(/^pick a number between\s+(\d+)\s+and\s+(\d+)$/i)) { intent = 'PICK_NUMBER'; entities.min = match[1]; entities.max = match[2]; } else if (msgLower.match(/^(give me a journal prompt|journal prompt)$/i)) { intent = 'GET_JOURNAL_PROMPT'; } else if (match = msgLower.match(/^(weather in|weather for)\s*(.+)$/i)) { intent = 'GET_WEATHER'; entities.location = match[2].trim().replace(/\?$/, ''); } else if (msgLower.match(/^(hello|hi|hey|greetings)$/i)) { intent = 'GREETING'; } else if (msgLower.match(/^(thanks|thank you|ty)$/i)) { intent = 'THANKS'; } else if (match = msgLower.match(/^(my name is|call me)\s+(.+)$/i)) { intent = 'SET_USER_NAME'; entities.name = match[2].trim(); } else if (match = msgLower.match(/^(your name is|call yourself)\s+(.+)$/i)) { intent = 'SET_ASSISTANT_NAME'; entities.name = match[2].trim(); } else if (msgLower.match(/^(tell me a joke|joke)$/i)) { intent = 'TELL_JOKE'; } else if (msgLower.match(/^(tell me a fun fact|fun fact)$/i)) { intent = 'TELL_FUN_FACT'; } else if (msgLower.match(/^(about|about assistant|who are you)$/i)) { intent = 'ABOUT_ASSISTANT'; } else if (msgLower.match(/^(version|app version)$/i)) { intent = 'VERSION_INFO'; } else if (msgLower.match(/^(enable tts|turn on voice)$/i)) { intent = 'ENABLE_TTS'; } else if (msgLower.match(/^(disable tts|turn off voice)$/i)) { intent = 'DISABLE_TTS'; } else if (msgLower.match(/^(toggle tts|toggle voice)$/i)) { intent = 'TOGGLE_TTS'; } else if (msgLower.match(/^(start pomodoro|pomodoro start)$/i)) { intent = 'POMODORO_START'; } else if (msgLower.match(/^(pause pomodoro|pomodoro pause)$/i)) { intent = 'POMODORO_PAUSE'; } else if (msgLower.match(/^(reset pomodoro|pomodoro reset)$/i)) { intent = 'POMODORO_RESET'; } else if (msgLower.match(/^(skip pomodoro|pomodoro skip)$/i)) { intent = 'POMODORO_SKIP'; } else if (match = msgLower.match(/^pomodoro settings\s*work (\d+)\s*short (\d+)\s*long (\d+)\s*cycles (\d+)$/i)) { intent = 'POMODORO_SET_DURATIONS'; entities.work = match[1]; entities.short = match[2]; entities.long = match[3]; entities.cycles = match[4]; } else if (match = msgLower.match(/^(log mood|add mood)\s*(happy|sad|anxious|calm|productive|tired)?(?:\s*because\s*(.*))?$/i)) { intent = 'LOG_MOOD_QUICK'; entities.mood = match[2]; entities.notes = match[3]; } else if (msgLower.match(/^(log mood|add mood)$/i)) { intent = 'LOG_MOOD_INIT'; } else if (match = msgLower.match(/^(list moods|show moods|mood history)\s*(today|week|all)?$/i)) { intent = 'LIST_MOODS'; entities.period = match[2] || 'all'; } else if (match = msgLower.match(/^(remember that|save this about)\s+([^=]+?)\s*(?:is|=)\s*(.+)$/i)) { intent = 'MEMORY_REMEMBER'; entities.key = match[2].trim(); entities.value = match[3].trim(); } else if (match = msgLower.match(/^(what is|what's|recall|what about)\s+([^?]+)\??$/i)) { intent = 'MEMORY_RECALL'; entities.key = match[2].trim(); } else if (match = msgLower.match(/^(forget|delete memory of)\s+(.+)$/i)) { intent = 'MEMORY_FORGET'; entities.key = match[2].trim(); } else if (msgLower.match(/^(list memories|show memories)$/i)) { intent = 'MEMORY_LIST'; } else if (botInternalState.currentAction === 'awaiting_snippet_title') { intent = 'PROVIDE_SNIPPET_TITLE'; entities.title = userInput; } else if (botInternalState.currentAction === 'awaiting_snippet_language') { intent = 'PROVIDE_SNIPPET_LANGUAGE'; entities.language = userInput; } else if (botInternalState.currentAction === 'awaiting_snippet_code') { intent = 'PROVIDE_SNIPPET_CODE'; entities.code = userInput; } else if (msgLower.match(/^(add snippet|new snippet)$/i)) { intent = 'ADD_SNIPPET_INIT'; } else if (msgLower.match(/^(list snippets|show snippets)$/i)) { intent = 'LIST_SNIPPETS'; } else if (match = msgLower.match(/^(show snippet|view snippet)\s*(.+)$/i)) { intent = 'VIEW_SNIPPET'; entities.identifier = match[2].trim(); } else if (match = msgLower.match(/^(delete snippet|remove snippet)\s*(.+)$/i)) { intent = 'DELETE_SNIPPET_REQUEST'; entities.identifier = match[2].trim(); }
            else { intent = 'UNKNOWN'; }
        }

        switch (intent) {
            case 'OPEN_AURA_LIVE_MODE':
                if (!botInternalState.isLiveModeActive) {
                    botReply = `Acknowledged. Initiating ${appState.assistantName} Live Interface Protocol...`;
                    addBotMessage(botReply); 
                    startAuraLiveMode();
                } else {
                    botReply = "I'm already in Live Mode.";
                    addBotMessage(botReply); 
                }
                return; 
            case 'CANCEL_ACTION': case 'CONFIRMED_ACTION': case 'CANCELLED_CONFIRMATION': break; 
            case 'HELP': botReply = `I am **${appState.assistantName}** (v${APP_VERSION}). Key features:\n\n` + 
                "**Productivity & Planning**:\n" +
                "- Tasks: `add task`, `list tasks`, `complete task [id]`. Full manager via '+' icon.\n" +
                "- Planner: `plan [event] for [datetime]`, `show my plan for today`. Full planner via '+' icon.\n" +
                "- Reminders: `remind me to [action] by [time]`, `list reminders`.\n" +
                "- Notes: `add note [title]: [content]`, `list notes`.\n\n" +
                "**Communication (Simulated)**:\n" +
                "- Email/SMS/WhatsApp: `check email`, `send sms to [num] message [text]`, `summarize whatsapp`.\n" +
                "- Calls: `call [contact]`, `end call`, `call status`.\n\n" +
                "**Device Control (Simulated)**:\n" +
                "- Lights, Fan, TV, Thermostat, Vacuum: `turn on living room light`, `set thermostat to 22`.\n" +
                "- Music: `play music [song]`, `stop music`.\n" +
                "- Status: `system status`, `system diagnostics`.\n\n" +
                "**Tools & Utilities**:\n" +
                "- Code: `generate code for [desc] in [lang]`, Snippet Manager via '+' icon.\n" +
                "- Pomodoro Timer, Mood Logger: Access via '+' icon or commands like `start pomodoro`.\n" +
                "- `calculate [expr]`, `quote`, `weather in [city]`, `time`, `date`.\n\n" +
                "**Voice & Personalization**:\n" +
                "- **Aura Live Mode**: `Hey Aura, activate live mode`.\n" +
                "- Chat Mic: Use mic icon. `enable/disable tts`.\n" +
                "- Personalize: User icon or `my name is [name]`.\n" +
                "- `about`, `version`, `export chat`, `clear all data`.\n\n" +
                `Type 'cancel' if I'm waiting for info.`;
                botInternalState.currentAction = null; botInternalState.actionData = {}; 
                break;
            // Task Commands
            case 'PROVIDE_TASK_DESCRIPTION': botInternalState.actionData.description = entities.description; botInternalState.currentAction = 'awaiting_task_duedate'; botReply = `Got it: "${entities.description}". Due date? (e.g., 'tomorrow', or 'none')`; break;
            case 'PROVIDE_TASK_DUEDATE': botInternalState.actionData.dueDate = entities.dueDate; botInternalState.currentAction = 'awaiting_task_priority'; botReply = `Due date: ${entities.dueDate || 'None'}. Priority? (low, medium, high, or skip for medium)`; break;
            case 'PROVIDE_TASK_PRIORITY': botReply = Modules.Task.add(botInternalState.actionData.description, botInternalState.actionData.dueDate, entities.priority); botInternalState.currentAction = null; botInternalState.actionData = {}; break;
            case 'ADD_TASK_FULL': botReply = Modules.Task.add(entities.description, entities.dueDate, entities.priority); botInternalState.currentAction = null; botInternalState.actionData = {}; break;
            case 'ADD_TASK_INIT': botInternalState.currentAction = 'awaiting_task_description'; botInternalState.actionData = {}; botReply = "Okay, what's the task description?"; break;
            case 'LIST_TASKS': botReply = Modules.Task.list(); botInternalState.currentAction = null; botInternalState.actionData = {}; break;
            case 'COMPLETE_TASK': 
                const taskToComplete = Modules.Task.tasks.find(t => !t.completed && (t.description.toLowerCase().includes(entities.identifier.toLowerCase()) || t.id === entities.identifier || Modules.Task.tasks.filter(tsk => !tsk.completed).indexOf(t) + 1 == parseInt(entities.identifier) ));
                if (taskToComplete) {
                    Modules.Task.complete(taskToComplete.id, true);
                    botReply = `Marked task "${taskToComplete.description}" as complete.`;
                } else {
                    botReply = `Could not find active task matching "${entities.identifier}". Use the Task Manager or 'list tasks'.`;
                }
                break;
            case 'DELETE_TASK_REQUEST': botReply = Modules.Task.requestDelete(entities.identifier); break;
            case 'SET_TASK_PRIORITY': botReply = Modules.Task.setPriority(entities.identifier, entities.priority); break;
            
            case 'PROVIDE_REMINDER_TEXT': botInternalState.actionData.text = entities.text; botInternalState.currentAction = 'awaiting_reminder_time'; botReply = `Remind about "${entities.text}". When?`; break; case 'PROVIDE_REMINDER_TIME': botReply = Modules.Reminder.add(botInternalState.actionData.text, entities.time); botInternalState.currentAction = null; botInternalState.actionData = {}; break; case 'ADD_REMINDER_FULL_OR_PARTIAL': if (entities.time) { botReply = Modules.Reminder.add(entities.text, entities.time); } else { botInternalState.currentAction = 'awaiting_reminder_time'; botInternalState.actionData = { text: entities.text }; botReply = `Remind about "${entities.text}". When?`; } break; case 'ADD_REMINDER_INIT': botInternalState.currentAction = 'awaiting_reminder_text'; botInternalState.actionData = {}; botReply = "What to be reminded about?"; break; case 'LIST_REMINDERS': botReply = Modules.Reminder.list(); botInternalState.currentAction = null; botInternalState.actionData = {}; break; case 'DELETE_REMINDER_REQUEST': botReply = Modules.Reminder.requestDelete(entities.identifier); break; case 'PROVIDE_NOTE_TITLE': botInternalState.actionData.title = entities.title; botInternalState.currentAction = 'awaiting_note_content'; botReply = `Note title: "${entities.title}". Content?`; break; case 'PROVIDE_NOTE_CONTENT': botInternalState.actionData.content = entities.content; botInternalState.currentAction = 'awaiting_note_tags'; botReply = `Content saved. Tags? (comma-separated, or 'none')`; break; case 'PROVIDE_NOTE_TAGS': botReply = Modules.Note.add(botInternalState.actionData.title, botInternalState.actionData.content, (entities.tags.toLowerCase() === 'none' ? '' : entities.tags)); botInternalState.currentAction = null; botInternalState.actionData = {}; break; case 'ADD_NOTE_FULL': botReply = Modules.Note.add(entities.title, entities.content, entities.tags); botInternalState.currentAction = null; botInternalState.actionData = {}; break; case 'ADD_NOTE_INIT': botInternalState.currentAction = 'awaiting_note_title'; botInternalState.actionData = {}; botReply = "Title for note?"; break; case 'LIST_NOTES': botReply = Modules.Note.list(); botInternalState.currentAction = null; botInternalState.actionData = {}; break; case 'VIEW_NOTE': botReply = Modules.Note.view(entities.identifier); botInternalState.currentAction = null; botInternalState.actionData = {}; break; case 'DELETE_NOTE_REQUEST': botReply = Modules.Note.requestDelete(entities.identifier); break; case 'LIST_NOTES_BY_TAG': botReply = Modules.Note.listByTag(entities.tag); break; case 'ADD_TAG_TO_NOTE': botReply = Modules.Note.addTag(entities.identifier, entities.tag); break; case 'REMOVE_TAG_FROM_NOTE': botReply = Modules.Note.removeTag(entities.identifier, entities.tag); break;
            
            case 'ADD_PLANNER_EVENT': botReply = Modules.Planner.add(entities.name, entities.dateTime); break;
            case 'LIST_PLANNER_EVENTS': botReply = Modules.Planner.list(entities.period); break;
            case 'GET_NEXT_PLANNER_EVENT': botReply = Modules.Planner.getNext(); break;
            case 'DELETE_PLANNER_EVENT_REQUEST': botReply = Modules.Planner.requestDelete(entities.identifier); break;
            
            case 'ENABLE_REMINDER_NOTIFICATIONS': appState.reminderNotificationsEnabled = true; saveAppState(); applySettingsToUI(); requestNotificationPermission().then(granted => { /* Message handled by requestNotificationPermission */ }); botReply = "Attempting to enable reminder notifications..."; break;
            case 'DISABLE_REMINDER_NOTIFICATIONS': appState.reminderNotificationsEnabled = false; saveAppState(); applySettingsToUI(); botReply = "Reminder notifications DISABLED."; break;
            case 'SET_FULL_ASSISTANT_MODE': appState.fullAssistantMode = entities.mode; saveAppState(); applySettingsToUI(); botReply = `Full Assistant Mode ${entities.mode ? 'ENABLED' : 'DISABLED'} (Simulated).`; break;
            case 'ENABLE_AUTOREPLY': 
                if (appState.autoReplySettings[entities.app]) {
                    appState.autoReplySettings[entities.app].enabled = true;
                    if (entities.message) appState.autoReplySettings[entities.app].message = entities.message;
                    saveAppState();
                    botReply = `Auto-reply ENABLED for ${entities.app} with message: "${appState.autoReplySettings[entities.app].message}".`;
                } else { botReply = `Invalid application for auto-reply: ${entities.app}.`; }
                break;
            case 'DISABLE_AUTOREPLY':
                if (appState.autoReplySettings[entities.app]) {
                    appState.autoReplySettings[entities.app].enabled = false;
                    saveAppState();
                    botReply = `Auto-reply DISABLED for ${entities.app}.`;
                } else { botReply = `Invalid application for auto-reply: ${entities.app}.`; }
                break;

            case 'GET_QUOTE':
                try {
                    const response = await fetch("https://api.quotable.io/random");
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    botReply = `**Quote of the Day:**\n_"${data.content}"_\n- ${data.author}`;
                } catch (error) {
                    console.error("Quote API fetch error:", error);
                    botReply = "Sorry, I couldn't fetch a quote right now. Please try again later.";
                }
                break;
            case 'ACKNOWLEDGE_FILE':
                const fileInfoMatch = entities.rawInput.match(/\[Attached File: (.*?) \(/);
                const fileName = fileInfoMatch ? fileInfoMatch[1] : "the file";
                if (entities.rawInput.includes("File Content Preview:")) {
                     botReply = `Got the content of "${fileName}". How can I help with this?`;
                } else if (entities.rawInput.includes("<img src=")) {
                    botReply = `Image "${fileName}" noted. What should I do with this information?`;
                } else {
                    botReply = `File "${fileName}" noted. What should I do with this information?`;
                }
                break;
            case 'DEVICE_CONTROL':
                let deviceKey = null;
                const guess = entities.deviceGuess.toLowerCase();
                const area = entities.area ? entities.area.toLowerCase() : null;

                if (guess.includes("living room light") || (guess.includes("lights") && area === "living room")) deviceKey = "living_room_light";
                else if (guess.includes("office fan") || (guess.includes("fan") && area === "office")) deviceKey = "office_fan";
                else if (guess.includes("main door") || guess.includes("the door")) deviceKey = "main_door_lock";
                else if (guess.includes("smart tv") || (guess.includes("tv") && (area === "living room" || !area))) deviceKey = "smart_tv";
                else if (guess.includes("robot vacuum") || guess.includes("vacuum cleaner")) deviceKey = "robot_vacuum";

                if (deviceKey === "smart_tv") {
                     botReply = Modules.SimulatedDevices.controlSmartTV(entities.action, entities.channel);
                } else if (deviceKey === "robot_vacuum") {
                     botReply = Modules.SimulatedDevices.controlRobotVacuum(entities.action);
                } else if (deviceKey) {
                    botReply = Modules.SimulatedDevices.toggleDevice(deviceKey, entities.action);
                } else {
                    botReply = `Sorry, I couldn't identify the device "${entities.deviceGuess}" ${entities.area ? 'in '+entities.area : ''}. Try being more specific.`;
                }
                break;
            case 'MUSIC_CONTROL':
                botReply = Modules.SimulatedDevices.controlMusic(entities.musicAction, entities.song);
                break;
            case 'MUSIC_OR_VACUUM_STOP_DOCK_CONTROL':
                if (entities.rawCommand.includes("music")) {
                    botReply = Modules.SimulatedDevices.controlMusic("stop");
                } else if (entities.rawCommand.includes("vacuum")) {
                    botReply = Modules.SimulatedDevices.controlRobotVacuum("dock");
                } else {
                    botReply = currentPersonality.confusion();
                }
                break;
            case 'THERMOSTAT_CONTROL':
                botReply = Modules.SimulatedDevices.controlThermostat(entities.temperature);
                break;
            case 'SYSTEM_STATUS_CMD':
                botReply = Modules.SimulatedDevices.getStatus();
                break;
            case 'SYSTEM_DIAGNOSTICS_CMD':
                botReply = Modules.SimulatedDevices.getSystemDiagnostics();
                break;
            
            case 'CHECK_EMAIL': botReply = Modules.SimulatedComms.checkEmail(); break;
            case 'READ_LAST_EMAIL': botReply = Modules.SimulatedComms.readLastEmail(); break;
            case 'SEND_EMAIL': botReply = Modules.SimulatedComms.sendEmail(entities.to, entities.subject, entities.body); break;
            case 'CHECK_SMS': botReply = Modules.SimulatedComms.checkSms(); break;
            case 'SEND_SMS': botReply = Modules.SimulatedComms.sendSms(entities.to, entities.message); break;
            case 'CHECK_WHATSAPP': botReply = Modules.SimulatedComms.checkWhatsapp(); break;
            case 'SUMMARIZE_MESSAGES': 
                const appToSummarize = entities.app === 'messages' ? 'sms' : entities.app; // Treat 'messages' as 'sms'
                botReply = Modules.SimulatedComms.summarizeMessages(appToSummarize); 
                break;

            case 'START_CALL': botReply = Modules.SimulatedCalls.startCall(entities.contact); break;
            case 'END_CALL': botReply = Modules.SimulatedCalls.endCall(); break;
            case 'ANSWER_CALL': botReply = Modules.SimulatedCalls.answerCall(); break;
            case 'CALL_STATUS': botReply = Modules.SimulatedCalls.status(); break;

            case 'GENERATE_CODE':
                const lang = entities.language.toLowerCase();
                const desc = entities.description;
                let exampleCode = `// Simulated code for "${desc}" in ${lang}\n`;
                if (lang === "python") exampleCode += `def ${desc.replace(/\s+/g, '_')}():\n    print("Hello from ${desc}!")\n\n${desc.replace(/\s+/g, '_')}()`;
                else if (lang === "javascript") exampleCode += `function ${desc.replace(/\s+/g, '_')} () {\n  console.log("Hello from ${desc}!");\n}\n\n${desc.replace(/\s+/g, '_')}();`;
                else exampleCode += `// No specific template for ${lang}, using generic structure.`;
                botReply = `Okay, here's a basic **${lang}** structure for "**${desc}**":\n\`\`\`${lang}\n${exampleCode}\n\`\`\`\nThis is a simplified example.`;
                break;

            case 'GREETING': botReply = currentPersonality.greeting(); break; 
            case 'THANKS': botReply = currentPersonality.thanks(); break; 
            case 'CALCULATE': botReply = Modules.Utility.calculate(entities.expression); break; 
            case 'FLIP_COIN': botReply = Modules.Utility.flipCoin(); break; 
            case 'PICK_NUMBER': botReply = Modules.Utility.pickNumber(entities.min, entities.max); break; 
            case 'GET_JOURNAL_PROMPT': botReply = Modules.Utility.getJournalPrompt(); break; 
            case 'GET_TIME': botReply = `Current time: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}.`; break; 
            case 'GET_DATE': botReply = `Today: ${new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`; break; 
            case 'GET_WEATHER': 
                const weathers = ["Sunny, 25C.", "Cloudy, 18C.", "Partly cloudy, 22C.", "Rainy, 15C."]; 
                botReply = `Simulated weather in ${entities.location.charAt(0).toUpperCase() + entities.location.slice(1)}: ${weathers[Math.floor(Math.random() * weathers.length)]}`; 
                break; 
            case 'SET_USER_NAME': 
                const oldName = appState.userName; 
                appState.userName = entities.name; 
                saveAppState(); 
                updateInitialPrompt(); 
                botReply = oldName ? `Okay, ${appState.userName} it is (was ${oldName}).` : `Nice to meet you, ${appState.userName}!`; 
                break; 
            case 'SET_ASSISTANT_NAME': 
                appState.assistantName = entities.name; 
                assistantNameDisplay.textContent = appState.assistantName; 
                saveAppState(); 
                updateInitialPrompt(); 
                botReply = `Alright, call me ${appState.assistantName}!`; 
                break; 
            case 'REQUEST_CLEAR_ALL_DATA': 
                botReply = `**ALL DATA** (chat, tasks, etc.) will be cleared. This action cannot be undone. Type \`confirm clear all data\` to proceed.`; 
                botInternalState.awaitingConfirmation = {type: 'clear_all_data', description: 'all data'}; 
                break; 
            case 'CONFIRM_CLEAR_ALL_DATA': 
                handleClearAllData(true); 
                botReply = `Okay ${appState.userName || 'User'}, everything has been cleared.`; 
                botInternalState.awaitingConfirmation = null; 
                break; 
            case 'EXPORT_CHAT': 
                handleExportChat(); 
                botReply = "Chat log prepared for download."; 
                break; 
            case 'TELL_JOKE': 
                botReply = Modules.FunStuff.tellJoke(); 
                break; 
            case 'TELL_FUN_FACT': 
                botReply = Modules.FunStuff.tellFunFact(); 
                break; 
            case 'ABOUT_ASSISTANT': 
                botReply = `I am **${appState.assistantName}**, version ${APP_VERSION}. Type 'help' for a list of my capabilities.`; 
                break; 
            case 'VERSION_INFO': 
                botReply = `${appState.assistantName} - Version: ${APP_VERSION}.`; 
                break; 
            case 'ENABLE_TTS': 
                appState.ttsEnabled = true; 
                saveAppState(); 
                applySettingsToUI(); 
                botReply = `Voice output has been ENABLED.`; 
                addBotMessage(botReply); // Speak this confirmation
                return; // Return early as addBotMessage handles TTS
            case 'DISABLE_TTS': 
                appState.ttsEnabled = false; 
                saveAppState(); 
                applySettingsToUI(); 
                if (window.speechSynthesis && window.speechSynthesis.speaking) { 
                    window.speechSynthesis.cancel(); 
                } 
                botReply = `Voice output has been DISABLED.`; 
                addBotMessage(botReply); // Don't speak this one
                return; // Return early
            case 'TOGGLE_TTS': 
                appState.ttsEnabled = !appState.ttsEnabled; 
                saveAppState(); 
                applySettingsToUI(); 
                if (!appState.ttsEnabled && window.speechSynthesis && window.speechSynthesis.speaking) { 
                    window.speechSynthesis.cancel(); 
                } 
                botReply = `Voice output is now ${appState.ttsEnabled ? 'ENABLED' : 'DISABLED'}.`; 
                addBotMessage(botReply); // Speak if enabled
                return; // Return early
            case 'POMODORO_START': botReply = Modules.Pomodoro.start(); break; 
            case 'POMODORO_PAUSE': botReply = Modules.Pomodoro.pause(); break; 
            case 'POMODORO_RESET': botReply = Modules.Pomodoro.reset(); break; 
            case 'POMODORO_SKIP': botReply = Modules.Pomodoro.skip(); break; 
            case 'POMODORO_SET_DURATIONS': 
                botReply = Modules.Pomodoro.setDurations(entities.work, entities.short, entities.long, entities.cycles); 
                Modules.Pomodoro.reset(); 
                break; 
            case 'LOG_MOOD_QUICK': 
                if (entities.mood) { 
                    botReply = Modules.MoodJournal.add(entities.mood, entities.notes); 
                } else { 
                    if (!botInternalState.isLiveModeActive) openModal(moodLogModal); 
                    botReply = "Let's log your mood. You can tell me or use the mood logger tool."; 
                } 
                break; 
            case 'LOG_MOOD_INIT': 
                if (!botInternalState.isLiveModeActive) openModal(moodLogModal); 
                botReply = "Opening mood logger."; 
                break; 
            case 'LIST_MOODS': 
                botReply = Modules.MoodJournal.list(entities.period); 
                break; 
            case 'MEMORY_REMEMBER': 
                botReply = Modules.Memory.remember(entities.key, entities.value); 
                break; 
            case 'MEMORY_RECALL': 
                botReply = Modules.Memory.recall(entities.key); 
                break; 
            case 'MEMORY_FORGET': 
                botReply = Modules.Memory.forget(entities.key); 
                break; 
            case 'MEMORY_LIST': 
                botReply = Modules.Memory.list(); 
                break; 
            case 'PROVIDE_SNIPPET_TITLE': 
                botInternalState.actionData.title = entities.title; 
                botInternalState.currentAction = 'awaiting_snippet_language'; 
                botReply = `Snippet title: "${entities.title}". Language? (e.g., javascript, or 'none')`; 
                break; 
            case 'PROVIDE_SNIPPET_LANGUAGE': 
                botInternalState.actionData.language = (entities.language.toLowerCase() === 'none' || entities.language.trim() === '') ? '' : entities.language; 
                botInternalState.currentAction = 'awaiting_snippet_code'; 
                botReply = `Language: ${botInternalState.actionData.language || 'N/A'}. Code?`; 
                break; 
            case 'PROVIDE_SNIPPET_CODE': 
                botReply = Modules.CodeSnippets.add(botInternalState.actionData.title, botInternalState.actionData.language, entities.code); 
                botInternalState.currentAction = null; 
                botInternalState.actionData = {}; 
                break; 
            case 'ADD_SNIPPET_INIT': 
                if(!botInternalState.isLiveModeActive) {
                    openModal(codeSnippetModal); 
                    Modules.CodeSnippets.resetForm(); 
                    codeSnippetFormArea.classList.remove('hidden'); 
                    viewSnippetArea.classList.add('hidden'); 
                    showSnippetFormBtn.classList.add('hidden');
                } 
                botReply = "Opened Code Snippet Manager. You can also tell me the title, language, and code directly."; 
                break; 
            case 'LIST_SNIPPETS': 
                botReply = Modules.CodeSnippets.list(); 
                break; 
            case 'VIEW_SNIPPET': 
                botReply = Modules.CodeSnippets.view(entities.identifier); 
                break; 
            case 'DELETE_SNIPPET_REQUEST': 
                botReply = Modules.CodeSnippets.requestDelete(entities.identifier); 
                break;
            default: 
                if (botInternalState.awaitingConfirmation && botInternalState.awaitingConfirmation.type !== 'clear_all_data') {  
                    botReply = `Please respond with "yes" or "no" to confirm ${botInternalState.awaitingConfirmation.type.replace('_', ' ')} for "${botInternalState.awaitingConfirmation.description}". You can also say "cancel".`; 
                } 
                else if (botInternalState.awaitingConfirmation && botInternalState.awaitingConfirmation.type === 'clear_all_data') { 
                    botReply = `To confirm clearing all data, please type exactly: \`confirm clear all data\`. Otherwise, type 'cancel'.`; 
                }
                else { 
                    botReply = currentPersonality.confusion(); 
                    // Simple check for "full assistant mode" and common unrecognized phrases
                    if (appState.fullAssistantMode && (msgLower.includes("good morning") || msgLower.includes("how are you"))) {
                         botReply = `${currentPersonality.greeting()} Is there anything specific I can do for you right now?`;
                    } else if (appState.fullAssistantMode && msgLower.length > 15) { // Longer unrecognized phrases
                        botReply = `I'm not sure how to handle that complex request, ${appState.userName || 'Sir/Madam'}. Could you break it down or try a known command?`;
                    }
                }
        }

        if (botInternalState.isLiveModeActive) {
            addBotMessage(botReply); 
        } else {
            setTimeout(() => {
                hideTyping();
                addBotMessage(botReply); 
            }, delay);
        }
    }

    // --- Modal Management ---
    function openModal(modalElement) { 
        if(modalElement) {
            // Close any other open modals first
            document.querySelectorAll('.modal-overlay.visible').forEach(openModal => {
                if (openModal !== modalElement) closeModal(openModal);
            });
            modalElement.classList.add('visible'); 
        }
        if (modalElement === pomodoroModal) Modules.Pomodoro.updateDisplay(); 
        if (modalElement === codeSnippetModal) { Modules.CodeSnippets.renderList(); Modules.CodeSnippets.resetForm(); viewSnippetArea.classList.add('hidden'); codeSnippetFormArea.classList.remove('hidden'); showSnippetFormBtn.classList.add('hidden');} 
        if (modalElement === taskManagerModal) { Modules.Task.renderListInModal(); addTaskFormInModal.classList.add('hidden'); toggleAddTaskFormInModalBtn.textContent = "Add New Task"; }
        if (modalElement === plannerModal) { Modules.Planner.renderEntriesInModal(); addPlannerEntryForm.classList.add('hidden'); toggleAddPlannerEntryFormBtn.textContent = "Add New Event"; }
        if (modalElement === topicsModal) { Modules.SimulatedDevices.renderControlsInModal(); }
    }
    function closeModal(modalElement) { if(modalElement) modalElement.classList.remove('visible'); if (modalElement === pomodoroModal && pomodoroSettingsArea && !pomodoroSettingsArea.classList.contains('hidden')) { pomodoroSettingsArea.classList.add('hidden'); }}
    document.querySelectorAll('.modal-close-btn').forEach(btn => { btn.addEventListener('click', () => { const modalId = btn.dataset.modalId; if (modalId) closeModal(document.getElementById(modalId)); }); });
    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) { // Only if clicking the overlay itself, not its content
                closeModal(overlay);
            }
        });
    });


    // --- Event Handlers ---
    function setupEventListeners() {
        sendBtn.addEventListener('click', handleSendMessage);
        userInputEditable.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        themeToggleBtn.addEventListener('click', toggleTheme);
        personalizeBtn.addEventListener('click', () => { userNameInput.value = appState.userName; assistantNameInput.value = appState.assistantName; openModal(personalizationModal); });
        savePersonalizationBtn.addEventListener('click', () => { appState.userName = userNameInput.value.trim(); appState.assistantName = assistantNameInput.value.trim() || 'Aura Intelligence'; assistantNameDisplay.textContent = appState.assistantName; appState.isPersonalized = true; saveAppState(); updateInitialPrompt(); closeModal(personalizationModal); addBotMessage(`Personalization saved! Hello ${appState.userName || 'there'}, I'm ${appState.assistantName}.`, true);});
        settingsBtn.addEventListener('click', () => openModal(settingsModal));
        showTimestampsSetting.addEventListener('change', () => { appState.showTimestamps = showTimestampsSetting.checked; saveAppState(); applySettingsToUI(); chatLog.querySelectorAll('.message-meta').forEach(m => m.style.display = appState.showTimestamps ? 'block' : 'none'); addBotMessage(`Timestamps ${appState.showTimestamps ? 'shown' : 'hidden'}.`, true); });
        showTypingIndicatorSetting.addEventListener('change', () => { appState.showTypingIndicator = showTypingIndicatorSetting.checked; saveAppState(); if (!appState.showTypingIndicator) typingIndicator.classList.add('hidden'); addBotMessage(`Bot typing indicator ${appState.showTypingIndicator ? 'enabled' : 'disabled'}.`, true);});
        enableTtsSetting.addEventListener('change', () => { 
            const wasEnabled = appState.ttsEnabled;
            appState.ttsEnabled = enableTtsSetting.checked; 
            saveAppState(); 
            if (!appState.ttsEnabled && window.speechSynthesis && window.speechSynthesis.speaking) { 
                window.speechSynthesis.cancel(); 
            } 
            const statusMessage = `Voice output ${appState.ttsEnabled ? 'ENABLED' : 'DISABLED'}.`;
            addBotMessage(statusMessage, true); 
        });
        enableReminderNotificationsSetting.addEventListener('change', async () => { appState.reminderNotificationsEnabled = enableReminderNotificationsSetting.checked; saveAppState(); if (appState.reminderNotificationsEnabled) { const permissionGranted = await requestNotificationPermission(); if (!permissionGranted) { appState.reminderNotificationsEnabled = false; enableReminderNotificationsSetting.checked = false; saveAppState(); }} else { addBotMessage("Reminder notifications DISABLED.", true); }});
        botPersonalitySetting.addEventListener('change', () => { appState.botPersonality = botPersonalitySetting.value; saveAppState(); addBotMessage(`Personality set to '${botPersonalitySetting.options[botPersonalitySetting.selectedIndex].text}'.`, true); });
        fullAssistantModeSetting.addEventListener('change', () => { appState.fullAssistantMode = fullAssistantModeSetting.checked; saveAppState(); addBotMessage(`Full Assistant Mode (Simulated) ${appState.fullAssistantMode ? 'ENABLED' : 'DISABLED'}.`, true); });
        exportChatBtn.addEventListener('click', () => { handleExportChat(); closeModal(settingsModal); });
        clearChatBtn.addEventListener('click', () => { getBotResponse('clear all data'); });
        
        chatSearchInput.addEventListener('input', (e) => performChatSearch(e.target.value));
        clearChatSearchBtn.addEventListener('click', () => { chatSearchInput.value = ''; performChatSearch(''); });

        topicsBtn.addEventListener('click', () => openModal(topicsModal));
        if(triggerFileAttachmentModalAction) { 
            triggerFileAttachmentModalAction.addEventListener('click', () => {
                closeModal(topicsModal);
                fileInput.click(); 
            });
        }
        topicsListContainer.addEventListener('click', (e) => { 
            const targetButton = e.target.closest('button.action-button, button[data-topic]'); 
            if (targetButton) {
                 if (targetButton.dataset.topic) { 
                    const topic = targetButton.dataset.topic; 
                    userInputEditable.textContent = topic; 
                    handleSendMessage(); 
                    closeModal(topicsModal); 
                } else if (targetButton.dataset.action) { 
                    const action = targetButton.dataset.action; 
                    if (action === "openPomodoroModal") openModal(pomodoroModal); 
                    else if (action === "openMoodLogModal") openModal(moodLogModal); 
                    else if (action === "openCodeSnippetModal") openModal(codeSnippetModal); 
                    else if (action === "openTaskManagerModal") openModal(taskManagerModal); 
                    else if (action === "openPlannerModal") openModal(plannerModal);
                    closeModal(topicsModal); 
                } else if (targetButton.dataset.deviceId && simulatedDevicesContainer.contains(targetButton)) {
                    // This click is handled directly by SimulatedDevices.renderControlsInModal's event listener
                }
            }
        });
        initialSuggestionsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('suggestion-chip') && e.target.dataset.suggestion) { const suggestion = e.target.dataset.suggestion; userInputEditable.textContent = suggestion; handleSendMessage(); } });
        
        micBtn.addEventListener('click', () => { 
            if (botInternalState.isLiveModeActive) return; 
            if (!speechRecognition) {
                addBotMessage("Voice input is not supported or enabled in your browser.", true);
                return;
            }
            if (botInternalState.isListening) {
                speechRecognition.stop();
            } else {
                try {
                    speechRecognition.start();
                } catch (err) {
                    console.error("Error starting speech recognition:", err);
                    addBotMessage("Could not start voice input. Check microphone permissions.", true);
                     botInternalState.isListening = false;
                     micBtn.classList.remove('listening');
                     if (dynamicOrbElement) dynamicOrbElement.classList.remove('orb-listening');
                     botInternalState.isEdgeGlowNeededByMic = false;
                     updateEdgeGlow();
                }
            }
        });

        attachBtn.addEventListener('click', () => { fileInput.click(); }); 
        fileInput.addEventListener('change', handleFileSelected); 

        scrollToTopBtn.addEventListener('click', () => scrollToTop()); scrollToBottomBtn.addEventListener('click', () => scrollToBottom()); chatWindow.addEventListener('scroll', updateScrollButtonsVisibility);
        document.addEventListener('keydown', (e) => { 
            if (e.key === "Escape") { 
                if (botInternalState.isLiveModeActive) {
                    stopAuraLiveMode();
                } else {
                    [personalizationModal, settingsModal, topicsModal, pomodoroModal, moodLogModal, codeSnippetModal, taskManagerModal, plannerModal].forEach(m => { if (m && m.classList.contains('visible')) closeModal(m); });
                }
            }
        });
        
        // Task Manager Modal Event Listeners
        toggleAddTaskFormInModalBtn.addEventListener('click', () => {
            addTaskFormInModal.classList.toggle('hidden');
            toggleAddTaskFormInModalBtn.textContent = addTaskFormInModal.classList.contains('hidden') ? "Add New Task" : "Cancel Add Task";
            if (!addTaskFormInModal.classList.contains('hidden')) {
                newTaskDescModalInput.value = '';
                newTaskDueDateModalInput.value = '';
                newTaskPriorityModalSelect.value = 'medium';
                newTaskDescModalInput.focus();
            }
        });
        saveNewTaskFromModalBtn.addEventListener('click', () => {
            const desc = newTaskDescModalInput.value.trim();
            const dueDate = newTaskDueDateModalInput.value.trim() || null;
            const priority = newTaskPriorityModalSelect.value;
            if (!desc) {
                addBotMessage(`${appState.assistantName} Info: Task description cannot be empty.`, true); 
                return;
            }
            addBotMessage(Modules.Task.add(desc, dueDate, priority), true);
            newTaskDescModalInput.value = '';
            newTaskDueDateModalInput.value = '';
            addTaskFormInModal.classList.add('hidden');
            toggleAddTaskFormInModalBtn.textContent = "Add New Task";
        });

        // Planner Modal Event Listeners
        toggleAddPlannerEntryFormBtn.addEventListener('click', () => {
            addPlannerEntryForm.classList.toggle('hidden');
            toggleAddPlannerEntryFormBtn.textContent = addPlannerEntryForm.classList.contains('hidden') ? "Add New Event" : "Cancel";
            if (!addPlannerEntryForm.classList.contains('hidden')) {
                newEventNameModalInput.value = '';
                newEventDateTimeModalInput.value = '';
                newEventNotesModalInput.value = '';
                newEventNameModalInput.focus();
            }
        });
        saveNewPlannerEntryBtn.addEventListener('click', () => {
            const name = newEventNameModalInput.value.trim();
            const dateTime = newEventDateTimeModalInput.value;
            const notes = newEventNotesModalInput.value.trim();
            if (!name || !dateTime) {
                addBotMessage(`${appState.assistantName} Info: Event name and date/time are required for planner.`, true);
                return;
            }
            addBotMessage(Modules.Planner.add(name, dateTime, notes), true);
            addPlannerEntryForm.classList.add('hidden');
            toggleAddPlannerEntryFormBtn.textContent = "Add New Event";
        });


        pomodoroStartPauseBtn.addEventListener('click', () => { if (Modules.Pomodoro.state.isRunning) addBotMessage(Modules.Pomodoro.pause(), true); else addBotMessage(Modules.Pomodoro.start(), true); }); pomodoroResetBtn.addEventListener('click', () => addBotMessage(Modules.Pomodoro.reset(), true)); pomodoroSkipBtn.addEventListener('click', () => addBotMessage(Modules.Pomodoro.skip(), true)); pomodoroToggleSettingsBtn.addEventListener('click', () => { pomodoroSettingsArea.classList.toggle('hidden'); pomodoroWorkDurationInput.value = Modules.Pomodoro.settings.workDuration; pomodoroShortBreakDurationInput.value = Modules.Pomodoro.settings.shortBreakDuration; pomodoroLongBreakDurationInput.value = Modules.Pomodoro.settings.longBreakDuration; pomodoroCyclesInput.value = Modules.Pomodoro.settings.cycles; }); pomodoroSaveSettingsBtn.addEventListener('click', () => { addBotMessage(Modules.Pomodoro.setDurations( pomodoroWorkDurationInput.value, pomodoroShortBreakDurationInput.value, pomodoroLongBreakDurationInput.value, pomodoroCyclesInput.value ), true); Modules.Pomodoro.reset(); pomodoroSettingsArea.classList.add('hidden'); });
        saveMoodLogBtn.addEventListener('click', () => { const selectedMood = moodLogOptionsContainer.querySelector('input[name="mood"]:checked'); if (!selectedMood) { addBotMessage("Please select a mood.", true); return; } const mood = selectedMood.value; const notes = moodLogNotesInput.value.trim(); addBotMessage(Modules.MoodJournal.add(mood, notes), true); closeModal(moodLogModal); moodLogNotesInput.value = ''; if(selectedMood) selectedMood.checked = false; });
        saveSnippetBtn.addEventListener('click', () => { const id = snippetIdInput.value; const title = snippetTitleInput.value.trim(); const language = snippetLanguageInput.value.trim(); const code = snippetCodeInput.value.trim(); if (!title || !code) { addBotMessage("Snippet title and code cannot be empty.", true); return; } let result; if (id) { result = Modules.CodeSnippets.update(id, title, language, code); } else { result = Modules.CodeSnippets.add(title, language, code); } addBotMessage(result, true); Modules.CodeSnippets.resetForm(); }); showSnippetFormBtn.addEventListener('click', () => { Modules.CodeSnippets.resetForm(); codeSnippetFormArea.classList.remove('hidden'); viewSnippetArea.classList.add('hidden'); showSnippetFormBtn.classList.add('hidden'); }); cancelEditSnippetBtn.addEventListener('click', () => { Modules.CodeSnippets.resetForm(); viewSnippetArea.classList.add('hidden'); codeSnippetFormArea.classList.remove('hidden'); }); backToSnippetsListBtn.addEventListener('click', () => { viewSnippetArea.classList.add('hidden'); codeSnippetFormArea.classList.add('hidden'); showSnippetFormBtn.classList.remove('hidden'); Modules.CodeSnippets.renderList(); }); copySnippetBtn.addEventListener('click', () => { navigator.clipboard.writeText(viewSnippetCode.textContent) .then(() => addBotMessage("Snippet code copied!", true)) .catch(err => addBotMessage("Failed to copy: " + err, true)); }); editViewedSnippetBtn.addEventListener('click', () => { const currentId = viewSnippetArea.dataset.currentId; if (currentId) Modules.CodeSnippets.showFormForEdit(currentId); });

        // Aura Live Mode Event Listeners
        closeLiveModeBtnIntegrated.addEventListener('click', stopAuraLiveMode);
        window.addEventListener('resize', () => {
            if (botInternalState.isLiveModeActive) {
                setupLiveModeCanvas();
            }
        });
    }

    // --- Chat History Management ---
    function handleClearAllData(confirmed = false) { 
        if (!confirmed) { getBotResponse('clear all data'); return; } 
        chatHistory = []; 
        Modules.Task.clearAll(); 
        Modules.Reminder.clearAll(); 
        Modules.Note.clearAll(); 
        Modules.Planner.clearAll();
        Modules.Pomodoro.init(null); 
        Modules.Pomodoro.saveSettings(); 
        Modules.MoodJournal.clearAll(); 
        Modules.Memory.clearAll(); 
        Modules.CodeSnippets.clearAll(); 
        Modules.SimulatedDevices.devices = { 
            "living_room_light": { name: "Living Room Light", state: false, type: "toggle", area: "living room" },
            "office_fan": { name: "Office Fan", state: false, type: "toggle", area: "office" },
            "music_player": { name: "Music Player", state: "stopped", song: null, type: "media", area: "system" },
            "main_door_lock": { name: "Main Door Lock", state: true, type: "toggle", area: "security" },
            "thermostat": { name: "Thermostat", state: { current: 20, target: 20, mode: "off" }, type: "thermo", area: "hvac"},
            "smart_tv": { name: "Smart TV", state: "off", channel: null, type: "media_device", area: "living room" },
            "robot_vacuum": { name: "Robot Vacuum", state: "docked", type: "appliance", area: "house" }
        };
        Modules.SimulatedDevices.save(); 
        saveData(KEYS.CHAT_HISTORY, chatHistory); 
        chatLog.innerHTML = ''; 
        initialPromptArea.classList.remove('hidden'); 
        updateInitialPrompt(); 
        if(window.speechSynthesis && window.speechSynthesis.speaking) window.speechSynthesis.cancel(); 
    }
    function handleExportChat() { let chatText = `Chat Export from ${appState.assistantName} (v${APP_VERSION})\nExported: ${new Date().toLocaleString()}\n\n`; chatHistory.forEach(msg => { const senderName = msg.sender === 'user' ? (appState.userName || 'User') : appState.assistantName; const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); chatText += `[${time}] ${senderName}: ${msg.text}\n`; }); const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${appState.assistantName}_chat_export_${new Date().toISOString().split('T')[0]}.txt`; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    function scrollToBottom(behavior = 'smooth') { requestAnimationFrame(() => chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior })); }
    function scrollToTop(behavior = 'smooth') { requestAnimationFrame(() => chatWindow.scrollTo({ top: 0, behavior })); }
    function updateScrollButtonsVisibility() { const isScrollable = chatWindow.scrollHeight > chatWindow.clientHeight; const atBottom = chatWindow.scrollTop + chatWindow.clientHeight >= chatWindow.scrollHeight - 50; const atTop = chatWindow.scrollTop < 50; scrollToBottomBtn.classList.toggle('visible', isScrollable && !atBottom); scrollToTopBtn.classList.toggle('visible', isScrollable && !atTop); }
    
    initApp(); 
});
</script>
</body>
</html>